import streamlit as st
import pandas as pd
import base64
import os
import datetime
import requests
import math 
import re 
import json
from io import BytesIO
from PIL import Image, ImageFile
import streamlit.components.v1 as components
from xhtml2pdf import pisa 
import gspread
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload
import numpy as np

# --- CRITICAL FIX FOR BROKEN IMAGES ---
ImageFile.LOAD_TRUNCATED_IMAGES = True

# ==========================================
# 1. SETUP & CONFIGURATION
# ==========================================
st.set_page_config(page_title="Vesak Care Invoice", layout="wide", page_icon="üè•")

LOGO_FILE = "logo.png"
URL_CONFIG_FILE = "url_config.txt"
SYSTEM_CONFIG_FILE = "system_config.json" 

# --- HEADERS (34 COLUMNS) ---
SHEET_HEADERS = [
    "UID", "Serial No.", "Ref. No.", "Invoice Number", "Date", "Generated At",
    "Customer Name", "Age", "Gender", "Location", "Address", "Mobile",
    "Plan", "Shift", "Recurring Service", "Period", "Visits", "Amount",
    "Notes / Remarks", "Generated By", "Amount Paid", "Details",
    "Service Started", "Service Ended", "Referral Code", "Referral Name",
    "Referral Credit", "Net Amount", "Nurse Payment", "Paid for", "Earnings",
    "Nurse Name", "Nurse Name (Extra)", "Nurse Note" 
]

# --- SESSION STATE INITIALIZATION ---
if 'chk_overwrite' not in st.session_state: st.session_state.chk_overwrite = False
if 'last_formula_injected' not in st.session_state: st.session_state.last_formula_injected = ""

# --- CONFIGURATION LOADER ---
def load_system_config():
    default_config = {
        "master_sheet_url": "",
        "backup_sheet_url": "",
        "folder_agreements": "",
        "folder_invoices": ""
    }
    if os.path.exists(SYSTEM_CONFIG_FILE):
        try:
            with open(SYSTEM_CONFIG_FILE, "r") as f:
                return json.load(f)
        except: return default_config
    return default_config

def save_system_config(config_data):
    with open(SYSTEM_CONFIG_FILE, "w") as f:
        json.dump(config_data, f)

# --- MISSING FUNCTIONS RESTORED (CRITICAL FIX) ---
def load_config_path(file_name):
    if os.path.exists(file_name):
        with open(file_name, "r") as f: return f.read().strip()
    return ""

def save_config_path(path, file_name):
    with open(file_name, "w") as f: f.write(path.replace('"', '').strip())
    return path

def extract_id_from_url(url):
    if not url: return ""
    match = re.search(r"/d/([a-zA-Z0-9-_]+)", url)
    if match: return match.group(1)
    match_folder = re.search(r"/folders/([a-zA-Z0-9-_]+)", url)
    if match_folder: return match_folder.group(1)
    if len(url) > 20 and "/" not in url: return url
    return ""

sys_config = load_system_config()

# --- GOOGLE AUTHENTICATION ---
@st.cache_resource
def get_credentials():
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        s_info = st.secrets["connections"]["gsheets"]
        private_key = s_info.get("private_key").replace("\\n", "\n")
        creds_dict = {
            "type": s_info.get("type"),
            "project_id": s_info.get("project_id"),
            "private_key_id": s_info.get("private_key_id"),
            "private_key": private_key,
            "client_email": s_info.get("client_email"),
            "client_id": s_info.get("client_id"),
            "auth_uri": s_info.get("auth_uri"),
            "token_uri": s_info.get("token_uri"),
            "auth_provider_x509_cert_url": s_info.get("auth_provider_x509_cert_url"),
            "client_x509_cert_url": s_info.get("client_x509_cert_url"),
        }
        return Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return None

@st.cache_resource
def get_drive_service():
    creds = get_credentials()
    if creds: return build('drive', 'v3', credentials=creds)
    return None

def get_gspread_client():
    creds = get_credentials()
    if creds: return gspread.authorize(creds)
    return None

# ==========================================
# FILE HANDLING & HELPERS
# ==========================================

# [FIXED] ROBUST DOWNLOADER V3 - SESSION BASED
@st.cache_data(show_spinner=False)
def robust_file_downloader(url):
    """
    Downloads file using a session to persist cookies through redirects.
    This fixes 403 errors on public OneDrive links.
    """
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Accept-Language': 'en-US,en;q=0.5',
        'Referer': 'https://www.google.com/'
    })

    download_url = url
    
    # 1. Clean the URL (Remove existing parameters)
    if "?" in url:
        base_url = url.split("?")[0]
    else:
        base_url = url

    # 2. Append download command
    if "1drv.ms" in url or "sharepoint" in url or "onedrive" in url:
        download_url = base_url + "?download=1"
    
    try:
        # Attempt download
        response = session.get(download_url, verify=False, allow_redirects=True)
        
        # Check if successful
        if response.status_code == 200:
            # Verify we got a file (Excel/CSV usually) and not a HTML login page
            content_type = response.headers.get('Content-Type', '').lower()
            if 'text/html' in content_type and len(response.content) < 5000:
                # If we got a small HTML page, it might be a login redirect.
                # Try the original URL without modification as a last resort
                response = session.get(url, verify=False, allow_redirects=True)
            
            return BytesIO(response.content)
            
        raise Exception(f"Status Code: {response.status_code}")
        
    except Exception as e:
        # Just return None instead of crashing, let the UI handle it
        return None

def format_date_with_suffix(d):
    if pd.isna(d): return "N/A"
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        day = d.day
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(day % 10, "th") if not 10 < day < 14 else "th"
        return d.strftime(f"%b. {day}{suffix} %Y")
    except: return str(d)

def clean_text(text): return str(text).strip() if isinstance(text, str) else str(text)

def generate_filename(doc_type, invoice_no, customer_name):
    prefix = {"Invoice": "IN", "Nurse": "NU", "Patient": "PA"}.get(doc_type, "DOC")
    clean_name = re.sub(r'[^a-zA-Z0-9]', '-', str(customer_name)).upper().strip('-')
    return f"{prefix}-{invoice_no}-{clean_name}.pdf"

# --- HELPER FUNCTIONS FOR LISTS ---
def get_base_lists(selected_plan, selected_sub_service):
    # Defining Master List inside function
    SERVICES_MASTER = {
        "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
        "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
        "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
        "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
        "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
        "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
        "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
    }
    STANDARD_PLANS = list(SERVICES_MASTER.keys())[:5]
    
    master_list = SERVICES_MASTER.get(selected_plan, [])
    if "All" in str(selected_sub_service) and selected_plan in STANDARD_PLANS:
        included_raw = [s for s in master_list if s.lower() != "all"]
    else: included_raw = [x.strip() for x in str(selected_sub_service).split(',')]
    included_clean = sorted(list(set([clean_text(s) for s in included_raw if clean_text(s)])))
    not_included_clean = []
    if selected_plan in STANDARD_PLANS:
        for plan_name in STANDARD_PLANS:
            if plan_name == selected_plan: continue 
            for item in SERVICES_MASTER.get(plan_name, []):
                if item.lower() == "all": continue
                cleaned = clean_text(item)
                if cleaned: not_included_clean.append(cleaned)
    else:
        for item in master_list:
            cleaned = clean_text(item)
            if cleaned and cleaned not in included_clean: not_included_clean.append(cleaned)
    return included_clean, list(set(not_included_clean))

def convert_html_to_pdf(source_html):
    result = BytesIO()
    pisa_status = pisa.CreatePDF(source_html, dest=result)
    if pisa_status.err: return None
    return result.getvalue()

def normalize_columns(df, aliases):
    df.columns = df.columns.astype(str).str.strip()
    for standard_name, possible_aliases in aliases.items():
        if standard_name in df.columns: continue 
        for alias in possible_aliases:
            for df_col in df.columns:
                if df_col.lower() == alias.lower():
                    df.rename(columns={df_col: standard_name}, inplace=True); break 
    return df

COLUMN_ALIASES = {
    'Serial No.': ['Serial No.', 'serial no', 'sr no', 'sr. no.', 'id'],
    'Ref. No.': ['Ref. No.', 'ref no', 'ref. no.', 'reference no', 'reference number'],
    'Name': ['Name', 'name', 'patient name', 'client name'],
    'Mobile': ['Mobile', 'mobile', 'phone', 'contact'],
    'Location': ['Location', 'location', 'city'], 
    'Address': ['Address', 'address', 'residence'],
    'Gender': ['Gender', 'gender', 'sex'],
    'Age': ['Age', 'age'],
    'Service Required': ['Service Required', 'service required', 'plan'],
    'Sub Service': ['Sub Service', 'sub service', 'sub plan'],
    'Final Rate': ['Final Rate', 'final rate', 'amount', 'total amount'],
    'Unit Rate': ['Rate Agreed (‚Çπ)', 'rate agreed', 'unit rate', 'per day rate'],
    'Call Date': ['Call Date', 'call date'],
    'Notes': ['Notes / Remarks', 'notes'],
    'Shift': ['Shift', 'shift'],
    'Recurring': ['Recurring Service', 'recurring'],
    'Period': ['Period', 'period'],
    'Visits': ['Vists', 'visits', 'visit'],
    'Referral Code': ['Referral Code', 'referral code', 'ref code'],
    'Referral Name': ['Referral Name', 'referral name', 'ref name'],
    'Referral Credit': ['Referral Credit', 'referral credit', 'ref credit']
}

# --- DATABASE HELPERS ---
def save_invoice_to_gsheet(data_dict, sheet_obj):
    if sheet_obj is None: return False
    try:
        all_vals = sheet_obj.get_all_values()
        next_row_num = len(all_vals) + 1
        formula_net_amount = f"=U{next_row_num}-AA{next_row_num}"
        formula_earnings = f"=AB{next_row_num}-(AC{next_row_num}*AD{next_row_num})"
        details_txt = data_dict.get("Details", "")
        qty_extracted = 1
        match = re.search(r'Paid for (\d+)', details_txt)
        if match: qty_extracted = int(match.group(1))
        row_values = [
            data_dict.get("UID", ""), data_dict.get("Serial No.", ""), data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""), data_dict.get("Date", ""), data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""), data_dict.get("Age", ""), data_dict.get("Gender", ""),
            data_dict.get("Location", ""), data_dict.get("Address", ""), data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""), data_dict.get("Shift", ""), data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""), data_dict.get("Visits", ""), data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""), data_dict.get("Generated By", ""), data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""), data_dict.get("Service Started", ""), data_dict.get("Service Ended", ""),
            data_dict.get("Referral Code", ""), data_dict.get("Referral Name", ""), data_dict.get("Referral Credit", ""),
            formula_net_amount, "", qty_extracted, formula_earnings,
            "", "", "" 
        ]
        sheet_obj.append_row(row_values, value_input_option='USER_ENTERED')
        return True
    except Exception as e: st.error(f"Save Error: {e}"); return False

def update_invoice_in_gsheet(data_dict, sheet_obj, original_inv_to_find):
    if sheet_obj is None: return False
    try:
        cell = sheet_obj.find(str(original_inv_to_find).strip(), in_column=4)
        if cell:
            row_idx = cell.row
            row_values = [
                data_dict.get("UID", ""), data_dict.get("Serial No.", ""), data_dict.get("Ref. No.", ""),
                data_dict.get("Invoice Number", ""), data_dict.get("Date", ""), data_dict.get("Generated At", ""),
                data_dict.get("Customer Name", ""), data_dict.get("Age", ""), data_dict.get("Gender", ""),
                data_dict.get("Location", ""), data_dict.get("Address", ""), data_dict.get("Mobile", ""),
                data_dict.get("Plan", ""), data_dict.get("Shift", ""), data_dict.get("Recurring Service", ""),
                data_dict.get("Period", ""), data_dict.get("Visits", ""), data_dict.get("Amount", ""),
                data_dict.get("Notes / Remarks", ""), data_dict.get("Generated By", ""), data_dict.get("Amount Paid", ""),
                data_dict.get("Details", ""), data_dict.get("Service Started", ""), data_dict.get("Service Ended", "")
            ]
            range_name = f"A{row_idx}:X{row_idx}"
            sheet_obj.update(range_name, [row_values], value_input_option='USER_ENTERED')
            return True
        return False
    except Exception as e: st.error(f"Update Error: {e}"); return False

def update_nurse_management(sheet_obj, invoice_number, payment_amount, nurse_name, nurse_extra, nurse_note):
    if sheet_obj is None: return False
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4) 
        if cell:
            row_idx = cell.row
            details_val = sheet_obj.cell(row_idx, 22).value
            qty = 1
            if details_val:
                match = re.search(r'Paid for\s*:?\s*(\d+)', str(details_val), re.IGNORECASE)
                if match: qty = int(match.group(1))
            formula_string = f"=AB{row_idx}-(AC{row_idx}*AD{row_idx})"
            range_update = f"AC{row_idx}:AH{row_idx}"
            sheet_obj.update(range_update, [[payment_amount, qty, formula_string, nurse_name, nurse_extra, nurse_note]], value_input_option='USER_ENTERED')
            return True, formula_string
        return False, None
    except Exception as e: st.error(f"Nurse Update Error: {e}"); return False, None

def mark_service_ended(sheet_obj, invoice_number, end_date):
    if sheet_obj is None: return False, "No Sheet"
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            end_time = end_date.strftime("%Y-%m-%d") + " " + datetime.datetime.now().strftime("%H:%M:%S")
            range_name = f"X{cell.row}"
            sheet_obj.update(range_name, [[end_time]])
            return True, end_time
        return False, "Invoice not found"
    except Exception as e: return False, str(e)

# --- DRIVE UPLOAD HELPERS ---
def find_file_in_folder(service, folder_id, file_name):
    try:
        query = f"name = '{file_name}' and '{folder_id}' in parents and trashed = false"
        results = service.files().list(q=query, fields="files(id, name)").execute()
        files = results.get('files', [])
        if files: return files[0]['id']
        return None
    except: return None

def update_drive_file(service, file_id, file_content_bytes):
    try:
        media = MediaIoBaseUpload(BytesIO(file_content_bytes), mimetype='application/pdf')
        service.files().update(fileId=file_id, media_body=media).execute()
        return True
    except Exception as e: return False

def upload_to_drive(service, folder_id, file_name, file_content_bytes):
    file_metadata = {'name': file_name, 'parents': [folder_id]}
    media = MediaIoBaseUpload(BytesIO(file_content_bytes), mimetype='application/pdf')
    try:
        file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
        return file.get('id')
    except Exception as e:
        if "storage quota" in str(e).lower():
            try: service.files().emptyTrash().execute()
            except: pass
            file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
            return file.get('id')
        return None
        
def get_clean_image_base64(file_path):
    if not os.path.exists(file_path): return None
    try:
        img = Image.open(file_path).convert("RGBA")
        buffer = BytesIO()
        img.save(buffer, format="PNG", optimize=True)
        return base64.b64encode(buffer.getvalue()).decode('utf-8')
    except: return None

def get_absolute_path(filename):
    if os.path.exists(filename): return os.path.abspath(filename).replace('\\', '/')
    return None

# ==========================================
# BACKUP LOGIC (CRITICAL POINT)
# ==========================================
def perform_backup_logic(master_data, backup_url, target_month_str):
    """
    Copies data from Master to Backup Workbook based on Critical Logic.
    target_month_str format: 'Feb-26', 'Mar-26'
    """
    client = get_gspread_client()
    backup_id = extract_id_from_url(backup_url)
    
    if not backup_id or not client:
        return False, "Invalid Backup Configuration."

    try:
        backup_wb = client.open_by_key(backup_id)
        
        # 1. Check if Target Sheet already exists
        try:
            target_ws = backup_wb.worksheet(target_month_str)
            return False, f"Backup for {target_month_str} already exists. Skipping to prevent overwrite."
        except gspread.exceptions.WorksheetNotFound:
            pass # Good, we proceed

        # 2. Check for "Sheet1" to rename
        try:
            default_ws = backup_wb.worksheet("Sheet1")
            # If Sheet1 exists and is basically empty or default, rename it
            default_ws.update_title(target_month_str)
            target_ws = default_ws
        except gspread.exceptions.WorksheetNotFound:
            # Sheet1 not found, creating new sheet
            target_ws = backup_wb.add_worksheet(title=target_month_str, rows=1000, cols=34)

        # 3. Copy Data
        # Clear existing data in the target sheet (just in case)
        target_ws.clear()
        # Update with Master Data
        target_ws.update(range_name="A1", values=master_data, value_input_option='USER_ENTERED')
        
        # Format Header
        try:
            target_ws.format("A1:AH1", {"textFormat": {"bold": True}, "backgroundColor": {"red": 0.8, "green": 0.8, "blue": 0.8}})
        except: pass

        return True, f"‚úÖ Success! Data backed up to sheet '{target_month_str}' in Backup Workbook."

    except Exception as e:
        return False, f"Backup Failed: {str(e)}"

# ==========================================
# UI & MAIN LOGIC
# ==========================================
st.title("üè• Vesak Care - Invoice Generator")

abs_logo_path = get_absolute_path(LOGO_FILE)
logo_b64 = get_clean_image_base64(LOGO_FILE)

# --- SIDEBAR CONFIGURATION ---
with st.sidebar:
    with st.expander("‚öôÔ∏è System Configuration", expanded=True):
        st.write("Enter Google Sheet Links:")
        m_link = st.text_input("Master Workbook Link (Active):", value=sys_config.get("master_sheet_url", ""))
        b_link = st.text_input("Backup Workbook Link (Archive):", value=sys_config.get("backup_sheet_url", ""))
        
        st.write("Enter Google Drive Folder Links:")
        inv_folder = st.text_input("Invoices Folder Link:", value=sys_config.get("folder_invoices", ""))
        agg_folder = st.text_input("Agreements Folder Link:", value=sys_config.get("folder_agreements", ""))
        
        if st.button("üíæ Save Settings"):
            new_conf = {
                "master_sheet_url": m_link, "backup_sheet_url": b_link,
                "folder_invoices": inv_folder, "folder_agreements": agg_folder
            }
            save_system_config(new_conf)
            st.success("Settings Saved!")
            st.rerun()

    # --- BACKUP REMINDER & MANAGER ---
    st.header("üóÑÔ∏è Backup Manager")
    backup_date = datetime.date.today()
    backup_month_str = backup_date.strftime("%b-%y") # e.g., Jan-26
    
    st.info(f"Current Period: **{backup_month_str}**")
    st.caption("Remind me: Check if backup is needed when month changes.")
    
    if st.button("üöÄ Run Monthly Backup Now"):
        if not sys_config["master_sheet_url"] or not sys_config["backup_sheet_url"]:
            st.error("Please configure Master and Backup links first.")
        else:
            # Get Master Data
            client = get_gspread_client()
            master_id = extract_id_from_url(sys_config["master_sheet_url"])
            try:
                wb_master = client.open_by_key(master_id)
                # We assume Master works on the current month sheet too
                ws_master = wb_master.worksheet(backup_month_str) 
                data_to_copy = ws_master.get_all_values()
                
                if not data_to_copy:
                    st.warning("Master sheet is empty.")
                else:
                    status, msg = perform_backup_logic(data_to_copy, sys_config["backup_sheet_url"], backup_month_str)
                    if status: st.success(msg)
                    else: st.warning(msg)
            except Exception as e:
                st.error(f"Could not read Master Workbook: {e}")

    st.markdown("---")
    st.subheader("üñ®Ô∏è PDF Settings")
    pdf_top_margin = st.slider("Adjust Top Margin (px):", min_value=0, max_value=200, value=20, step=5)
    
    data_source = st.radio("Load Customer Data via:", ["Upload File", "OneDrive Link"])
    if st.button("üîÑ Refresh"): st.cache_data.clear(); st.rerun()

# --- LOAD INPUT FILE ---
raw_file_obj = None
if data_source == "Upload File":
    uploaded_file = st.sidebar.file_uploader("Upload Excel/CSV", type=['xlsx', 'csv'])
    if uploaded_file: raw_file_obj = uploaded_file
elif data_source == "OneDrive Link":
    current_url = load_config_path(URL_CONFIG_FILE)
    url_input = st.sidebar.text_input("Paste Link:", value=current_url)
    if st.sidebar.button("Load"): save_config_path(url_input, URL_CONFIG_FILE); st.rerun()
    if current_url: raw_file_obj = robust_file_downloader(current_url)

# --- MAIN TABS ---
tab1, tab2, tab5 = st.tabs(["üßæ Generate Invoice", "üÜï Force New Invoice", "üí∞ Nurse Manage"])

# ==========================================
# CORE INVOICE FUNCTION
# ==========================================
def render_invoice_ui(df_main, mode="standard"):
    # --- CRITICAL FIX: INITIALIZE VARIABLE EARLY ---
    chk_overwrite = False # <--- Prevents the crash
    conflict_exists = False
    
    # 1. Connect to Master Sheet
    client = get_gspread_client()
    master_id = extract_id_from_url(sys_config.get("master_sheet_url"))
    drive_service = get_drive_service()

    if not master_id or not client:
        st.error("‚ùå Master Workbook not linked in Sidebar Settings."); return

    # Date Selection
    c1, c2 = st.columns(2)
    with c1: global_inv_date = st.date_input("Invoice Date:", value=datetime.date.today(), key=f"date_{mode}")
    
    # Sheet Name Logic (Mmm-YY)
    mmm_yy = global_inv_date.strftime("%b-%y") # Jan-26
    
    try:
        wb = client.open_by_key(master_id)
        try:
            sheet_obj = wb.worksheet(mmm_yy)
        except:
            # Create if not exists
            sheet_obj = wb.add_worksheet(title=mmm_yy, rows=1000, cols=34)
            sheet_obj.append_row(SHEET_HEADERS)
    except Exception as e:
        st.error(f"Connection Error: {e}"); return

    # Load History (Only from this Master Sheet - Simplified)
    df_history = pd.DataFrame(sheet_obj.get_all_records())
    if 'Invoice Number' in df_history.columns: df_history['Invoice Number'] = df_history['Invoice Number'].astype(str)

    # Customer Selection
    df_main['Ref_Clean'] = df_main['Ref. No.'].astype(str).str.strip()
    valid_refs = df_main['Ref_Clean'].unique()
    
    # Filter Logic
    if mode == "standard" and not df_history.empty and 'Ref. No.' in df_history.columns:
        # Exclude Ended Services
        ended_refs = df_history[df_history['Service Ended'].astype(str).str.strip() != ""]['Ref. No.'].astype(str).unique()
        valid_refs = [x for x in valid_refs if x not in ended_refs]
    
    df_view = df_main[df_main['Ref_Clean'].isin(valid_refs)]
    df_view['Label'] = df_view['Name'].astype(str) + " (" + df_view['Mobile'].astype(str) + ")"
    
    selected_label = st.selectbox(f"Select Customer ({mode}):", [""] + list(df_view['Label'].unique()), key=f"sel_{mode}")
    
    if not selected_label: return

    # Get Customer Data
    row = df_view[df_view['Label'] == selected_label].iloc[0]
    c_name = row.get('Name', '')
    c_ref = str(row.get('Ref. No.', '')).strip()
    c_mob = row.get('Mobile', '')
    c_plan = row.get('Service Required', '')
    
    # Check Active Record in Master
    active_record = None
    if not df_history.empty and 'Ref. No.' in df_history.columns:
        matches = df_history[(df_history['Ref. No.'].astype(str) == c_ref) & (df_history['Service Ended'].astype(str) == "")]
        if not matches.empty: active_record = matches.iloc[-1]

    # Invoice Number Logic
    st.divider()
    col1, col2 = st.columns(2)
    
    with col1:
        st.write(f"**Plan:** {c_plan} | **Ref:** {c_ref}")
        
        # Determine Next Invoice Number
        loc_code = "MUM" if "mumbai" in str(row.get('Location', '')).lower() else "PUN"
        date_part = global_inv_date.strftime('%y%m%d')
        prefix = f"{loc_code}-{date_part}-"
        
        next_seq = 1
        if not df_history.empty:
             todays_invs = df_history[df_history['Invoice Number'].str.startswith(prefix)]
             if not todays_invs.empty:
                 # Extract last sequence
                 seqs = [int(x.split('-')[-1]) for x in todays_invs['Invoice Number'] if '-' in x]
                 if seqs: next_seq = max(seqs) + 1
        
        next_inv = f"{prefix}{next_seq:03d}"
        
        if mode == "standard" and active_record is not None:
            st.warning(f"‚ö†Ô∏è Active Invoice Found: {active_record['Invoice Number']}")
            conflict_exists = True
            inv_final = str(active_record['Invoice Number'])
            chk_overwrite = st.checkbox("Overwrite Invoice", key=f"ow_{mode}") # <--- Variable assigned here if conflict
        else:
            st.info(f"‚ÑπÔ∏è New Invoice: {next_inv}")
            inv_final = next_inv
            
        inv_input = st.text_input("Invoice Number", value=inv_final, disabled=True)

    with col2:
        billing_qty = st.number_input("Paid Units:", min_value=1, value=1, key=f"qty_{mode}")
        notes = st.text_area("Notes:", value=str(row.get('Notes', '')), key=f"note_{mode}")

    # Services
    st.subheader("Services")
    inc_list, exc_list = get_base_lists(c_plan, row.get('Sub Service', 'All'))
    sc1, sc2 = st.columns(2)
    with sc1: st.text_area("Included", ", ".join(inc_list), disabled=True)
    with sc2: exc_text = st.text_area("Excluded (Editable)", ", ".join(exc_list), key=f"exc_{mode}_{c_ref}")

    # Buttons
    b1, b2, b3 = st.columns(3)
    btn_save = False
    
    with b1:
        if conflict_exists:
            if chk_overwrite: 
                if st.button("Overwrite", type="primary", key=f"b_ov_{mode}"): btn_save = True
            else: st.button("Overwrite", disabled=True, key=f"b_ov_dis_{mode}")
        else:
            if st.button("Create Invoice", type="primary", key=f"b_cr_{mode}"): btn_save = True
            
    with b2: btn_nurse = st.button("Nurse Agreement", key=f"b_nu_{mode}")
    with b3: btn_patient = st.button("Patient Agreement", key=f"b_pa_{mode}")

    # Save Logic
    if btn_save:
        # Calculate Amounts
        rate = float(row.get('Unit Rate', 0))
        total = rate * billing_qty
        
        # Prepare Data
        record = {
            "UID": "", "Serial No.": str(row.get('Serial No.', '')), "Ref. No.": c_ref,
            "Invoice Number": inv_input, "Date": format_date_with_suffix(global_inv_date),
            "Generated At": datetime.datetime.now().strftime("%Y-%m-%d"),
            "Customer Name": c_name, "Mobile": c_mob, "Plan": c_plan,
            "Amount": rate, "Amount Paid": total, "Notes / Remarks": notes,
            "Service Started": datetime.datetime.now().strftime("%Y-%m-%d"), "Service Ended": "",
            "Details": f"Paid for {billing_qty} units"
        }
        
        # Save to Sheet (Overwrite or Append)
        if conflict_exists and chk_overwrite:
            update_invoice_in_gsheet(record, sheet_obj, inv_final)
            st.success("Updated!")
        else:
            if mode == "force_new" and active_record is not None:
                mark_service_ended(sheet_obj, active_record['Invoice Number'], global_inv_date)
            save_invoice_to_gsheet(record, sheet_obj)
            st.success("Created!")
            
        st.balloons()

    # Generate PDF (Agreement or Invoice)
    if btn_save or btn_nurse or btn_patient:
        doc_type = "Invoice" if btn_save else ("Nurse" if btn_nurse else "Patient")
        display_type = "NURSE AGREEMENT" if btn_nurse else "PATIENT AGREEMENT"
        
        # Determine HTML Content
        if doc_type == "Invoice":
            html_content = f"""
            <!DOCTYPE html><html><head><style>
                @page {{ size: a4 portrait; margin: 1cm; }}
                body {{ font-family: 'Helvetica', sans-serif; }}
                .header {{ text-align: center; }}
                .service-box {{ margin-top: 10px; font-size: 12px; }}
            </style></head><body>
                <div class="header"><h2>INVOICE: {inv_input}</h2></div>
                <p><strong>Customer:</strong> {c_name}</p>
                <p><strong>Mobile:</strong> {c_mob}</p>
                <hr>
                <p><strong>Amount Paid:</strong> ‚Çπ{total}</p>
                <p><strong>Date:</strong> {format_date_with_suffix(global_inv_date)}</p>
                <br>
                <p><em>Notes: {notes}</em></p>
                <div class="service-box">
                    <strong>Services Not Included:</strong><br>{exc_text}
                </div>
            </body></html>
            """
        else:
             html_content = f"""
            <!DOCTYPE html><html><head><style>
                @page {{ size: a4 portrait; margin: 1cm; }}
                body {{ font-family: 'Helvetica', sans-serif; }}
                .header {{ text-align: center; }}
            </style></head><body>
                <div class="header">
                    <img src="data:image/png;base64,{logo_b64}" width="100">
                    <h2>Vesak Care Foundation</h2>
                </div>
                <h3>{display_type}</h3>
                <p><strong>Ref:</strong> {c_ref}</p>
                <p><strong>Date:</strong> {format_date_with_suffix(global_inv_date)}</p>
                <br><br><br>
                <p>Authorized Signatory</p>
            </body></html>
            """
            
        pdf_bytes = convert_html_to_pdf(html_content)
        
        if pdf_bytes:
            file_name = generate_filename(doc_type, inv_input, c_name)
            
            # Save to Drive if Configured
            folder_id = sys_config.get("folder_invoices") if doc_type == "Invoice" else sys_config.get("folder_agreements")
            # If folder is a URL, extract ID
            folder_id = extract_id_from_url(folder_id)

            if folder_id and drive_service:
                existing_id = find_file_in_folder(drive_service, folder_id, file_name)
                if existing_id:
                    if conflict_exists and chk_overwrite:
                        update_drive_file(drive_service, existing_id, pdf_bytes)
                        st.success(f"Drive: Overwritten {file_name}")
                    else:
                        st.warning(f"Drive: File {file_name} exists. Skipping upload.")
                else:
                    upload_to_drive(drive_service, folder_id, file_name, pdf_bytes)
                    st.success(f"Drive: Saved {file_name}")
            
            st.download_button(f"‚¨áÔ∏è Download {doc_type} PDF", data=pdf_bytes, file_name=file_name, mime="application/pdf")

if raw_file_obj:
    try:
        filename = getattr(raw_file_obj, "name", "data.xlsx")
        is_excel = filename.endswith('.xlsx')
        if is_excel: df = pd.read_excel(raw_file_obj, engine='openpyxl')
        else: df = pd.read_csv(raw_file_obj)
        
        # Normalize columns
        df = normalize_columns(df, COLUMN_ALIASES)
        
        with tab1: render_invoice_ui(df, mode="standard")
        with tab2: render_invoice_ui(df, mode="force_new")
        
        with tab5:
            # Nurse Manage (Simplified)
            st.header("Nurse Management")
            client = get_gspread_client()
            mid = extract_id_from_url(sys_config.get("master_sheet_url"))
            if client and mid:
                wb = client.open_by_key(mid)
                ws = wb.worksheet(datetime.date.today().strftime("%b-%y"))
                
                inv_to_pay = st.text_input("Invoice No:")
                amt = st.number_input("Payment:")
                nm = st.text_input("Nurse Name:")
                
                if st.button("Update Payment"):
                    success, form = update_nurse_management(ws, inv_to_pay, amt, nm, "", "")
                    if success: st.success("Updated!")
                    else: st.error("Invoice not found.")

    except Exception as e: st.error(f"Error: {e}")
