import streamlit as st
import pandas as pd
import base64
import os
import datetime
import requests
import math 
import re 
from io import BytesIO
from PIL import Image, ImageFile
import streamlit.components.v1 as components
from xhtml2pdf import pisa 
import gspread
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build
from googleapiclient.http import MediaIoBaseUpload
import numpy as np
import traceback

# --- CRITICAL FIX FOR BROKEN IMAGES ---
ImageFile.LOAD_TRUNCATED_IMAGES = True

# ==========================================
# 1. SETUP & ASSET GENERATION
# ==========================================
st.set_page_config(page_title="Vesak Care Invoice", layout="wide", page_icon="üè•")

LOGO_FILE = "logo.png"
URL_CONFIG_FILE = "url_config.txt"

# --- HARDCODED FOLDER IDS ---
HISTORY_FOLDER_ID = "1e5iNxAwO8ly3_iAs2ONCyZO1CgQeFQhr"
AGREEMENTS_ROOT_ID = "16QWhwkhWS4S5nRWkPuusJ9UjQzf-2TKl"

# --- CRITICAL: HARDCODED SHEET ID FOR 2025 ---
MANUAL_SHEET_ID_25 = "1aBhZrgqtdD-bLE28Ujaq6lODou211wMnIIL8wxuPK5Q"

# --- HEADERS FOR NEW SHEETS (UPDATED TO MATCH CSV EXACTLY - 31 COLS) ---
SHEET_HEADERS = [
    "UID", "Serial No.", "Ref. No.", "Invoice Number", "Date", "Generated At",
    "Customer Name", "Age", "Gender", "Location", "Address", "Mobile",
    "Plan", "Shift", "Recurring Service", "Period", "Visits", "Amount",
    "Notes / Remarks", "Generated By", "Amount Paid", "Details",
    "Service Started", "Service Ended", "Referral Code", "Referral Name",
    "Referral Credit", "Net Amount", "Nurse Payment", "Paid for", "Earnings"
]

# --- SESSION STATE INITIALIZATION ---
if 'chk_print_dup' not in st.session_state: st.session_state.chk_print_dup = False
if 'chk_overwrite' not in st.session_state: st.session_state.chk_overwrite = False
if 'active_tab_simulation' not in st.session_state: st.session_state.active_tab_simulation = "Generate"

# --- CREDENTIALS HANDLING ---
@st.cache_resource
def get_credentials():
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets",
        "https://www.googleapis.com/auth/drive",
    ]
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        s_info = st.secrets["connections"]["gsheets"]
        private_key = s_info.get("private_key")
        if private_key: private_key = private_key.replace("\\n", "\n")
        creds_dict = {
            "type": s_info.get("type"),
            "project_id": s_info.get("project_id"),
            "private_key_id": s_info.get("private_key_id"),
            "private_key": private_key,
            "client_email": s_info.get("client_email"),
            "client_id": s_info.get("client_id"),
            "auth_uri": s_info.get("auth_uri"),
            "token_uri": s_info.get("token_uri"),
            "auth_provider_x509_cert_url": s_info.get("auth_provider_x509_cert_url"),
            "client_x509_cert_url": s_info.get("client_x509_cert_url"),
        }
        return Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return None

def get_bot_email():
    try: return st.secrets["connections"]["gsheets"]["client_email"]
    except: return "Unknown"

# --- CONNECT TO GOOGLE DRIVE ---
@st.cache_resource
def get_drive_service():
    try:
        creds = get_credentials()
        if creds: return build('drive', 'v3', credentials=creds)
    except Exception as e: st.error(f"Drive Connection Error: {e}")
    return None

# --- DRIVE FOLDER LOGIC ---
def get_or_create_folder(service, folder_name, parent_id=None):
    safe_name = folder_name.replace("'", "\\'")
    query = f"mimeType='application/vnd.google-apps.folder' and name='{safe_name}' and trashed=false"
    if parent_id: query += f" and '{parent_id}' in parents"
    results = service.files().list(q=query, fields="files(id, name)").execute()
    files = results.get('files', [])
    if files: return files[0]['id']
    else:
        try:
            file_metadata = {'name': folder_name, 'mimeType': 'application/vnd.google-apps.folder'}
            if parent_id: file_metadata['parents'] = [parent_id]
            file = service.files().create(body=file_metadata, fields='id').execute()
            return file.get('id')
        except Exception as e: raise e

def manage_drive_folders(service, doc_type, date_obj):
    root_id = AGREEMENTS_ROOT_ID
    yy = date_obj.strftime("%y") 
    mmm_yy = date_obj.strftime("%b-%y") 
    if mmm_yy.startswith("Jan") and mmm_yy[3] != '-': mmm_yy = date_obj.strftime("%b-%y")
    cat_folder_name = f"{doc_type} Agreement {yy}"
    cat_id = get_or_create_folder(service, cat_folder_name, parent_id=root_id)
    month_id = get_or_create_folder(service, mmm_yy, parent_id=cat_id)
    return month_id, f"Vesak Agreements/{cat_folder_name}/{mmm_yy}"

def upload_to_drive(service, folder_id, file_name, file_content_bytes):
    file_metadata = {'name': file_name, 'parents': [folder_id]}
    media = MediaIoBaseUpload(BytesIO(file_content_bytes), mimetype='application/pdf')
    try:
        file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
        return file.get('id')
    except Exception as e:
        if "storage quota" in str(e).lower():
            try: service.files().emptyTrash().execute()
            except: pass
            file = service.files().create(body=file_metadata, media_body=media, fields='id').execute()
            return file.get('id')
        return None

# --- AUTOMATIC FORMATTING FUNCTION (UPDATED FOR 31 COLUMNS) ---
def format_worksheet_header(ws):
    """Applies specific formatting: Header Navy Blue, Service Ended Red, Widths."""
    try:
        # 1. Format Header Row (A1:AE1) - Navy Blue Background
        ws.format("A1:AE1", {
            "backgroundColor": {"red": 0.0, "green": 0.13, "blue": 0.28}, # #002147 Navy
            "textFormat": {
                "foregroundColor": {"red": 1.0, "green": 1.0, "blue": 1.0},
                "bold": True,
                "fontSize": 10
            },
            "horizontalAlignment": "CENTER",
            "verticalAlignment": "MIDDLE",
            "wrapStrategy": "WRAP"
        })
        
        # 2. Highlight 'Service Ended' Header (Col X = Index 24) in Red
        ws.format("X1", {
             "backgroundColor": {"red": 0.8, "green": 0.0, "blue": 0.0},
             "textFormat": {"foregroundColor": {"red": 1.0, "green": 1.0, "blue": 1.0}, "bold": True}
        })
        
        # 3. Freeze the first row
        ws.freeze(rows=1)
        
        # 4. Resize Columns (Updated for better view)
        ws.set_column_width(0, 50)   # A: UID
        ws.set_column_width(1, 50)   # B: Serial
        ws.set_column_width(6, 180)  # G: Customer Name (Wide)
        ws.set_column_width(9, 100)  # J: Location
        ws.set_column_width(10, 200) # K: Address (Very Wide)
        ws.set_column_width(21, 200) # V: Details (Wide)
        
    except Exception as e:
        print(f"Formatting warning: {e}")

# --- SMART SHEET CONNECTION ---
def get_active_sheet_client(drive_service, date_obj):
    try:
        creds = get_credentials()
        if not creds: return None
        client = gspread.authorize(creds)
        
        yy = date_obj.strftime("%y")
        mmm_yy = date_obj.strftime("%b-%y").capitalize()
        wb_name = f"Vesak_Invoice_{yy}"
        spreadsheet = None

        if yy == "25" and MANUAL_SHEET_ID_25:
            try: spreadsheet = client.open_by_key(MANUAL_SHEET_ID_25)
            except: pass

        if spreadsheet is None:
            try: spreadsheet = client.open(wb_name)
            except gspread.exceptions.SpreadsheetNotFound:
                bot_email = get_bot_email()
                st.markdown(f"""### üõë New Workbook Required: `{wb_name}`
                1. Create Sheet **`{wb_name}`** in Drive.
                2. Share with: `{bot_email}`""")
                if st.button("I have created it"): st.rerun()
                st.stop()

        worksheet = None
        try:
            worksheet = spreadsheet.worksheet(mmm_yy)
        except gspread.exceptions.WorksheetNotFound:
            try:
                default_sheet = spreadsheet.worksheet("Sheet1")
                if len(default_sheet.get_all_values()) < 2:
                    default_sheet.update_title(mmm_yy)
                    worksheet = default_sheet
                    if not worksheet.get_all_values(): worksheet.append_row(SHEET_HEADERS)
                    format_worksheet_header(worksheet)
                    st.toast(f"‚ÑπÔ∏è Formatted Sheet1 to {mmm_yy}")
                else:
                    worksheet = spreadsheet.add_worksheet(title=mmm_yy, rows="1000", cols="31")
                    worksheet.append_row(SHEET_HEADERS)
                    format_worksheet_header(worksheet)
                    st.toast(f"üéâ Created Tab: {mmm_yy}")
            except gspread.exceptions.WorksheetNotFound:
                worksheet = spreadsheet.add_worksheet(title=mmm_yy, rows="1000", cols="31")
                worksheet.append_row(SHEET_HEADERS)
                format_worksheet_header(worksheet)
                st.toast(f"üéâ Created Tab: {mmm_yy}")
            
        return spreadsheet, worksheet

    except Exception as e:
        st.error(f"Google Sheet Error: {e}")
        return None, None

# --- MASTER HISTORY LOGIC ---
@st.cache_data(ttl=60)
def get_master_history(current_wb_name, _current_sheet_obj):
    frames = []
    if MANUAL_SHEET_ID_25:
        try:
            creds = get_credentials()
            client = gspread.authorize(creds)
            wb_25 = client.open_by_key(MANUAL_SHEET_ID_25)
            for ws in wb_25.worksheets():
                 data = ws.get_all_records()
                 if data: frames.append(pd.DataFrame(data))
        except: pass
            
    if _current_sheet_obj:
        try:
            if _current_sheet_obj.spreadsheet.id != MANUAL_SHEET_ID_25:
                data_curr = _current_sheet_obj.get_all_records()
                if data_curr: frames.append(pd.DataFrame(data_curr))
        except: pass
        
    if not frames: return pd.DataFrame()
    master_df = pd.concat(frames, ignore_index=True)
    if 'Invoice Number' in master_df.columns:
        master_df['Invoice Number'] = master_df['Invoice Number'].astype(str)
    return master_df.dropna(how='all')

# --- HELPER FUNCTIONS ---
def get_absolute_path(filename):
    if os.path.exists(filename): return os.path.abspath(filename).replace('\\', '/')
    return None

def get_clean_image_base64(file_path):
    if not os.path.exists(file_path): return None
    try:
        img = Image.open(file_path).convert("RGBA")
        buffer = BytesIO()
        img.save(buffer, format="PNG", optimize=True)
        return base64.b64encode(buffer.getvalue()).decode('utf-8')
    except: return None

def clean_text(text): return str(text).strip() if isinstance(text, str) else str(text)

def format_date_with_suffix(d):
    if pd.isna(d) or str(d).lower() in ['nan', 'n/a']: return "N/A"
    try:
        if not isinstance(d, (datetime.date, datetime.datetime)): d = pd.to_datetime(d)
        if isinstance(d, datetime.datetime): d = d.date()
        day = d.day
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(day % 10, "th") if not 10 < day < 14 else "th"
        return d.strftime(f"%b. {day}{suffix} %Y")
    except: return str(d)

def load_config_path(file_name):
    if os.path.exists(file_name):
        with open(file_name, "r") as f: return f.read().strip()
    return ""

def save_config_path(path, file_name):
    with open(file_name, "w") as f: f.write(path.replace('"', '').strip())
    return path

@st.cache_data(show_spinner=False)
def robust_file_downloader(url):
    session = requests.Session()
    # ... (Headers kept same as original for brevity)
    try:
        response = session.get(url, verify=False, allow_redirects=True)
        if response.status_code == 200: return BytesIO(response.content)
        raise Exception(f"Status: {response.status_code}")
    except Exception as e: raise Exception(f"Download failed: {e}")

# --- DATABASE HELPERS ---
def get_next_invoice_number_gsheet(date_obj, df_hist, location_str):
    loc_clean = str(location_str).strip().lower()
    loc_code = "MUM" if "mumbai" in loc_clean else "KOP" if "kolhapur" in loc_clean else "PUN"
    date_part = date_obj.strftime('%y%m%d')
    prefix_str = f"{loc_code}-{date_part}-"
    next_seq = 1
    
    if not df_hist.empty and 'Invoice Number' in df_hist.columns:
        df_hist['Invoice Number'] = df_hist['Invoice Number'].astype(str)
        day_loc_inv = df_hist[df_hist['Invoice Number'].str.startswith(prefix_str)]
        if not day_loc_inv.empty:
            try:
                day_loc_inv['Seq'] = day_loc_inv['Invoice Number'].apply(lambda x: int(x.split('-')[-1]) if '-' in x else 0)
                next_seq = day_loc_inv['Seq'].max() + 1
            except: pass
    return f"{prefix_str}{next_seq:03d}"

def get_next_uid_gsheet(df_hist):
    if df_hist.empty or 'UID' not in df_hist.columns: return "0001"
    try:
        uids = pd.to_numeric(df_hist['UID'], errors='coerce').fillna(0)
        return f"{int(uids.max()) + 1:04d}"
    except: return "0001"

def get_active_invoice_record(df_hist, ref_no):
    if df_hist.empty or 'Ref. No.' not in df_hist.columns: return None
    df_hist['Ref_Clean'] = df_hist['Ref. No.'].astype(str).str.strip()
    target_ref = str(ref_no).strip()
    client_rows = df_hist[df_hist['Ref_Clean'] == target_ref]
    if client_rows.empty: return None
    if 'Service Ended' in client_rows.columns:
        client_rows['Service_Ended_Clean'] = client_rows['Service Ended'].fillna('').astype(str).str.strip()
        active_rows = client_rows[client_rows['Service_Ended_Clean'] == '']
        if not active_rows.empty: return active_rows.iloc[-1]
    return None

def check_if_service_ended_history(df_hist, ref_no):
    if df_hist.empty or 'Ref. No.' not in df_hist.columns: return False
    df_hist['Ref_Clean'] = df_hist['Ref. No.'].astype(str).str.strip()
    client_rows = df_hist[df_hist['Ref_Clean'] == str(ref_no).strip()]
    if client_rows.empty: return False 
    last_row = client_rows.iloc[-1]
    svc_end = ""
    if 'Service Ended' in last_row: svc_end = str(last_row['Service Ended']).strip()
    return svc_end != ""

def get_last_billing_qty(df_hist, customer_name, mobile):
    if df_hist.empty or 'Customer Name' not in df_hist.columns: return 1
    mask = (df_hist['Customer Name'].astype(str).str.lower() == str(customer_name).lower())
    if not client_history.empty:
        match = re.search(r'Paid for (\d+)', str(client_history.iloc[-1]['Details']))
        if match: return int(match.group(1))
    return 1

# --- SAVE TO GSHEET (UPDATED FOR 31 COLUMNS & FORMULAS) ---
def save_invoice_to_gsheet(data_dict, sheet_obj):
    if sheet_obj is None: return False
    try:
        all_vals = sheet_obj.get_all_values()
        next_row_num = len(all_vals) + 1
        
        # Formulas mapped to columns:
        # U (21) = Amount Paid, AA (27) = Referral Credit -> AB = Net Amount
        formula_net_amount = f"=U{next_row_num}-AA{next_row_num}"
        # AB = Net Amount, AC = Nurse Payment, AD = Paid For(Qty) -> AE = Earnings
        formula_earnings = f"=AB{next_row_num}-(AC{next_row_num}*AD{next_row_num})"
        
        details_txt = data_dict.get("Details", "")
        qty_extracted = 1
        match = re.search(r'Paid for (\d+)', details_txt)
        if match: qty_extracted = int(match.group(1))

        row_values = [
            data_dict.get("UID", ""), 
            data_dict.get("Serial No.", ""), 
            data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""), 
            data_dict.get("Date", ""), 
            data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""), 
            data_dict.get("Age", ""), 
            data_dict.get("Gender", ""),
            data_dict.get("Location", ""), 
            data_dict.get("Address", ""), 
            data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""), 
            data_dict.get("Shift", ""), 
            data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""), 
            data_dict.get("Visits", ""), 
            data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""), 
            data_dict.get("Generated By", ""), 
            data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""), 
            data_dict.get("Service Started", ""), 
            data_dict.get("Service Ended", ""),
            data_dict.get("Referral Code", ""), 
            data_dict.get("Referral Name", ""), 
            data_dict.get("Referral Credit", ""),
            formula_net_amount, # AB: Net Amount
            "",                 # AC: Nurse Payment (Empty initially)
            qty_extracted,      # AD: Paid For
            formula_earnings    # AE: Earnings
        ]
        sheet_obj.append_row(row_values, value_input_option='USER_ENTERED')
        return True
    except Exception as e:
        st.error(f"Error saving to Google Sheet: {e}"); return False

# --- UPDATE INVOICE ---
def update_invoice_in_gsheet(data_dict, sheet_obj, original_inv_to_find):
    if sheet_obj is None: return False
    try:
        cell = sheet_obj.find(str(original_inv_to_find).strip(), in_column=4)
        if cell:
            row_idx = cell.row
            # Update Columns A to X (Leaving formulas at end intact ideally, or we can update all)
            # For safety, we update main data fields
            row_values = [
                data_dict.get("UID", ""), data_dict.get("Serial No.", ""), data_dict.get("Ref. No.", ""),
                data_dict.get("Invoice Number", ""), data_dict.get("Date", ""), data_dict.get("Generated At", ""),
                data_dict.get("Customer Name", ""), data_dict.get("Age", ""), data_dict.get("Gender", ""),
                data_dict.get("Location", ""), data_dict.get("Address", ""), data_dict.get("Mobile", ""),
                data_dict.get("Plan", ""), data_dict.get("Shift", ""), data_dict.get("Recurring Service", ""),
                data_dict.get("Period", ""), data_dict.get("Visits", ""), data_dict.get("Amount", ""),
                data_dict.get("Notes / Remarks", ""), data_dict.get("Generated By", ""), data_dict.get("Amount Paid", ""),
                data_dict.get("Details", ""), data_dict.get("Service Started", ""), data_dict.get("Service Ended", "")
            ]
            range_name = f"A{row_idx}:X{row_idx}"
            sheet_obj.update(range_name, [row_values], value_input_option='USER_ENTERED')
            return True
        return False
    except Exception as e:
        st.error(f"Error updating Google Sheet: {e}"); return False

# --- UPDATE NURSE PAYMENT ---
def update_nurse_payment(sheet_obj, invoice_number, payment_amount):
    if sheet_obj is None: return False
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4) 
        if cell:
            row_idx = cell.row
            details_val = sheet_obj.cell(row_idx, 22).value
            qty = 1
            if details_val:
                match = re.search(r'Paid for\s*:?\s*(\d+)', str(details_val), re.IGNORECASE)
                if match: qty = int(match.group(1))
            
            # AC = Nurse Payment, AD = Qty
            range_notation = f"AC{row_idx}:AD{row_idx}"
            sheet_obj.update(range_notation, [[payment_amount, qty]], value_input_option='USER_ENTERED')
            return True
        return False
    except Exception as e:
        st.error(f"Error updating payment: {e}"); return False

def mark_service_ended(sheet_obj, invoice_number, end_date):
    if sheet_obj is None: return False, "No Sheet"
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            end_time = end_date.strftime("%Y-%m-%d") + " " + datetime.datetime.now().strftime("%H:%M:%S")
            range_name = f"X{cell.row}"
            sheet_obj.update(range_name, [[end_time]])
            return True, end_time
        return False, "Invoice not found"
    except Exception as e: return False, str(e)

# ==========================================
# 3. DATA LOGIC & LISTS
# ==========================================
SERVICES_MASTER = {
    "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
    "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
    "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
    "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
    "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
    "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
    "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
}
STANDARD_PLANS = list(SERVICES_MASTER.keys())[:5]
PLAN_DISPLAY_NAMES = {
    "Plan A: Patient Attendant Care": "Patient Care", "Plan B: Skilled Nursing": "Nursing Care",
    "Plan C: Chronic Management": "Chronic Management Care", "Plan D: Elderly Companion": "Elderly Companion Care",
    "Plan E: Maternal & Newborn": "Maternal & Newborn Care", "Plan F: Rehabilitative Care": "Rehabilitative Care",
    "A-la-carte Services": "Other Services"
}
COLUMN_ALIASES = {
    'Serial No.': ['Serial No.', 'serial no', 'sr no', 'sr. no.', 'id'],
    'Ref. No.': ['Ref. No.', 'ref no', 'ref. no.', 'reference no', 'reference number'],
    'Name': ['Name', 'name', 'patient name', 'client name'],
    'Mobile': ['Mobile', 'mobile', 'phone', 'contact'],
    'Location': ['Location', 'location', 'city'], 
    'Address': ['Address', 'address', 'residence'],
    'Gender': ['Gender', 'gender', 'sex'],
    'Age': ['Age', 'age'],
    'Service Required': ['Service Required', 'service required', 'plan'],
    'Sub Service': ['Sub Service', 'sub service', 'sub plan'],
    'Final Rate': ['Final Rate', 'final rate', 'amount', 'total amount'],
    'Unit Rate': ['Rate Agreed (‚Çπ)', 'rate agreed', 'unit rate', 'per day rate'],
    'Call Date': ['Call Date', 'call date'],
    'Notes': ['Notes / Remarks', 'notes'],
    'Shift': ['Shift', 'shift'],
    'Recurring': ['Recurring Service', 'recurring'],
    'Period': ['Period', 'period'],
    'Visits': ['Vists', 'visits', 'visit'],
    'Referral Code': ['Referral Code', 'referral code', 'ref code'],
    'Referral Name': ['Referral Name', 'referral name', 'ref name'],
    'Referral Credit': ['Referral Credit', 'referral credit', 'ref credit']
}

def get_base_lists(selected_plan, selected_sub_service):
    master_list = SERVICES_MASTER.get(selected_plan, [])
    if "All" in str(selected_sub_service) and selected_plan in STANDARD_PLANS:
        included_raw = [s for s in master_list if s.lower() != "all"]
    else: included_raw = [x.strip() for x in str(selected_sub_service).split(',')]
    included_clean = sorted(list(set([clean_text(s) for s in included_raw if clean_text(s)])))
    not_included_clean = []
    if selected_plan in STANDARD_PLANS:
        for plan_name in STANDARD_PLANS:
            if plan_name == selected_plan: continue 
            for item in SERVICES_MASTER.get(plan_name, []):
                if item.lower() == "all": continue
                cleaned = clean_text(item)
                if cleaned: not_included_clean.append(cleaned)
    else:
        for item in master_list:
            cleaned = clean_text(item)
            if cleaned and cleaned not in included_clean: not_included_clean.append(cleaned)
    return included_clean, list(set(not_included_clean))

def normalize_columns(df, aliases):
    df.columns = df.columns.astype(str).str.strip()
    for standard_name, possible_aliases in aliases.items():
        if standard_name in df.columns: continue 
        for alias in possible_aliases:
            for df_col in df.columns:
                if df_col.lower() == alias.lower():
                    df.rename(columns={df_col: standard_name}, inplace=True); break 
    return df

# --- HTML CONSTRUCTORS ---
def construct_description_html(row):
    shift_raw, period_raw = str(row.get('Shift', '')).strip(), str(row.get('Period', '')).strip()
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_str = shift_map.get(shift_raw, shift_raw)
    time_suffix = " (Time)" if "12" in shift_str else ""
    return f"""<div style="margin-top: 4px;"><div style="font-size: 12px; color: #4a4a4a; font-weight: bold;">{shift_str}{time_suffix}</div><div style="font-size: 10px; color: #777; font-style: italic; margin-top: 2px;">{period_raw}</div></div>"""

def construct_amount_html(row, billing_qty):
    try: unit_rate = float(row.get('Unit Rate', 0)) 
    except: unit_rate = 0.0
    period_raw, shift_raw = str(row.get('Period', '')).strip(), str(row.get('Shift', '')).strip()
    period_lower = period_raw.lower()
    is_per_visit = "per visit" in shift_raw.lower()
    
    def get_plural(unit, qty):
        if "month" in unit.lower(): return "Months" if qty > 1 else "Month"
        if "week" in unit.lower(): return "Weeks" if qty > 1 else "Week"
        if "day" in unit.lower(): return "Days" if qty > 1 else "Day"
        if "visit" in unit.lower(): return "Visits" if qty > 1 else "Visit" 
        return unit

    total_amount = unit_rate * billing_qty
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_display = shift_map.get(shift_raw, shift_raw)
    if "12" in shift_display and "Time" not in shift_display: shift_display += " (Time)"
    period_display = "Monthly" if "month" in period_lower else period_raw.capitalize()
    if "daily" in period_lower: period_display = "Daily"
    if is_per_visit: period_display = "Visit"
    
    unit_rate_str = "{:,.0f}".format(unit_rate)
    total_amount_str = "{:,.0f}".format(total_amount)
    unit_label = "Month" if "month" in period_lower else "Week" if "week" in period_lower else "Day"
    if is_per_visit: unit_label = "Visit"
    paid_for_text = f"Paid for {billing_qty} {get_plural(unit_label, billing_qty)}"
    
    return f"""<div style="text-align: right; font-size: 13px; color: #555;"><div style="margin-bottom: 4px;">{shift_display} / {period_display} = <b>‚Çπ {unit_rate_str}</b></div><div style="color: #CC4E00; font-weight: bold; font-size: 14px; margin: 2px 0;">X</div><div style="font-weight: bold; font-size: 13px; margin: 2px 0; color: #333;">{paid_for_text}</div><div style="border-bottom: 1px solid #ccc; width: 100%; margin: 6px 0;"></div><div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px;"><span style="font-size: 13px; font-weight: 800; color: #002147; text-transform: uppercase;">TOTAL - </span><span style="font-size: 16px; font-weight: bold; color: #000;">Rs. {total_amount_str}</span></div></div>"""

def convert_html_to_pdf(source_html):
    result = BytesIO()
    pisa_status = pisa.CreatePDF(source_html, dest=result)
    if pisa_status.err: return None
    return result.getvalue()

# ==========================================
# 4. UI & LOGIC
# ==========================================
st.title("üè• Vesak Care - Invoice Generator")

abs_logo_path = get_absolute_path(LOGO_FILE)
logo_b64 = get_clean_image_base64(LOGO_FILE)

drive_service = get_drive_service() 
sheet_obj = None 

with st.sidebar:
    st.header("üìÇ Data Source")
    if drive_service: st.success("Connected to Google Drive ‚úÖ")
    else: st.error("‚ùå Not Connected to Google Drive")
    data_source = st.radio("Load Confirmed Sheet via:", ["Upload File", "OneDrive Link"])
    if st.button("üîÑ Refresh Data Cache"): st.cache_data.clear(); st.success("Cache cleared!"); st.rerun()

raw_file_obj = None
if data_source == "Upload File":
    uploaded_file = st.sidebar.file_uploader("Upload Excel/CSV", type=['xlsx', 'csv'])
    if uploaded_file: raw_file_obj = uploaded_file
elif data_source == "OneDrive Link":
    current_url = load_config_path(URL_CONFIG_FILE)
    url_input = st.sidebar.text_input("Paste OneDrive/Sharepoint Link:", value=current_url)
    if st.sidebar.button("Load from Link"): save_config_path(url_input, URL_CONFIG_FILE); st.rerun()
    if current_url:
        try: raw_file_obj = robust_file_downloader(current_url); st.sidebar.success("‚úÖ File Downloaded")
        except Exception as e: st.sidebar.error(f"Link Error: {e}")

# --- TABS ---
tab1, tab2, tab5 = st.tabs(["üßæ Generate Invoice", "üÜï Force New Invoice", "üí∞ Nurse Payment"])

def render_invoice_ui(df_main, mode="standard"):
    st.info("üìÖ Step 1: Select Invoice Date to load the correct Workbook/Sheet")
    global_inv_date = st.date_input("Invoice Date:", value=datetime.date.today(), key=f"global_date_{mode}")
    
    current_wb_obj, current_sheet_obj = get_active_sheet_client(drive_service, global_inv_date)
    df_history_data = get_master_history(f"Vesak_Invoice_{global_inv_date.strftime('%y')}", current_sheet_obj)
    
    if current_sheet_obj: st.sidebar.success(f"Writing to: {current_sheet_obj.title} ‚úÖ")
    else: st.sidebar.error("‚ùå No Active Sheet Selected")

    chk_overwrite, valid_ref_nos = False, []
    if not df_history_data.empty and 'Ref. No.' in df_history_data.columns:
        unique_refs = df_main['Ref. No.'].unique()
        for ref in unique_refs:
            is_ended = check_if_service_ended_history(df_history_data, ref)
            if mode == "standard":
                if not is_ended: valid_ref_nos.append(str(ref))
            elif mode == "force_new":
                if is_ended: valid_ref_nos.append(str(ref))
    else:
        if mode == "standard": valid_ref_nos = df_main['Ref. No.'].astype(str).tolist()
    
    df_main['Ref_Clean'] = df_main['Ref. No.'].astype(str).str.strip()
    df_filtered_view = df_main[df_main['Ref_Clean'].isin([str(x).strip() for x in valid_ref_nos])]
    
    df_filtered_view['Label'] = df_filtered_view['Name'].astype(str) + " (" + df_filtered_view['Mobile'].astype(str) + ")"
    unique_labels = [""] + list(df_filtered_view['Label'].unique())
    selected_label = st.selectbox(f"Select Customer ({mode}):", unique_labels, key=f"sel_{mode}")
    
    if not selected_label: st.info("üëà Please select a customer to proceed."); return

    row = df_filtered_view[df_filtered_view['Label'] == selected_label].iloc[0]
    c_serial, c_ref_no, c_plan, c_sub = str(row.get('Serial No.', '')).strip(), str(row.get('Ref. No.', '')).strip(), row.get('Service Required', ''), row.get('Sub Service', '')
    c_name, c_gender = row.get('Name', ''), row.get('Gender', '')
    try: c_age = str(int(float(row.get('Age', '')))) if not pd.isna(row.get('Age', '')) and row.get('Age', '') != '' else ""
    except: c_age = str(row.get('Age', ''))
    c_addr, c_location, c_mob = row.get('Address', ''), row.get('Location', row.get('Address', '')), row.get('Mobile', '')
    inc_def, exc_def = get_base_lists(c_plan, c_sub)
    c_ref_code = str(row.get('Referral Code', '')).strip() if not pd.isna(row.get('Referral Code', '')) else ""
    c_ref_name = str(row.get('Referral Name', '')).strip() if not pd.isna(row.get('Referral Name', '')) else ""
    try: c_ref_credit = str(row.get('Referral Credit', '')).strip() if not pd.isna(row.get('Referral Credit', '')) else ""
    except: c_ref_credit = ""
    
    st.divider()
    col1, col2 = st.columns(2)
    with col1:
        st.info(f"**Plan:** {PLAN_DISPLAY_NAMES.get(c_plan, c_plan)}"); st.write(f"**Ref No:** {c_ref_no}")
        default_qty = get_last_billing_qty(df_history_data, c_name, c_mob)
        billing_qty = st.number_input(f"Paid for how many units?", min_value=1, value=default_qty, step=1, key=f"qty_{mode}_{selected_label}")
        
        active_record = get_active_invoice_record(df_history_data, c_ref_no)
        next_sequential_inv = get_next_invoice_number_gsheet(global_inv_date, df_history_data, c_location)
        next_uid = get_next_uid_gsheet(df_history_data)

        if mode == "standard":
            if active_record is not None:
                existing_inv_num = str(active_record['Invoice Number'])
                st.warning(f"‚ö†Ô∏è Active Invoice Found: {existing_inv_num}.")
                default_inv_num, final_uid = existing_inv_num, str(active_record.get('UID', ''))
                chk_overwrite = st.checkbox("Overwrite Invoice", key=f"chk_over_{mode}")
            else:
                st.info(f"‚ÑπÔ∏è Generating New Invoice No: {next_sequential_inv}")
                default_inv_num, final_uid = next_sequential_inv, str(next_uid)
        elif mode == "force_new":
            default_inv_num, final_uid = next_sequential_inv, str(next_uid)
            st.warning("‚ö† Generating NEW invoice for existing client.")

        inv_num_input = st.text_input("Invoice No:", value=default_inv_num, key=f"inv_input_{mode}")
        
    with col2:
        generated_by = st.text_input("Generated By:", value="Vesak Patient Care", key=f"gen_by_{mode}")
        final_notes = st.text_area("Notes:", value=str(row.get('Notes', '')), key=f"notes_{mode}")

    st.subheader("Referral Information")
    r_col1, r_col2, r_col3 = st.columns(3)
    with r_col1: in_ref_code = st.text_input("Referral Code", value=c_ref_code, disabled=bool(c_ref_code), key=f"ref_c_{mode}")
    with r_col2: in_ref_name = st.text_input("Referral Name", value=c_ref_name, disabled=bool(c_ref_name), key=f"ref_n_{mode}")
    with r_col3: in_ref_credit = st.text_input("Referral Credit", value=c_ref_credit, disabled=bool(c_ref_credit), key=f"ref_cr_{mode}")

    st.markdown("---")
    if st.button("Generate / Save Invoice", type="primary", key=f"btn_save_{mode}"):
        clean_plan = PLAN_DISPLAY_NAMES.get(c_plan, c_plan)
        try: unit_rate_val = float(row.get('Unit Rate', 0))
        except: unit_rate_val = 0.0
        total_billed_amount = unit_rate_val * billing_qty
        
        p_raw = str(row.get('Period', '')).strip()
        unit_label = "Month" if "month" in p_raw.lower() else "Week" if "week" in p_raw.lower() else "Day"
        details_text = f"Paid for {billing_qty} {unit_label}s" if billing_qty > 1 else f"Paid for {billing_qty} {unit_label}"
        
        invoice_record = {
            "UID": str(final_uid), "Serial No.": str(c_serial), "Ref. No.": str(c_ref_no),
            "Invoice Number": str(inv_num_input), "Date": format_date_with_suffix(global_inv_date), 
            "Generated At": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"), 
            "Customer Name": str(c_name), "Age": str(c_age), "Gender": str(c_gender), "Location": str(c_location), 
            "Address": str(c_addr), "Mobile": str(c_mob), "Plan": str(clean_plan), "Shift": str(row.get('Shift', '')),
            "Recurring Service": str(row.get('Recurring', '')), "Period": str(row.get('Period', '')), "Visits": 0, 
            "Amount": float(unit_rate_val), "Notes / Remarks": str(final_notes), "Generated By": str(generated_by), 
            "Amount Paid": float(total_billed_amount), "Details": details_text, 
            "Service Started": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "Service Ended": "", 
            "Referral Code": str(in_ref_code), "Referral Name": str(in_ref_name), "Referral Credit": str(in_ref_credit)
        }
        
        if mode == "standard" and chk_overwrite:
            if update_invoice_in_gsheet(invoice_record, current_sheet_obj, default_inv_num):
                st.success(f"‚úÖ Invoice {inv_num_input} Updated!")
                st.rerun()
        else:
            if mode == "force_new" and active_record is not None:
                mark_service_ended(current_sheet_obj, active_record['Invoice Number'], global_inv_date)
            if save_invoice_to_gsheet(invoice_record, current_sheet_obj):
                st.success(f"‚úÖ Invoice {inv_num_input} Created!")
                st.rerun()

if raw_file_obj:
    try:
        if hasattr(raw_file_obj, 'seek'): raw_file_obj.seek(0)
        df = pd.read_excel(raw_file_obj) if raw_file_obj.name.endswith('.xlsx') else pd.read_csv(raw_file_obj)
        df = normalize_columns(df, COLUMN_ALIASES)
        with tab1: render_invoice_ui(df, mode="standard")
        with tab2: render_invoice_ui(df, mode="force_new")
        with tab5:
            st.header("üí∞ Nurse Payment Update")
            pay_sheet_date = st.date_input("Load Sheet Date:", value=datetime.date.today(), key="pay_sheet_date")
            pay_wb_obj, pay_sheet_obj = get_active_sheet_client(drive_service, pay_sheet_date)
            # ... (Nurse Payment UI logic same as before, calling update_nurse_payment)
    except Exception as e: st.error(f"Error reading file: {e}")
