import streamlit as st
import pandas as pd
import base64
import os
import datetime
import requests
import math 
import re 
import json
import time 
from io import BytesIO
from PIL import Image, ImageFile
import streamlit.components.v1 as components
from xhtml2pdf import pisa 
import gspread
from google.oauth2.service_account import Credentials
import numpy as np

# --- CRITICAL FIX FOR BROKEN IMAGES ---
ImageFile.LOAD_TRUNCATED_IMAGES = True

# ==========================================
# 1. SETUP & CONFIGURATION
# ==========================================
st.set_page_config(page_title="Vesak Care Invoice", layout="wide", page_icon="üè•")

LOGO_FILE = "logo.png"
URL_CONFIG_FILE = "url_config.txt"
SYSTEM_CONFIG_FILE = "system_config.json" 

# --- HEADERS (34 COLUMNS) ---
# ‚≠ê CHANGE: Swapped positions of Referral Name (now Y) and Referral Code (now Z)
SHEET_HEADERS = [
    "UID", "Serial No.", "Ref. No.", "Invoice Number", "Date", "Generated At",
    "Customer Name", "Age", "Gender", "Location", "Address", "Mobile",
    "Plan", "Shift", "Recurring Service", "Period", "Visits", "Amount",
    "Notes / Remarks", "Generated By", "Amount Paid", "Details",
    "Service Started", "Service Ended", "Referral Name", "Referral Code",
    "Referral Credit", "Net Amount", "Nurse Payment", "Paid for", "Earnings",
    "Nurse Name", "Nurse Name (Extra)", "Nurse Note" 
]

# --- SESSION STATE INITIALIZATION ---
if 'chk_overwrite' not in st.session_state: st.session_state.chk_overwrite = False
if 'show_existing_customers' not in st.session_state: st.session_state.show_existing_customers = False    

# --- CONFIGURATION LOADER ---
def load_system_config():
    default_config = {
        "master_sheet_url": "",
        "backup_sheet_url": ""
    }
    if os.path.exists(SYSTEM_CONFIG_FILE):
        try:
            with open(SYSTEM_CONFIG_FILE, "r") as f:
                return json.load(f)
        except: return default_config
    return default_config

def save_system_config(config_data):
    with open(SYSTEM_CONFIG_FILE, "w") as f:
        json.dump(config_data, f)

def load_config_path(file_name):
    if os.path.exists(file_name):
        with open(file_name, "r") as f: return f.read().strip()
    return ""

def save_config_path(path, file_name):
    with open(file_name, "w") as f: f.write(path.replace('"', '').strip())
    return path

def extract_id_from_url(url):
    if not url: return ""
    match = re.search(r"/d/([a-zA-Z0-9-_]+)", url)
    if match: return match.group(1)
    if len(url) > 20 and "/" not in url: return url
    return ""

sys_config = load_system_config()

# --- GOOGLE AUTHENTICATION ---
@st.cache_resource
def get_credentials():
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        s_info = st.secrets["connections"]["gsheets"]
        private_key = s_info.get("private_key").replace("\\n", "\n")
        creds_dict = {
            "type": s_info.get("type"),
            "project_id": s_info.get("project_id"),
            "private_key_id": s_info.get("private_key_id"),
            "private_key": private_key,
            "client_email": s_info.get("client_email"),
            "client_id": s_info.get("client_id"),
            "auth_uri": s_info.get("auth_uri"),
            "token_uri": s_info.get("token_uri"),
            "auth_provider_x509_cert_url": s_info.get("auth_provider_x509_cert_url"),
            "client_x509_cert_url": s_info.get("client_x509_cert_url"),
        }
        return Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return None

def get_gspread_client():
    creds = get_credentials()
    if creds: return gspread.authorize(creds)
    return None

# ==========================================
# FILE HANDLING & HELPERS
# ==========================================
@st.cache_data(ttl=180, show_spinner=False)
def robust_file_downloader(url):
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Referer': 'https://www.google.com/'
    })
    download_url = url
    if "?" in url: base_url = url.split("?")[0]
    else: base_url = url
    if "1drv.ms" in url or "sharepoint" in url or "onedrive" in url:
        download_url = base_url + "?download=1"
    try:
        response = session.get(download_url, verify=False, allow_redirects=True)
        if response.status_code == 200:
            return BytesIO(response.content)
        raise Exception(f"Status Code: {response.status_code}")
    except Exception as e: return None

def format_date_with_suffix(d):
    """
    Returns date in format: "Jan 23rd 2026"
    """
    if pd.isna(d): return "N/A"
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        if not isinstance(d, datetime.date): return str(d)
        
        day = d.day
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(day % 10, "th") if not 10 < day < 14 else "th"
        return d.strftime(f"%b. {day}{suffix} %Y")
    except: return str(d)

def format_date_simple(d):
    """
    Returns date in format: "DD-MM-YYYY" (No Time)
    """
    if pd.isna(d): return ""
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        return d.strftime("%d-%m-%Y")
    except: return str(d)

def clean_text(text): return str(text).strip() if isinstance(text, str) else str(text)

# ===== CRITICAL FIX 1: ID NORMALIZATION (NO DECIMALS) =====
def normalize_id(val):
	   
						 
																	   
												 
										 
							 
	   
    if pd.isna(val): return ""
    s_val = str(val).strip()
    if s_val == "" or s_val.lower() == "nan": return ""
    try:
        return str(int(float(s_val)))
    except:
        return s_val

# --- CRITICAL FIX 2: CLEAN REFERRAL DATA (NO 'nan') ---
def clean_referral_field(val):
	   
																  
									  
	   
    if pd.isna(val): return ""
    s_val = str(val).strip()
    if s_val.lower() == "nan": return ""
    if s_val.lower() == "none": return ""
    if s_val == "": return ""
    return s_val

# --- CRITICAL FIX 3: CACHED EXCLUSION LIST (FIXES 429 ERROR) ---
# Modified get_cached_exclusion_list
@st.cache_data(ttl=300, show_spinner=False)
def get_cached_exclusion_list(master_id, month_str):
    client = get_gspread_client()
    if not client or not master_id: return [], [] # Return Tuple of two lists
    
    present_refs = []
    ended_refs = []
    try:
        wb = client.open_by_key(master_id)
        try:
            sheet_check = wb.worksheet(month_str)
            data_check = sheet_check.get_all_records()
            df_check = pd.DataFrame(data_check)
            
            if not df_check.empty:
                df_check['Ref_Norm'] = df_check['Ref. No.'].apply(normalize_id)
                df_check['Ser_Norm'] = df_check['Serial No.'].apply(normalize_id)
                
                # Iterate rows to find Present and Ended customers
                for _, row in df_check.iterrows():
                    key = f"{row['Ref_Norm']}-{row['Ser_Norm']}"
                    present_refs.append(key)
                    
                    # Check Column X ('Service Ended')
                    svc_end = str(row.get('Service Ended', '')).strip()
                    if svc_end:
                        ended_refs.append(key)
                        
        except gspread.exceptions.WorksheetNotFound: pass
    except Exception as e:
        return [], []
        
    return present_refs, ended_refs

# ==========================================
# SECTION 1: FUNCTION 2 - ENHANCED generate_filename()
# ==========================================
def generate_filename(doc_type, invoice_no, customer_name):
	   
										   
												  
										 
	   
    prefix = {
        "Invoice": "IN", 
        "Nurse": "NU", 
        "Patient": "PA",
        "DUPLICATE INVOICE": "DUP"
    }.get(doc_type, "DOC")
    
    clean_name = re.sub(r'[^a-zA-Z0-9]', '-', str(customer_name)).upper().strip('-')
    invoice_no_clean = str(invoice_no).strip()
    
    return f"{prefix}-{invoice_no_clean}-{clean_name}.pdf"

# --- HELPER FUNCTIONS FOR LISTS ---
def get_base_lists(selected_plan, selected_sub_service):
    # --- 1. DEFINE MAPPINGS FOR PLAN F (Rehabilitative Care) ---
    PLAN_F_DETAILS = {
        "Pain Management (Back, Knee, Neck, etc.)": [
            "One or Combinations of:",
            "Manual Therapy (Maitland/Mulligan Mobilization)",
            "Soft Tissue Release/Massage",
            "Kinesio-Taping application (Tape provided by client)",
            "Ergonomic & Postural Correction",
            "Cryotherapy/Heat application (using home packs)"
        ],
        "Neuro Rehabilitation": [
            "One or Combinations of:",
            "Neuro-developmental Therapy (NDT) handling",
            "Proprioceptive Neuromuscular Facilitation (PNF)",
            "Gross Motor function training",
            "Tone management (Inhibitory/Facilitatory techniques)"
        ],
        "Stroke Rehabilitation": [
            "One or Combinations of:",
            "Hemiplegic Gait Training",
            "Mirror Therapy concepts (using home mirror)",
            "Upper limb functional reaching tasks",
            "Trunk control exercises",
            "Sit-to-stand practice"
        ],
        "Paralysis Rehabilitation": [
            "One or Combinations of:",
            "Passive Range of Motion (to prevent contractures)",
            "Bed mobility (rolling/transfer techniques)",
            "Pressure sore prevention positioning",
            "Respiratory muscle training"
        ],
        "Parkinson‚Äôs Rehabilitation": [
            "One or Combinations of:",
            "Cueing strategies (Auditory/Visual for freezing)",
            "Big & Loud movement therapy concepts",
            "Rotational trunk exercises",
            "Balance training against resistance"
        ],
        "Post-Operative Rehabilitation": [
            "One or Combinations of:",
            "Edema management (Elevation/Massage)",
            "Graded Range of Motion exercises",
            "Isometric muscle setting",
            "Desensitization of scar tissue",
            "Crutch/Walker training"
        ],
        "Orthopedic (Fractures)": [
            "One or Combinations of:",
            "Patellar mobilization (for knee)",
            "Heel slides and Quadriceps activation",
            "Gait re-education (weaning off walker)",
            "Functional stair climbing training"
        ],
        "Total Knee Replacement / Total Hip  Replacement": [
            "One or Combinations of:",
            "Patellar mobilization (for knee)",
            "Heel slides and Quadriceps activation",
            "Gait re-education (weaning off walker)",
            "Functional stair climbing training"
        ],
        "Geriatric Wellness": [
            "One or Combinations of:",
            "Fall Prevention Audit & Obstacle negotiation",
            "General mobility exercises",
            "Sit-to-stand endurance",
            "Balance recovery strategies"
        ],
        "Cardio-Respiratory": [
            "One or Combinations of:",
            "Postural Drainage (Positioning for secretion removal)",
            "Percussion/Vibrations",
            "Active Cycle of Breathing Techniques (ACBT)",
            "Paced walking/Energy conservation techniques"
        ],
        "Pain Relief Pack": [
            "Manual Therapy (Mobilization/Massage)",
            "Heat/Cold application (using home packs)",
            "Focus: Symptom reduction"
        ],
        "Mobility Pack": [
            "Assisted stretching",
            "Passive Range of Motion of major joints",
            "Assisted walking",
            "Focus: Joint stiffness reduction"
        ],
        "Active Recovery Pack": [
            "Guided active exercise session",
            "Foam rolling instruction (roller provided by client)",
            "Cool-down stretching",
            "Focus: Post-sport/exertion recovery"
        ],
        "Acute Care Pack": [
            "R.I.C.E Protocol education",
            "Lymphatic drainage massage (light touch)",
            "Compression bandaging (bandage provided by client)"
        ],
        "Progressive Strength Training": [
            "One or Combinations of:",
            "Bodyweight resistance training (Calisthenics)",
            "Resistance Band exercises (bands provided by client)",
            "Functional lifting mechanics",
            "Eccentric muscle loading"
        ],
        "Joint Stabilization & Proprioception": [
            "One or Combinations of:",
            "Closed kinetic chain exercises",
            "Single-leg balance tasks",
            "Surface instability training (using pillows/cushions)",
            "Perturbation training"
        ],
        "Women‚Äôs Health (Antenatal/Postnatal)": [
            "One or Combinations of:",
            "Pelvic Floor Muscle Training (Kegels)",
            "Diastasis Recti assessment and correction",
            "Core engagement",
            "Posture correction for breastfeeding",
            "Back care education"
        ],
        "Women‚Äôs Health (Antenatal)": [
            "One or Combinations of:",
            "Pelvic Floor Muscle Training (Kegels)",
            "Diastasis Recti assessment and correction",
            "Core engagement",
            "Posture correction for breastfeeding",
            "Back care education"
        ],
        "Women‚Äôs Health (Postnatal)": [
            "One or Combinations of:",
            "Pelvic Floor Muscle Training (Kegels)",
            "Diastasis Recti assessment and correction",
            "Core engagement",
            "Posture correction for breastfeeding",
            "Back care education"
        ],
        "Work-From-Home (Ergonomic) Care": [
            "One or Combinations of:",
            "Workstation Assessment (Chair/Desk height advice)",
            "Neck/Upper Trap Release",
            "Postural resetting exercises",
            "'Desk-Yoga' stretches"
        ],        
        "Bedridden and Palliative Care": [
            "One or Combinations of:",
            "Passive movements for comfort",
            "Positioning for pressure sore prevention",
            "Gentle massage for circulation",
            "Chest clearance positioning"
        ],
		"Bedridden": [
            "One or Combinations of:",
            "Passive movements for comfort",
            "Positioning for pressure sore prevention",
            "Gentle massage for circulation",
            "Chest clearance positioning"
        ],
        "Palliative Care": [
            "One or Combinations of:",
            "Passive movements for comfort",
            "Positioning for pressure sore prevention",
            "Gentle massage for circulation",
            "Chest clearance positioning"
        ],
        "Fall Proof Pack": [
            "Home Hazard Assessment (identifying rugs/cords)",
            "Balance & Coordination training",
            "Lower Limb Strengthening",
            "Focus: Senior Safety"
        ],
        "Chest & Lungs": [
            "Spirometry Coaching (device by client)",
            "Deep breathing exercises",
            "Thoracic expansion exercises",
            "Fatigue management",
            "Focus: Post-flu/Post-infection recovery"
        ],
		"Chest & Lungs (Post-Viral Pack)": [
            "Spirometry Coaching (device by client)",
            "Deep breathing exercises",
            "Thoracic expansion exercises",
            "Fatigue management",
            "Focus: Post-flu/Post-infection recovery"
        ],
        "Post-Viral Pack": [
            "Spirometry Coaching (device by client)",
            "Deep breathing exercises",
            "Thoracic expansion exercises",
            "Fatigue management",
            "Focus: Post-flu/Post-infection recovery"
        ],
        "Total Spine Pack": [
            "Manual traction (manual handling only)",
            "Spinal mobilization",
            "Core stabilization exercises",
            "Hamstring/Hip Flexor stretching",
            "Focus: Chronic Back/Neck Pain"
        ],
        "Walk Again Pack (Intensive)": [
            "Weight shifting drills",
            "Standing tolerance building",
            "Gait pattern correction",
            "Outdoor terrain negotiation (if safe)",
            "Focus: Returning to independence"
        ]
    }

    # --- 2. DEFINE MAPPINGS FOR A-LA-CARTE ---
    # ‚≠ê CHANGE: VALUES ARE NOW LISTS OF STRINGS
    ALACARTE_DETAILS = {
        "Hospital Visits (Assistance with Family)": [            
            "Pick-up from residence",
            "Management of hospital files/registration papers",
            "Wheelchair assistance within hospital premises",
            "Wait-time companionship",
            "Drop-back to residence"
        ],
		"Hospital Visits ((Care Coordination))": [            
            "Pick-up from residence",
            "Management of hospital files/registration papers",
            "Wheelchair assistance within hospital premises",
            "Wait-time companionship",
            "Drop-back to residence"
        ],
        "Doctor Visits (Home)": [
            "General physical assessment (BP, Pulse, Chest Auscultation)",
            "Medication review (de-prescribing)",
            "Written prescription generation"
        ],
        "Diagnostic Services": [
            "Hygiene protocol adherence (gloves/sanitization)",
            "Sample collection (vacutainer method)",
            "Labeling sample in front of patient",
            "Digital report delivery coordination"
        ],
        "Blood Collection": [
            "Hygiene protocol adherence (gloves/sanitization)",
            "Sample collection (vacutainer method)",
            "Labeling sample in front of patient",
            "Digital report delivery coordination"
        ],
        "Nutrition Consultation (Home Visit)": [
            "Body Composition Analysis",
            "Kitchen Audit (checking oil/salt/pantry staples)",
            "Customized diet chart generation based on home cooking style"
        ],
        "Dietetic Consultation (Home Visit)": [
            "Body Composition Analysis",
            "Kitchen Audit (checking oil/salt/pantry staples)",
            "Customized diet chart generation based on home cooking style"
        ],
        "Hospital Discharge Pack": [
            "Ambulance Pickup",
            "Medical Equipment Rental (Bed/Oxygen)",
            "1 Nurse Visit for Room Setup & Vitals Check"
        ],
        "Dialysis Assistance (Escort)": [
            "Assisting patient down stairs/lift",
            "Transport coordination",
            "Post-dialysis snack assistance",
            "Monitoring for BP drops during return journey"
        ],
        "Quarterly Senior Wellness Pack": [
            "1 Doctor Visit",
            "Full Body Blood Profile",
            "1 Nutrition Consultation",
            "1 Fall Prevention Audit"
        ],
        "Ambulance Services": [
            "Coordination of BLS/ACLS ambulance",
            "Transfer of patient from bed to stretcher (Bed-to-Bed service)",
            "Vitals monitoring during transit"
        ],
        "Medical Equipment Rental": [
            "Delivery logistics",
            "On-site demonstration of usage",
            "Collection of security deposit",
            "Rental agreement signing"
        ],
        "ECG (Portable)": [
            "Lead placement on chest/limbs",
            "Recording of trace",
            "Digital forwarding of graph to Cardiologist for reporting"
        ],
        "X-Ray (Portable)": [
            "Setup of portable machine at bedside",
            "Safety shielding for family members",
            "Immediate film/digital transfer"
        ],
        "Critical Care Setup (ICU at Home)": [
            "Installation of Monitor/Ventilator/Suction",
            "24/7 Nurse Roster management",
            "Daily reporting to treating consultant"
        ]
    }

    # --- 3. STANDARD PLANS MAPPING ---
    SERVICES_MASTER = {
        "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
        "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
        "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
        "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
        "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
        "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
        "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
    }

    STANDARD_PLANS = list(SERVICES_MASTER.keys())[:5]

    # --- 4. LOGIC TO SELECT LIST ---
    
    # 4A. Check for PLAN F Specifics
    if "Plan F" in selected_plan:
        sub_check = str(selected_sub_service).strip()
        # Search for keyword in map keys
        for key, desc in PLAN_F_DETAILS.items():
            if key.lower() in sub_check.lower():
                # ‚≠ê CRITICAL FIX: Removed brackets [] around desc
                return desc, [] 
        # Fallback if no specific sub-service matched in map
        return ["Rehabilitative Care Assessment and Therapy Session"], []

    # 4B. Check for A-LA-CARTE Specifics
    elif "A-la-carte" in selected_plan or "Other Service" in selected_plan:
        sub_check = str(selected_sub_service).strip()
        for key, desc in ALACARTE_DETAILS.items():
            if key.lower() in sub_check.lower():
                # ‚≠ê CRITICAL FIX: Removed brackets [] around desc
                return desc, [] 
        return [f"Service: {sub_check}"], []

    # 4C. Standard Logic for Plans A-E
    base_plan = selected_plan
    if selected_plan not in SERVICES_MASTER:
        for k in SERVICES_MASTER.keys():
            if k in selected_plan:
                base_plan = k
                break

    master_list = SERVICES_MASTER.get(base_plan, [])
    
    if "All" in str(selected_sub_service) and base_plan in STANDARD_PLANS:
        included_raw = [s for s in master_list if s.lower() != "all"]
    else: 
        included_raw = [x.strip() for x in str(selected_sub_service).split(',')]
    
    included_clean = sorted(list(set([clean_text(s) for s in included_raw if clean_text(s)])))
    not_included_clean = []
    
    if base_plan in STANDARD_PLANS:
        for plan_name in STANDARD_PLANS:
            if plan_name == base_plan: continue 
            
            # ‚≠ê LOGIC UPDATE: If Plan D is selected, DO NOT include Plan E in the exclusion list
            if "Plan D" in base_plan and "Plan E" in plan_name:
                continue

            for item in SERVICES_MASTER.get(plan_name, []):
                if item.lower() == "all": continue
                cleaned = clean_text(item)
                if cleaned: not_included_clean.append(cleaned)
    else:
        for item in master_list:
            cleaned = clean_text(item)
            if cleaned and cleaned not in included_clean: not_included_clean.append(cleaned)
            
    return included_clean, list(set(not_included_clean))

# --- NEW HTML HELPERS ---
def construct_description_html(row):
    shift_raw = str(row.get('Shift', '')).strip()
    recurring = str(row.get('Recurring Service', '')).strip().lower()
    period_raw = str(row.get('Period', '')).strip()
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_str = shift_map.get(shift_raw, shift_raw)
    time_suffix = " (Time)" if "12" in shift_str else ""
    return f"""<div style="margin-top: 4px;"><div style="font-size: 12px; color: #4a4a4a; font-weight: bold;">{shift_str}{time_suffix}</div><div style="font-size: 10px; color: #777; font-style: italic; margin-top: 2px;">{period_raw}</div></div>"""

def construct_amount_html(row, billing_qty):
    try: unit_rate = float(row.get('Unit Rate', 0)) 
    except: 
        try: unit_rate = float(row.get('Amount', 0))
        except: unit_rate = 0.0
        
    try: visits_needed = int(float(row.get('Visits', 0)))
    except: visits_needed = 0
    
    # --- 1. DEFINE DETAILS TEXT (Fixes NameError) ---
    p_raw_check = str(row.get('Period', '')).strip()
    p_check_lower = p_raw_check.lower()
    shift_raw_check = str(row.get('Shift', '')).strip()
    shift_check_lower = shift_raw_check.lower()
    
    details_text = ""
    
    if "per visit" in shift_check_lower:
        if billing_qty == 1: details_text = f"Paid for {billing_qty} Visit"
        else: details_text = f"Paid for {billing_qty} Visits"
    
    elif "daily" in p_check_lower:
        if billing_qty == 1:
            details_text = f"Paid for {billing_qty} Day"
        elif billing_qty % 7 == 0:
            weeks_val = int(billing_qty / 7)
            if weeks_val == 1: details_text = f"Paid for {weeks_val} Week"
            else: details_text = f"Paid for {weeks_val} Weeks"
        else:
            details_text = f"Paid for {billing_qty} Days"
            
    elif "monthly" in p_check_lower:
        if billing_qty == 1: details_text = f"Paid for {billing_qty} Month"
        else: details_text = f"Paid for {billing_qty} Months"
        
    elif "weekly" in p_check_lower:
        if billing_qty == 1: details_text = f"Paid for {billing_qty} Week"
        else: details_text = f"Paid for {billing_qty} Weeks"
        
    else:
        details_text = f"Paid for {billing_qty} {p_raw_check}"

    # --- 2. BILLING NOTE LOGIC ---
    billing_note = ""
    is_per_visit = "per visit" in shift_check_lower
    
    if is_per_visit:
        if visits_needed > 1 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif billing_qty >= visits_needed: billing_note = f"Paid for {visits_needed} Visits."
        elif visits_needed == 1: billing_note = "Paid for 1 Visit."
        elif billing_qty < visits_needed: billing_note = f"Next Bill will be Generated after {billing_qty} Visits."
        else: billing_note = details_text
        
    elif "month" in p_check_lower or "week" in p_check_lower:
        base_unit = "Month" if "month" in p_check_lower else "Week"
        plural_unit = base_unit + "s" if billing_qty > 1 else base_unit
        
        if visits_needed > 1 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif visits_needed > billing_qty: billing_note = f"Next Bill will be Generated after {billing_qty} {plural_unit}."
        else: billing_note = details_text
        
    elif "daily" in p_check_lower:
        if 1 < visits_needed < 6 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif billing_qty >= visits_needed: billing_note = f"Paid for {visits_needed} Days."
        elif visits_needed == 1: billing_note = "Paid for 1 Day."
        elif billing_qty < visits_needed: billing_note = f"Next Bill will be Generated after {billing_qty} Days."
        else: billing_note = details_text

    total_amount = unit_rate * billing_qty
    
    # --- 3. SHIFT & PERIOD DISPLAY LOGIC ---
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_display = shift_map.get(shift_raw_check, shift_raw_check)
    if "12" in shift_display and "Time" not in shift_display: shift_display += " (Time)"
    
    # Logic: Monthly -> Month, Weekly -> Week, Daily -> Day
    period_display = p_raw_check # Default fallback
    if "month" in p_check_lower: period_display = "Month"
    elif "week" in p_check_lower: period_display = "Week"
    elif "daily" in p_check_lower: period_display = "Day"
    
    # Remove "Visit" from period display if it's per visit (handled in rate_line_html below)
    
    unit_rate_str = "{:,.0f}".format(unit_rate)
    total_amount_str = "{:,.0f}".format(total_amount)
    
    # --- 4. RATE LINE FORMATTING (Per Visit Logic) ---
    if is_per_visit:
        # RESULT: Per Visit = ‚Çπ 900
        rate_line_html = f"{shift_display} = <b>‚Çπ {unit_rate_str}</b>"
    else:
        # RESULT: 12 Hours.. / Month = ‚Çπ 30,000
        rate_line_html = f"{shift_display} / {period_display} = <b>‚Çπ {unit_rate_str}</b>"

    # --- 5. CHECK FOR OVERRIDE FROM TAB 2 ---
    if 'Details_Override' in row:
        paid_for_text = row['Details_Override']
    else:
        paid_for_text = details_text

    return f"""
    <div style="text-align: right; font-size: 13px; color: #555;">
        <div style="margin-bottom: 4px;">{rate_line_html}</div>
        <div style="color: #CC4E00; font-weight: bold; font-size: 14px; margin: 2px 0;">X</div>
        <div style="font-weight: bold; font-size: 13px; margin: 2px 0; color: #333;">{paid_for_text}</div>
        <div style="border-bottom: 1px solid #ccc; width: 100%; margin: 6px 0;"></div>
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px;">
            <span style="font-size: 13px; font-weight: 800; color: #002147; text-transform: uppercase;">TOTAL - </span>
            <span style="font-size: 16px; font-weight: bold; color: #000;">Rs. {total_amount_str}</span>
        </div>
        <div style="font-size: 10px; color: #666; font-style: italic; margin-top: 6px;">{billing_note}</div>
    </div>
    """

# ==========================================
# FUNCTION 5: KEEP YOUR EXISTING convert_html_to_pdf()
# ==========================================
def convert_html_to_pdf(source_html):
    """
    Converts HTML to PDF using xhtml2pdf.
    NOTE: This function is now a FALLBACK for compatibility.
    """
    result = BytesIO()
    pisa_status = pisa.CreatePDF(source_html, dest=result)
    if pisa_status.err: 
        return None
    return result.getvalue()

def normalize_columns(df, aliases):
    df.columns = df.columns.astype(str).str.strip()
    for standard_name, possible_aliases in aliases.items():
        if standard_name in df.columns: continue 
        for alias in possible_aliases:
            for df_col in df.columns:
                if df_col.lower() == alias.lower():
                    df.rename(columns={df_col: standard_name}, inplace=True); break 
    return df

COLUMN_ALIASES = {
    'Serial No.': ['Serial No.', 'serial no', 'sr no', 'sr. no.', 'id'],
    'Ref. No.': ['Ref. No.', 'ref no', 'ref. no.', 'reference no', 'reference number'],
    'Name': ['Name', 'name', 'patient name', 'client name'],
    'Mobile': ['Mobile', 'mobile', 'phone', 'contact'],
    'Location': ['Location', 'location', 'city'], 
    'Address': ['Address', 'address', 'residence'],
    'Gender': ['Gender', 'gender', 'sex'],
    'Age': ['Age', 'age'],
    'Service Required': ['Service Required', 'service required', 'plan'],
    'Sub Service': ['Sub Service', 'sub service', 'sub plan'],
    'Final Rate': ['Final Rate', 'final rate', 'amount', 'total amount'],
    'Unit Rate': ['Rate Agreed (‚Çπ)', 'rate agreed', 'unit rate', 'per day rate'],
    'Call Date': ['Call Date', 'call date', 'date'],
    'Notes': ['Notes / Remarks', 'notes', 'remark'],
    'Shift': ['Shift', 'shift'],
    'Recurring Service': ['Recurring Service', 'recurring', 'recurring service'],
    'Period': ['Period', 'period'],
    'Visits': ['Visits', 'visits', 'visit', 'vists'],
    'Referral Code': ['Referral Code', 'referral code', 'ref code'],
    'Referral Name': ['Referral Name', 'referral name', 'ref name'],
    'Referral Credit': ['Referral Credit', 'referral credit', 'ref credit']
}

# --- DATABASE HELPERS ---
def save_invoice_to_gsheet(data_dict, sheet_obj):
    if sheet_obj is None: return False
    try:
        all_vals = sheet_obj.get_all_values()
        next_row_num = len(all_vals) + 1
        
        existing_uids = []
        for r in all_vals[1:]: 
            if r[0] and r[0].isdigit(): existing_uids.append(int(r[0]))
        
        if existing_uids: new_uid = max(existing_uids) + 1
        else: new_uid = 1
        final_uid = f"{new_uid:04d}"

        formula_net_amount = f"=U{next_row_num}-AA{next_row_num}"
        formula_earnings = f"=AB{next_row_num}-(AC{next_row_num}*AD{next_row_num})"
        
        qty_extracted = data_dict.get("Paid for Raw", 1)
        
        # ‚≠ê CRITICAL CHANGE HERE: SWAPPED Referral Code and Name
        row_values = [
            final_uid,
            data_dict.get("Serial No.", ""),
            data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""),
            data_dict.get("Date", ""),
            data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""),
            data_dict.get("Age", ""),
            data_dict.get("Gender", ""),
            data_dict.get("Location", ""),
            data_dict.get("Address", ""),
            data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""),
            data_dict.get("Shift", ""),
            data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""),
            data_dict.get("Visits", ""),
            data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""),
            data_dict.get("Generated By", ""),
            data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""),
            data_dict.get("Service Started", ""),
            data_dict.get("Service Ended", ""),
            data_dict.get("Referral Code", ""), # ‚≠ê SWAPPED: Code is now in Name col (index 24)
            data_dict.get("Referral Name", ""), # ‚≠ê SWAPPED: Name is now in Code col (index 25)
            data_dict.get("Referral Credit", ""),
            formula_net_amount,
            "",
            qty_extracted,
            formula_earnings,
            "",
            "",
            ""
        ]
        sheet_obj.append_row(row_values, value_input_option='USER_ENTERED')
        return True
    except Exception as e: st.error(f"Save Error: {e}"); return False

# ‚≠ê CHANGE #7: NEW FUNCTION - update_invoice_in_gsheet()
def update_invoice_in_gsheet(data_dict, sheet_obj, row_idx):
    """
    Updates an existing row in the Google Sheet instead of appending.
    Only updates columns B through X (customer data).
    CRITICAL FIX: Skips Column A (UID) entirely to prevent erasing it.
    """
    if sheet_obj is None: return False
    try:
        # We start from Column B (Serial No.) so we don't overwrite UID (Col A)
        row_values = [
            # data_dict.get("UID", ""),  <-- SKIPPED to preserve existing UID
            data_dict.get("Serial No.", ""), 
            data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""),
            data_dict.get("Date", ""),
            data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""),
            data_dict.get("Age", ""),
            data_dict.get("Gender", ""),
            data_dict.get("Location", ""),
            data_dict.get("Address", ""),
            data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""),
            data_dict.get("Shift", ""),
            data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""),
            data_dict.get("Visits", ""),
            data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""),
            data_dict.get("Generated By", ""),
            data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""),
            data_dict.get("Service Started", ""),
            data_dict.get("Service Ended", "")
        ]
        
        # Update Range B{row}:X{row} instead of A{row}:X{row}
        range_name = f"B{row_idx}:X{row_idx}"
        sheet_obj.update(range_name, [row_values], value_input_option='USER_ENTERED')
        
        # Update Referral Info (Columns Y, Z, AA)
        ref_values = [[
            data_dict.get("Referral Code", ""), 
            data_dict.get("Referral Name", ""), 
            data_dict.get("Referral Credit", "")
        ]]
        sheet_obj.update(f"Y{row_idx}:AA{row_idx}", ref_values, value_input_option='USER_ENTERED')

        # Update Paid Raw (Column AD)
        qty_extracted = data_dict.get("Paid for Raw", 1)
        sheet_obj.update(f"AD{row_idx}", [[qty_extracted]], value_input_option='USER_ENTERED')

        return True
    except Exception as e: st.error(f"Update Error: {e}"); return False

# Update the Nurse Management Helper (to be safe)
def update_nurse_management(sheet_obj, invoice_number, payment_amount, nurse_name, nurse_extra, nurse_note):
    if sheet_obj is None: return False
    try:
        # Find the row by Invoice Number
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            row_idx = cell.row
            
            # 1. Fetch 'Details' (Col V / Index 22) to recalculate 'Paid for' qty
            # This ensures the earnings formula works correctly
            details_val = sheet_obj.cell(row_idx, 22).value
            qty = 1
            if details_val:
                match = re.search(r'Paid for\s*:?\s*(\d+)', str(details_val), re.IGNORECASE)
                if match: qty = int(match.group(1))
            
            # 2. Earnings Formula (Col AE / Index 31)
            # Formula: =Net_Amount(AB) - (Nurse_Pay(AC) * Qty(AD))
            formula_string = f"=AB{row_idx}-(AC{row_idx}*AD{row_idx})"
            
            # 3. Update Block AC:AH (6 Columns)
            # AC=Payment, AD=Qty, AE=Earnings, AF=Name, AG=Extra, AH=Note
            range_update = f"AC{row_idx}:AH{row_idx}"
            values = [[payment_amount, qty, formula_string, nurse_name, nurse_extra, nurse_note]]
            
            sheet_obj.update(range_update, values, value_input_option='USER_ENTERED')
            return True
        return False
    except Exception as e: st.error(f"Nurse Update Error: {e}"); return False

def mark_service_ended(sheet_obj, invoice_number, end_date):
    if sheet_obj is None: return False, "No Sheet"
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            end_time_str = format_date_simple(end_date)
            range_name = f"X{cell.row}"
            sheet_obj.update(range_name, [[end_time_str]])
            return True, end_time_str
        return False, "Invoice not found"
    except Exception as e: return False, str(e)

def get_clean_image_base64(file_path):
    if not os.path.exists(file_path): return None
    try:
        img = Image.open(file_path).convert("RGBA")
        buffer = BytesIO()
        img.save(buffer, format="PNG", optimize=True)
        return base64.b64encode(buffer.getvalue()).decode('utf-8')
    except: return None

def get_absolute_path(filename):
    if os.path.exists(filename): return os.path.abspath(filename).replace('\\', '/')
    return None

# ==========================================
# BACKUP LOGIC
# ==========================================
def perform_backup_logic(master_data, backup_url, target_month_str):
    client = get_gspread_client()
    backup_id = extract_id_from_url(backup_url)
    if not backup_id or not client: return False, "Invalid Backup Configuration."
    try:
        backup_wb = client.open_by_key(backup_id)
        try:
            target_ws = backup_wb.worksheet(target_month_str)
            return False, f"Backup for {target_month_str} already exists. Skipping to prevent overwrite."
        except gspread.exceptions.WorksheetNotFound: pass

        try:
            default_ws = backup_wb.worksheet("Sheet1")
            default_ws.update_title(target_month_str)
            target_ws = default_ws
        except gspread.exceptions.WorksheetNotFound:
            target_ws = backup_wb.add_worksheet(title=target_month_str, rows=1000, cols=34)

        target_ws.clear()
        target_ws.update(range_name="A1", values=master_data, value_input_option='USER_ENTERED')
        try: target_ws.format("A1:AH1", {"textFormat": {"bold": True}, "backgroundColor": {"red": 0.8, "green": 0.8, "blue": 0.8}})
        except: pass
        return True, f"‚úÖ Success! Data backed up to sheet '{target_month_str}' in Backup Workbook."
    except Exception as e: return False, f"Backup Failed: {str(e)}"

# ==========================================
# UI & MAIN LOGIC
# ==========================================
st.title("üè• Vesak Care - Invoice Generator")

abs_logo_path = get_absolute_path(LOGO_FILE)
logo_b64 = get_clean_image_base64(LOGO_FILE)

# --- SIDEBAR CONFIGURATION ---
with st.sidebar:
    with st.expander("‚öôÔ∏è System Configuration", expanded=True):
        st.write("Enter Google Sheet Links:")
        m_link = st.text_input("Master Workbook Link (Active):", value=sys_config.get("master_sheet_url", ""))
        b_link = st.text_input("Backup Workbook Link (Archive):", value=sys_config.get("backup_sheet_url", ""))
        
        if st.button("üíæ Save Settings"):
            new_conf = { "master_sheet_url": m_link, "backup_sheet_url": b_link }
            save_system_config(new_conf)
            st.success("Settings Saved!")
            st.rerun()

    st.header("üóÑÔ∏è Backup Manager")
    backup_date = datetime.date.today()
    backup_month_str = backup_date.strftime("%b-%y") 
    st.info(f"Current Period: **{backup_month_str}**")
    
    if st.button("üöÄ Run Monthly Backup Now"):
        if not sys_config["master_sheet_url"] or not sys_config["backup_sheet_url"]:
            st.error("Please configure Master and Backup links first.")
        else:
            client = get_gspread_client()
            master_id = extract_id_from_url(sys_config["master_sheet_url"])
            try:
                wb_master = client.open_by_key(master_id)
                ws_master = wb_master.worksheet(backup_month_str) 
                data_to_copy = ws_master.get_all_values()
                if not data_to_copy: st.warning("Master sheet is empty.")
                else:
                    status, msg = perform_backup_logic(data_to_copy, sys_config["backup_sheet_url"], backup_month_str)
                    if status: st.success(msg)
                    else: st.warning(msg)
            except Exception as e: st.error(f"Could not read Master Workbook: {e}")

    
    data_source = st.radio("Load Customer Data via:", ["Upload File", "OneDrive Link"])
    if st.button("üîÑ Refresh"): st.cache_data.clear(); st.rerun()

# --- LOAD INPUT FILE ---
raw_file_obj = None
if data_source == "Upload File":
    uploaded_file = st.sidebar.file_uploader("Upload Excel/CSV", type=['xlsx', 'csv'])
    if uploaded_file: raw_file_obj = uploaded_file
elif data_source == "OneDrive Link":
    current_url = load_config_path(URL_CONFIG_FILE)
    url_input = st.sidebar.text_input("Paste Link:", value=current_url)
    if st.sidebar.button("Load"): save_config_path(url_input, URL_CONFIG_FILE); st.rerun()
    if current_url: raw_file_obj = robust_file_downloader(current_url)

# --- MAIN TABS ---
						   
tab1, tab2, tab3, tab4, tab5, = st.tabs([
    "üßæ Generate Invoice", 
    "¬©Ô∏è Duplicate Invoice", 
    "üõ† Manage Services", 
    "üí∞ Nurse Manage",
    "üìù Create Agreements"
])

# ==========================================
# üèõÔ∏è AGREEMENT LOGIC & TRANSLATIONS (THE BRAIN)
# ==========================================

# 1. TRANSLATION DICTIONARY (Legal Terminology)
AGREEMENT_I18N = {
    "English": {
        "title": "CAREGIVER SERVICE RETAINER AGREEMENT",
        "subtitle": "AGREEMENT OF SERVICE & CODE OF CONDUCT",
        "agreement_made": "THIS AGREEMENT is made at",
        "on_date": "on this",
        "between": "BETWEEN",
        "and": "AND",
        "agency_desc": "Vesak Care Foundation, a Foundation Company having its registered office at Kolhapur (hereinafter referred to as the \"AGENCY\", which expression shall, unless repugnant to the context, include its successors and assigns).",
        "retainer_def": "hereinafter referred to as the",
        "whereas": "WHEREAS:",
        "whereas_a": "A. The Agency is engaged in the business of providing professional Patient Care and Home Health services.",
        "whereas_b": "B. The Retainer has represented to the Agency that they possess the required skills, training, and physical fitness to provide such services and has applied to be empanelled with the Agency.",
        "agreed": "NOW, THEREFORE, IT IS AGREED AS FOLLOWS:",
        "sec_1": "1. NATURE OF ENGAGEMENT",
        "sec_1_1": "The Retainer is engaged as a Professional Retainer on a contract basis and not as a permanent employee.",
        "sec_1_2": "The Retainer understands that the Agency acts as a facilitator between the Patient and the Retainer.",
        "sec_2": "2. SCOPE OF DUTIES (STRICT COMPLIANCE)",
        "sec_2_intro": "The Retainer agrees to perform ONLY the following duties:",
        "sec_2_1": "2.1 EXCLUSION CLAUSE (NON-DOMESTIC POLICY):",
        "sec_2_1_text": "The Retainer explicitly agrees that they are NOT a Domestic Helper (Maid). The Retainer shall politely but firmly REFUSE to:",
        "refuse_list": ["Wash utensils or clothes for the family.", "Sweep or mop the floor (except immediate accidental spillage by patient).", "Cook food for the family.", "Perform any task not related to the patient‚Äôs health."],
        "sec_3": "3. ANTI-POACHING & NON-SOLICITATION (ZERO TOLERANCE)",
        "sec_3_1": "3.1 The Restriction: The Caregiver acknowledges that the Client/Patient has been introduced solely through the efforts and investment of the Agency.",
        "sec_3_2": "3.2 Prohibition: The Caregiver agrees that during the tenure of this agreement and for a period of 24 Months after leaving the Agency, they shall NOT:",
        "prohibit_list": ["Accept direct employment from any Client introduced by the Agency.", "Approach the Client to offer services at a lower rate by bypassing the Agency‚Äôs commission.", "Accept 'Private Duty' or 'Cash' from the Client without informing the Agency."],
        "sec_3_3": "3.3 Consequence of Breach: If the Caregiver is found violating this clause:",
        "breach_list": ["Blacklisting: The Caregiver will be permanently blacklisted and reported to the Maharashtra Home Healthcare Association.", "Forfeiture: The Agency shall forfeit all pending dues, salary, and security deposits immediately.", "Damages: The Agency reserves the right to claim damages for loss of business."],
        "sec_4": "4. CODE OF CONDUCT & DISCIPLINE",
        "sec_4_1": "4.1. Uniform: The Caregiver must wear the designated Uniform and ID Card while on duty.",
        "sec_4_2": "4.2. Mobile Usage: Use of mobile phones for social media (Reels/YouTube) or video calls during duty hours is Strictly Prohibited.",
        "sec_4_3": "4.3. Substance Abuse: Consumption of Alcohol, Tobacco, Gutka, or Drugs on duty will lead to Immediate Termination.",
        "sec_4_4": "4.4. Financial Integrity: The Caregiver shall not borrow money from the Client nor ask for tips/gifts.",
        "sec_5": "5. CRIMINAL LIABILITY & STATUTORY LAWS",
        "sec_5_text": "The Caregiver is aware of the laws of the land:",
        "sec_5_1": "5.1. Theft: Any act of stealing (cash, jewelry, medicines) will be prosecuted under Section 381 of the Indian Penal Code (Theft by Clerk or Servant) which carries a punishment of imprisonment up to 7 Years.",
        "sec_5_2": "5.2. Elder Abuse: Any negligence or abuse of a Senior Citizen is a punishable offense under the Maintenance and Welfare of Parents and Senior Citizens Act, 2007.",
        "sec_6": "6. TERMINATION & NOTICE PERIOD",
        "sec_6_1": "6.1. The Caregiver must provide 30 Days written notice before resigning.",
        "sec_6_2": "6.2. Patient Abandonment: Leaving the patient unattended mid-shift or absconding without notice is a critical safety violation. In such cases, the Agency will forfeit all dues and may pursue legal action for negligence.",
        "sec_7": "7. INDEMNITY",
        "sec_7_text": "The Caregiver agrees to indemnify the Agency against any legal action, claims, or damages arising out of the Caregiver‚Äôs own negligence, criminal conduct, or failure to follow medical instructions.",
        "sec_8": "8. JURISDICTION",
        "sec_8_text": "All disputes arising out of this agreement are subject to the exclusive jurisdiction of the Courts in",
        "witness": "IN WITNESS WHEREOF, the parties have signed this Agreement.",
        "sign_caregiver": "SIGNATURE OF CAREGIVER",
        "sign_auth": "AUTHORIZED SIGNATORY"
    },
    "Hindi": {
        "title": "‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß (Caregiver Retainer Agreement)",
        "subtitle": "‡§∏‡•á‡§µ‡§æ ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß ‡§î‡§∞ ‡§Ü‡§ö‡§∞‡§£ ‡§∏‡§Ç‡§π‡§ø‡§§‡§æ",
        "agreement_made": "‡§Ø‡§π ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß",
        "on_date": "‡§ï‡•ã",
        "between": "‡§Æ‡§ß‡•ç‡§Ø",
        "and": "‡§î‡§∞",
        "agency_desc": "‡§µ‡•á‡§∏‡§æ‡§ï ‡§ï‡•á‡§Ø‡§∞ ‡§´‡§æ‡§â‡§Ç‡§°‡•á‡§∂‡§®, ‡§ï‡•ã‡§≤‡•ç‡§π‡§æ‡§™‡•Å‡§∞ ‡§Æ‡•á‡§Ç ‡§™‡§Ç‡§ú‡•Ä‡§ï‡•É‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§µ‡§æ‡§≤‡•Ä ‡§è‡§ï ‡§´‡§æ‡§â‡§Ç‡§°‡•á‡§∂‡§® ‡§ï‡§Ç‡§™‡§®‡•Ä (‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ \"‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä\" ‡§ï‡§π‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ)‡•§",
        "retainer_def": "(‡§á‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ \"‡§∞‡§ø‡§ü‡•á‡§®‡§∞\" ‡§ï‡§π‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ)",
        "whereas": "‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§®‡§æ:",
        "whereas_a": "A. ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§™‡•á‡§∂‡•á‡§µ‡§∞ ‡§∞‡•ã‡§ó‡•Ä ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§î‡§∞ ‡§ò‡§∞‡•á‡§≤‡•Ç ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø ‡§Æ‡•á‡§Ç ‡§≤‡§ó‡•Ä ‡§π‡•Å‡§à ‡§π‡•à‡•§",
        "whereas_b": "B. ‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§®‡•á ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§ï‡•ã ‡§Ø‡§π ‡§¨‡§§‡§æ‡§Ø‡§æ ‡§π‡•à ‡§ï‡§ø ‡§â‡§®‡§ï‡•á ‡§™‡§æ‡§∏ ‡§ê‡§∏‡•Ä ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•å‡§∂‡§≤, ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§î‡§∞ ‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï ‡§´‡§ø‡§ü‡§®‡•á‡§∏ ‡§π‡•à‡•§",
        "agreed": "‡§Ö‡§¨, ‡§á‡§∏‡§≤‡§ø‡§è, ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§™‡§∞ ‡§∏‡§π‡§Æ‡§§‡§ø ‡§π‡•à:",
        "sec_1": "1. ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§‡§ø ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•É‡§§‡§ø",
        "sec_1_1": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§ï‡•ã ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ '‡§™‡•ç‡§∞‡•ã‡§´‡•á‡§∂‡§®‡§≤ ‡§∞‡§ø‡§ü‡•á‡§®‡§∞' ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à, ‡§® ‡§ï‡§ø ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç‡•§",
        "sec_1_2": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§∏‡§Æ‡§ù‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§∞‡•ã‡§ó‡•Ä ‡§î‡§∞ ‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§¨‡•Ä‡§ö ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ (Facilitator) ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡•§",
        "sec_2": "2. ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§¶‡§æ‡§Ø‡§∞‡§æ (‡§∏‡§ñ‡•ç‡§§ ‡§Ö‡§®‡•Å‡§™‡§æ‡§≤‡§®)",
        "sec_2_intro": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§ï‡•á‡§µ‡§≤ ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§®‡§ø‡§≠‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§π‡§Æ‡§§ ‡§π‡•à:",
        "sec_2_1": "2.1 ‡§Ö‡§™‡§µ‡§∞‡•ç‡§ú‡§® ‡§ñ‡§Ç‡§° (‡§ò‡§∞‡•á‡§≤‡•Ç ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç):",
        "sec_2_1_text": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§π‡§Æ‡§§ ‡§π‡•à ‡§ï‡§ø ‡§µ‡•á ‡§ò‡§∞‡•á‡§≤‡•Ç ‡§∏‡§π‡§æ‡§Ø‡§ï (‡§®‡•å‡§ï‡§∞‡§æ‡§®‡•Ä) ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§ ‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§µ‡§ø‡§®‡§Æ‡•ç‡§∞‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•á‡§ï‡§ø‡§® ‡§¶‡•É‡§¢‡§º‡§§‡§æ ‡§∏‡•á ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§∞‡§®‡•á ‡§∏‡•á ‡§Æ‡§®‡§æ ‡§ï‡§∞‡•á‡§ó‡§æ:",
        "refuse_list": ["‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§∞‡•ç‡§§‡§® ‡§Ø‡§æ ‡§ï‡§™‡§°‡§º‡•á ‡§ß‡•ã‡§®‡§æ‡•§", "‡§ù‡§æ‡§°‡§º‡•Ç ‡§Ø‡§æ ‡§™‡•ã‡§õ‡§æ ‡§≤‡§ó‡§æ‡§®‡§æ (‡§∞‡•ã‡§ó‡•Ä ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§Ü‡§ï‡§∏‡•ç‡§Æ‡§ø‡§ï ‡§ó‡§Ç‡§¶‡§ó‡•Ä ‡§ï‡•ã ‡§õ‡•ã‡§°‡§º‡§ï‡§∞)‡•§", "‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡§æ‡§®‡§æ ‡§¨‡§®‡§æ‡§®‡§æ‡•§", "‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ú‡•ã ‡§∞‡•ã‡§ó‡•Ä ‡§ï‡•á ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§"],
        "sec_3": "3. ‡§Ö‡§µ‡•à‡§ß ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§µ‡§ø‡§∞‡•ã‡§ß‡•Ä ‡§î‡§∞ ‡§ó‡•à‡§∞-‡§Ø‡§æ‡§ö‡§ø‡§ï‡§æ (‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§∏‡§π‡§ø‡§∑‡•ç‡§£‡•Å‡§§‡§æ)",
        "sec_3_1": "3.1 ‡§™‡•ç‡§∞‡§§‡§ø‡§¨‡§Ç‡§ß: ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï/‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§™‡§∞‡§ø‡§ö‡§Ø ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§ï‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏‡•ã‡§Ç ‡§î‡§∞ ‡§®‡§ø‡§µ‡•á‡§∂ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§",
        "sec_3_2": "3.2 ‡§®‡§ø‡§∑‡•á‡§ß: ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§∏‡§π‡§Æ‡§§ ‡§π‡•à ‡§ï‡§ø ‡§á‡§∏ ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§î‡§∞ ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§õ‡•ã‡§°‡§º‡§®‡•á ‡§ï‡•á 24 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§¨‡§æ‡§¶ ‡§§‡§ï, ‡§µ‡•á:",
        "prohibit_list": ["‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§™‡•á‡§∂ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•á ‡§∏‡•Ä‡§ß‡•á ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§", "‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§ï‡•á ‡§ï‡§Æ‡•Ä‡§∂‡§® ‡§ï‡•ã ‡§¶‡§∞‡§ï‡§ø‡§®‡§æ‡§∞ ‡§ï‡§∞‡§ï‡•á ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§ï‡•ã ‡§ï‡§Æ ‡§¶‡§∞ ‡§™‡§∞ ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•á‡§Ç‡§ó‡•á‡•§", "‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§ï‡•ã ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§ø‡§è ‡§¨‡§ø‡§®‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•á '‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§ü ‡§°‡•ç‡§Ø‡•Ç‡§ü‡•Ä' ‡§Ø‡§æ '‡§ï‡•à‡§∂' ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§"],
        "sec_3_3": "3.3 ‡§â‡§≤‡•ç‡§≤‡§Ç‡§ò‡§® ‡§ï‡§æ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ:",
        "breach_list": ["‡§¨‡•ç‡§≤‡•à‡§ï‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó: ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡•ç‡§≤‡•à‡§ï‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ ‡§î‡§∞ ‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞ ‡§π‡•ã‡§Æ ‡§π‡•á‡§≤‡•ç‡§•‡§ï‡•á‡§Ø‡§∞ ‡§è‡§∏‡•ã‡§∏‡§ø‡§è‡§∂‡§® ‡§ï‡•ã ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§", "‡§ú‡§¨‡•ç‡§§‡•Ä: ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§∏‡§≠‡•Ä ‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§¨‡§ï‡§æ‡§Ø‡§æ, ‡§µ‡•á‡§§‡§® ‡§î‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§ú‡§¨‡•ç‡§§ ‡§ï‡§∞ ‡§≤‡•á‡§ó‡•Ä‡•§", "‡§π‡§∞‡•ç‡§ú‡§æ‡§®‡§æ: ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§ï‡•á ‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§∞‡•ç‡§ú‡§æ‡§®‡§æ ‡§Æ‡§æ‡§Ç‡§ó‡§®‡•á ‡§ï‡§æ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ñ‡§§‡•Ä ‡§π‡•à‡•§"],
        "sec_4": "4. ‡§Ü‡§ö‡§∞‡§£ ‡§∏‡§Ç‡§π‡§ø‡§§‡§æ ‡§î‡§∞ ‡§Ö‡§®‡•Å‡§∂‡§æ‡§∏‡§®",
        "sec_4_1": "4.1. ‡§µ‡§∞‡•ç‡§¶‡•Ä: ‡§°‡•ç‡§Ø‡•Ç‡§ü‡•Ä ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§µ‡§∞‡•ç‡§¶‡•Ä ‡§î‡§∞ ‡§Ü‡§à‡§°‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§° ‡§™‡§π‡§®‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§",
        "sec_4_2": "4.2. ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó: ‡§°‡•ç‡§Ø‡•Ç‡§ü‡•Ä ‡§ï‡•á ‡§ò‡§Ç‡§ü‡•ã‡§Ç ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§∏‡•ã‡§∂‡§≤ ‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§æ (Reels/YouTube) ‡§Ø‡§æ ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡•â‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§´‡•ã‡§® ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§∏‡§ñ‡•ç‡§§ ‡§µ‡§∞‡•ç‡§ú‡§ø‡§§ ‡§π‡•à‡•§",
        "sec_4_3": "4.3. ‡§®‡§∂‡•Ä‡§≤‡•á ‡§™‡§¶‡§æ‡§∞‡•ç‡§•: ‡§°‡•ç‡§Ø‡•Ç‡§ü‡•Ä ‡§™‡§∞ ‡§∂‡§∞‡§æ‡§¨, ‡§§‡§Ç‡§¨‡§æ‡§ï‡•Ç, ‡§ó‡•Å‡§ü‡§ï‡§æ, ‡§Ø‡§æ ‡§°‡•ç‡§∞‡§ó‡•ç‡§∏ ‡§ï‡§æ ‡§∏‡•á‡§µ‡§® ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§¨‡§∞‡•ç‡§ñ‡§æ‡§∏‡•ç‡§§‡§ó‡•Ä ‡§π‡•ã‡§ó‡•Ä‡•§",
        "sec_4_4": "4.4. ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§Ö‡§ñ‡§Ç‡§°‡§§‡§æ: ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§∏‡•á ‡§™‡•à‡§∏‡•á ‡§â‡§ß‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡•á‡§ó‡§æ ‡§î‡§∞ ‡§® ‡§π‡•Ä ‡§∏‡•Å‡§ù‡§æ‡§µ/‡§â‡§™‡§π‡§æ‡§∞ ‡§Æ‡§æ‡§Ç‡§ó‡•á‡§ó‡§æ‡•§",
        "sec_5": "5. ‡§Ü‡§™‡§∞‡§æ‡§ß‡§ø‡§ï ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ ‡§î‡§∞ ‡§ï‡§æ‡§®‡•Ç‡§®",
        "sec_5_text": "‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡•á‡§∂ ‡§ï‡•á ‡§ï‡§æ‡§®‡•Ç‡§®‡•ã‡§Ç ‡§∏‡•á ‡§Ö‡§µ‡§ó‡§§ ‡§π‡•à:",
        "sec_5_1": "5.1. ‡§ö‡•ã‡§∞‡•Ä: ‡§ö‡•ã‡§∞‡•Ä (‡§®‡§ï‡§¶‡•Ä, ‡§ó‡§π‡§®‡•á, ‡§¶‡§µ‡§æ‡§è‡§Ç) ‡§ï‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ï‡•É‡§§‡•ç‡§Ø ‡§™‡§∞ ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§¶‡§Ç‡§° ‡§∏‡§Ç‡§π‡§ø‡§§‡§æ ‡§ï‡•Ä ‡§ß‡§æ‡§∞‡§æ 381 (‡§ï‡•ç‡§≤‡§∞‡•ç‡§ï ‡§Ø‡§æ ‡§®‡•å‡§ï‡§∞ ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ö‡•ã‡§∞‡•Ä) ‡§ï‡•á ‡§§‡§π‡§§ ‡§Æ‡•Å‡§ï‡§¶‡§Æ‡§æ ‡§ö‡§≤‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ, ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç 7 ‡§∏‡§æ‡§≤ ‡§§‡§ï ‡§ï‡•Ä ‡§ï‡•à‡§¶ ‡§ï‡•Ä ‡§∏‡§ú‡§æ ‡§π‡•à‡•§",
        "sec_5_2": "5.2. ‡§¨‡•Å‡§ú‡•Å‡§∞‡•ç‡§ó‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§¶‡•Å‡§∞‡•ç‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞: ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§µ‡§∞‡§ø‡§∑‡•ç‡§† ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï ‡§ï‡•Ä ‡§≤‡§æ‡§™‡§∞‡§µ‡§æ‡§π‡•Ä ‡§Ø‡§æ ‡§¶‡•Å‡§∞‡•ç‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞ '‡§Æ‡§æ‡§§‡§æ-‡§™‡§ø‡§§‡§æ ‡§î‡§∞ ‡§µ‡§∞‡§ø‡§∑‡•ç‡§† ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡•ã‡§Ç ‡§ï‡•á ‡§≠‡§∞‡§£-‡§™‡•ã‡§∑‡§£ ‡§î‡§∞ ‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§Ö‡§ß‡§ø‡§®‡§ø‡§Ø‡§Æ, 2007' ‡§ï‡•á ‡§§‡§π‡§§ ‡§¶‡§Ç‡§°‡§®‡•Ä‡§Ø ‡§Ö‡§™‡§∞‡§æ‡§ß ‡§π‡•à‡•§",
        "sec_6": "6. ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§î‡§∞ ‡§®‡•ã‡§ü‡§ø‡§∏ ‡§Ö‡§µ‡§ß‡§ø",
        "sec_6_1": "6.1. ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§á‡§∏‡•ç‡§§‡•Ä‡§´‡§æ ‡§¶‡•á‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§ï‡§æ ‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§®‡•ã‡§ü‡§ø‡§∏ ‡§¶‡•á‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§",
        "sec_6_2": "6.2. ‡§∞‡•ã‡§ó‡•Ä ‡§ï‡§æ ‡§™‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ‡§ó: ‡§∞‡•ã‡§ó‡•Ä ‡§ï‡•ã ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§õ‡•ã‡§°‡§º‡§ï‡§∞ ‡§ú‡§æ‡§®‡§æ ‡§è‡§ï ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§â‡§≤‡•ç‡§≤‡§Ç‡§ò‡§® ‡§π‡•à‡•§ ‡§ê‡§∏‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•ã‡§Ç ‡§Æ‡•á‡§Ç, ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§∏‡§≠‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§ú‡§¨‡•ç‡§§ ‡§ï‡§∞ ‡§≤‡•á‡§ó‡•Ä ‡§î‡§∞ ‡§≤‡§æ‡§™‡§∞‡§µ‡§æ‡§π‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§",
        "sec_7": "7. ‡§ï‡•ç‡§∑‡§§‡§ø‡§™‡•Ç‡§∞‡•ç‡§§‡§ø",
        "sec_7_text": "‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§≤‡§æ‡§™‡§∞‡§µ‡§æ‡§π‡•Ä ‡§Ø‡§æ ‡§Ü‡§™‡§∞‡§æ‡§ß‡§ø‡§ï ‡§Ü‡§ö‡§∞‡§£ ‡§∏‡•á ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ø‡§æ ‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡•á ‡§ñ‡§ø‡§≤‡§æ‡§´ ‡§è‡§ú‡•á‡§Ç‡§∏‡•Ä ‡§ï‡•Ä ‡§ï‡•ç‡§∑‡§§‡§ø‡§™‡•Ç‡§∞‡•ç‡§§‡§ø ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§π‡§Æ‡§§ ‡§π‡•à‡•§",
        "sec_8": "8. ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞",
        "sec_8_text": "‡§á‡§∏ ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß ‡§∏‡•á ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§π‡•ã‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§µ‡§æ‡§¶ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§®‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§≤‡§Ø‡•ã‡§Ç ‡§ï‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§æ‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§Ö‡§ß‡•Ä‡§® ‡§π‡•à‡§Ç:",
        "witness": "‡§∏‡§æ‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç, ‡§™‡§æ‡§∞‡•ç‡§ü‡§ø‡§Ø‡•ã‡§Ç ‡§®‡•á ‡§á‡§∏ ‡§Ö‡§®‡•Å‡§¨‡§Ç‡§ß ‡§™‡§∞ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞ ‡§ï‡§ø‡§è ‡§π‡•à‡§Ç‡•§",
        "sign_caregiver": "‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞",
        "sign_auth": "‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§π‡§∏‡•ç‡§§‡§æ‡§ï‡•ç‡§∑‡§∞‡§ï‡§∞‡•ç‡§§‡§æ"
    },
    "Marathi": {
        "title": "‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞ ‡§∏‡•á‡§µ‡§æ ‡§ï‡§∞‡§æ‡§∞ (Caregiver Retainer Agreement)",
        "subtitle": "‡§∏‡•á‡§µ‡§æ ‡§ï‡§∞‡§æ‡§∞ ‡§Ü‡§£‡§ø ‡§Ü‡§ö‡§æ‡§∞‡§∏‡§Ç‡§π‡§ø‡§§‡§æ",
        "agreement_made": "‡§π‡§æ ‡§ï‡§∞‡§æ‡§∞",
        "on_date": "‡§∞‡•ã‡§ú‡•Ä",
        "between": "‡§Ø‡•á‡§•‡•á",
        "and": "‡§Ü‡§£‡§ø",
        "agency_desc": "‡§µ‡•á‡§∏‡§æ‡§ï ‡§ï‡•á‡§Ö‡§∞ ‡§´‡§æ‡§â‡§Ç‡§°‡•á‡§∂‡§®, ‡§ï‡•ã‡§≤‡•ç‡§π‡§æ‡§™‡•Ç‡§∞ ‡§Ø‡•á‡§•‡•á ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä‡§ï‡•É‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ö‡§∏‡§≤‡•á‡§≤‡•Ä ‡§´‡§æ‡§â‡§Ç‡§°‡•á‡§∂‡§® ‡§ï‡§Ç‡§™‡§®‡•Ä (‡§Ø‡§æ‡§™‡•Å‡§¢‡•á \"‡§è‡§ú‡§®‡•ç‡§∏‡•Ä\" ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§∏‡§Ç‡§¨‡•ã‡§ß‡§≤‡•á ‡§ú‡§æ‡§à‡§≤).",
        "retainer_def": "(‡§Ø‡§æ‡§™‡•Å‡§¢‡•á \"‡§∞‡§ø‡§ü‡•á‡§®‡§∞\" ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§∏‡§Ç‡§¨‡•ã‡§ß‡§≤‡•á ‡§ú‡§æ‡§à‡§≤)",
        "whereas": "‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡§æ‡§µ‡§®‡§æ:",
        "whereas_a": "A. ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§∏‡§æ‡§Ø‡§ø‡§ï ‡§∞‡•Å‡§ó‡•ç‡§£ ‡§∏‡•á‡§µ‡§æ ‡§Ü‡§£‡§ø ‡§π‡•ã‡§Æ ‡§π‡•á‡§≤‡•ç‡§• ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§æ‡§§ ‡§Ü‡§π‡•á.",
        "whereas_b": "B. ‡§∞‡§ø‡§ü‡•á‡§®‡§∞‡§®‡•á ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä‡§≤‡§æ ‡§Ö‡§∏‡•á ‡§¶‡§∞‡•ç‡§∂‡§µ‡§ø‡§≤‡•á ‡§Ü‡§π‡•á ‡§ï‡•Ä ‡§§‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ‡§ï‡§°‡•á ‡§Ö‡§∂‡§æ ‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•å‡§∂‡§≤‡•ç‡§Ø‡•á, ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ ‡§Ü‡§£‡§ø ‡§∂‡§æ‡§∞‡•Ä‡§∞‡§ø‡§ï ‡§§‡§Ç‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä ‡§Ü‡§π‡•á.",
        "agreed": "‡§Æ‡•ç‡§π‡§£‡•Ç‡§®, ‡§ñ‡§æ‡§≤‡•Ä‡§≤‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•á ‡§∏‡§π‡§Æ‡§§‡•Ä ‡§ù‡§æ‡§≤‡•Ä ‡§Ü‡§π‡•á:",
        "sec_1": "1. ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§‡•Ä‡§ö‡•á ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™",
        "sec_1_1": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞‡§≤‡§æ ‡§ï‡§∞‡§æ‡§∞‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§ß‡§æ‡§∞‡§æ‡§µ‡§∞ '‡§™‡•ç‡§∞‡•ã‡§´‡•á‡§∂‡§®‡§≤ ‡§∞‡§ø‡§ü‡•á‡§®‡§∞' ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ï‡•á‡§≤‡•á ‡§Ü‡§π‡•á, ‡§ï‡§æ‡§Ø‡§Æ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™‡•Ä ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§®‡§æ‡§π‡•Ä.",
        "sec_1_2": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞‡§≤‡§æ ‡§∏‡§Æ‡§ú‡§§‡•á ‡§ï‡•Ä ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä ‡§∞‡•Å‡§ó‡•ç‡§£ ‡§Ü‡§£‡§ø ‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ‡§§ ‡§ï‡•á‡§µ‡§≥ ‡§è‡§ï ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§ï‡§∞‡•ç‡§§‡§æ (Facilitator) ‡§Æ‡•ç‡§π‡§£‡•Ç‡§® ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡§∞‡§§‡•á.",
        "sec_2": "2. ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡•Ä (‡§ï‡§†‡•ã‡§∞ ‡§™‡§æ‡§≤‡§®)",
        "sec_2_intro": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§´‡§ï‡•ç‡§§ ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø‡•á ‡§™‡§æ‡§∞ ‡§™‡§æ‡§°‡§£‡•ç‡§Ø‡§æ‡§∏ ‡§∏‡§π‡§Æ‡§§ ‡§Ü‡§π‡•á:",
        "sec_2_1": "2.1 ‡§Ö‡§™‡§µ‡§æ‡§¶ ‡§ï‡§≤‡§Æ (‡§ò‡§∞‡§ó‡•Å‡§§‡•Ä ‡§ï‡§æ‡§Æ ‡§®‡§æ‡§π‡•Ä):",
        "sec_2_1_text": "‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡§™‡§£‡•á ‡§∏‡§π‡§Æ‡§§ ‡§Ü‡§π‡•á ‡§ï‡•Ä ‡§§‡•á ‡§ò‡§∞‡§ó‡•Å‡§§‡•Ä ‡§ï‡§æ‡§Æ‡§ó‡§æ‡§∞ (Maid) ‡§®‡§æ‡§π‡•Ä‡§§. ‡§∞‡§ø‡§ü‡•á‡§®‡§∞ ‡§®‡§Æ‡•ç‡§∞‡§™‡§£‡•á ‡§™‡§∞‡§Ç‡§§‡•Å ‡§†‡§æ‡§Æ‡§™‡§£‡•á ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§ó‡•ã‡§∑‡•ç‡§ü‡•Ä ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏ ‡§®‡§ï‡§æ‡§∞ ‡§¶‡•á‡§à‡§≤:",
        "refuse_list": ["‡§ï‡•Å‡§ü‡•Å‡§Ç‡§¨‡§æ‡§∏‡§æ‡§†‡•Ä ‡§≠‡§æ‡§Ç‡§°‡•Ä ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ï‡§™‡§°‡•á ‡§ß‡•Å‡§£‡•á.", "‡§ù‡§æ‡§°‡•Ç ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§≤‡§æ‡§¶‡•Ä ‡§™‡•Å‡§∏‡§£‡•á (‡§∞‡•Å‡§ó‡•ç‡§£‡§æ‡§Æ‡•Å‡§≥‡•á ‡§ù‡§æ‡§≤‡•á‡§≤‡•Ä ‡§ò‡§æ‡§£ ‡§µ‡§ó‡§≥‡§§‡§æ).", "‡§ï‡•Å‡§ü‡•Å‡§Ç‡§¨‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ú‡•á‡§µ‡§£ ‡§¨‡§®‡§µ‡§£‡•á.", "‡§∞‡•Å‡§ó‡•ç‡§£‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø‡§æ‡§∂‡•Ä ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§®‡§∏‡§≤‡•á‡§≤‡•á ‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§ï‡§æ‡§∞‡•ç‡§Ø."],
        "sec_3": "3. ‡§Ö‡§µ‡•à‡§ß ‡§∂‡§ø‡§ï‡§æ‡§∞ ‡§µ‡§ø‡§∞‡•ã‡§ß‡•Ä ‡§Ü‡§£‡§ø ‡§®‡•â‡§®-‡§∏‡•â‡§≤‡§ø‡§∏‡§ø‡§ü‡•á‡§∂‡§® (‡§∂‡•Ç‡§®‡•ç‡§Ø ‡§∏‡§π‡§ø‡§∑‡•ç‡§£‡•Å‡§§‡§æ)",
        "sec_3_1": "3.1 ‡§®‡§ø‡§∞‡•ç‡§¨‡§Ç‡§ß: ‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞ ‡§ï‡§¨‡•Ç‡§≤ ‡§ï‡§∞‡§§‡•ã ‡§ï‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü/‡§∞‡•Å‡§ó‡•ç‡§£‡§æ‡§ö‡•Ä ‡§ì‡§≥‡§ñ ‡§ï‡•á‡§µ‡§≥ ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä‡§ö‡•ç‡§Ø‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§®‡§æ‡§Ç‡§§‡•Ç‡§® ‡§Ü‡§£‡§ø ‡§ó‡•Å‡§Ç‡§§‡§µ‡§£‡•Å‡§ï‡•Ä‡§§‡•Ç‡§® ‡§ù‡§æ‡§≤‡•Ä ‡§Ü‡§π‡•á.",
        "sec_3_2": "3.2 ‡§™‡•ç‡§∞‡§§‡§ø‡§¨‡§Ç‡§ß: ‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞ ‡§∏‡§π‡§Æ‡§§ ‡§Ü‡§π‡•á ‡§ï‡•Ä ‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§∞‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡§æ‡§≥‡§æ‡§§ ‡§Ü‡§£‡§ø ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä ‡§∏‡•ã‡§°‡§≤‡•ç‡§Ø‡§æ‡§®‡§Ç‡§§‡§∞ 24 ‡§Æ‡§π‡§ø‡§®‡•ç‡§Ø‡§æ‡§Ç‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§, ‡§§‡•á:",
        "prohibit_list": ["‡§è‡§ú‡§®‡•ç‡§∏‡•Ä‡§®‡•á ‡§ì‡§≥‡§ñ ‡§ï‡§∞‡•Ç‡§® ‡§¶‡§ø‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü‡§ï‡§°‡•Ç‡§® ‡§•‡•á‡§ü ‡§∞‡•ã‡§ú‡§ó‡§æ‡§∞ ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä‡§§.", "‡§è‡§ú‡§®‡•ç‡§∏‡•Ä‡§ö‡•á ‡§ï‡§Æ‡§ø‡§∂‡§® ‡§ü‡§æ‡§≥‡•Ç‡§® ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü‡§≤‡§æ ‡§ï‡§Æ‡•Ä ‡§¶‡§∞‡§æ‡§§ ‡§∏‡•á‡§µ‡§æ ‡§¶‡•á‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä‡§§.", "‡§è‡§ú‡§®‡•ç‡§∏‡•Ä‡§≤‡§æ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§® ‡§¶‡•á‡§§‡§æ ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü‡§ï‡§°‡•Ç‡§® '‡§™‡•ç‡§∞‡§æ‡§Ø‡§µ‡•ç‡§π‡•á‡§ü ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä' ‡§ï‡§ø‡§Ç‡§µ‡§æ '‡§ï‡•Ö‡§∂' ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä‡§§."],
        "sec_3_3": "3.3 ‡§â‡§≤‡•ç‡§≤‡§Ç‡§ò‡§®‡§æ‡§ö‡§æ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ:",
        "breach_list": ["‡§¨‡•ç‡§≤‡•Ö‡§ï‡§≤‡§ø‡§∏‡•ç‡§ü‡§ø‡§Ç‡§ó: ‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞‡§≤‡§æ ‡§ï‡§æ‡§Ø‡§Æ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™‡•Ä ‡§¨‡•ç‡§≤‡•Ö‡§ï‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•á‡§≤‡•á ‡§ú‡§æ‡§à‡§≤ ‡§Ü‡§£‡§ø ‡§Æ‡§π‡§æ‡§∞‡§æ‡§∑‡•ç‡§ü‡•ç‡§∞ ‡§π‡•ã‡§Æ ‡§π‡•á‡§≤‡•ç‡§•‡§ï‡•á‡§Ö‡§∞ ‡§Ö‡§∏‡•ã‡§∏‡§ø‡§è‡§∂‡§®‡§≤‡§æ ‡§ï‡§≥‡§µ‡§≤‡•á ‡§ú‡§æ‡§à‡§≤.", "‡§ú‡§™‡•ç‡§§‡•Ä: ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä ‡§∏‡§∞‡•ç‡§µ ‡§™‡•ç‡§∞‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§¶‡•á‡§Ø‡§ï‡•á, ‡§™‡§ó‡§æ‡§∞ ‡§Ü‡§£‡§ø ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§†‡•á‡§µ ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§ú‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§≤.", "‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§≠‡§∞‡§™‡§æ‡§à: ‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§®‡•Å‡§ï‡§∏‡§æ‡§®‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§≠‡§∞‡§™‡§æ‡§à ‡§Æ‡§æ‡§ó‡§£‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä ‡§∞‡§æ‡§ñ‡•Ç‡§® ‡§†‡•á‡§µ‡§§‡•á."],
        "sec_4": "4. ‡§Ü‡§ö‡§æ‡§∞‡§∏‡§Ç‡§π‡§ø‡§§‡§æ ‡§Ü‡§£‡§ø ‡§∂‡§ø‡§∏‡•ç‡§§",
        "sec_4_1": "4.1. ‡§ó‡§£‡§µ‡•á‡§∂: ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä‡§µ‡§∞ ‡§Ö‡§∏‡§§‡§æ‡§®‡§æ ‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞‡§®‡•á ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ó‡§£‡§µ‡•á‡§∂ ‡§Ü‡§£‡§ø ‡§ì‡§≥‡§ñ‡§™‡§§‡•ç‡§∞ ‡§™‡§∞‡§ø‡§ß‡§æ‡§® ‡§ï‡§∞‡§£‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á.",
        "sec_4_2": "4.2. ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤‡§ö‡§æ ‡§µ‡§æ‡§™‡§∞: ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä‡§ö‡•ç‡§Ø‡§æ ‡§µ‡•á‡§≥‡•á‡§§ ‡§∏‡•ã‡§∂‡§≤ ‡§Æ‡•Ä‡§°‡§ø‡§Ø‡§æ (Reels/YouTube) ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§ï‡•â‡§≤‡§∏‡§æ‡§†‡•Ä ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤ ‡§´‡•ã‡§®‡§ö‡§æ ‡§µ‡§æ‡§™‡§∞ ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏ ‡§∏‡§ï‡•ç‡§§ ‡§Æ‡§®‡§æ‡§à ‡§Ü‡§π‡•á.",
        "sec_4_3": "4.3. ‡§µ‡•ç‡§Ø‡§∏‡§®: ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä‡§µ‡§∞ ‡§¶‡§æ‡§∞‡•Ç, ‡§§‡§Ç‡§¨‡§æ‡§ñ‡•Ç, ‡§ó‡•Å‡§ü‡§ñ‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§°‡•ç‡§∞‡§ó‡•ç‡§∏‡§ö‡•á ‡§∏‡•á‡§µ‡§® ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§¨‡§°‡§§‡§∞‡•ç‡§´ ‡§ï‡•á‡§≤‡•á ‡§ú‡§æ‡§à‡§≤.",
        "sec_4_4": "4.4. ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§∏‡§ö‡•ã‡§ü‡•Ä: ‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞‡§®‡•á ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü‡§ï‡§°‡•Ç‡§® ‡§™‡•à‡§∏‡•á ‡§â‡§ß‡§æ‡§∞ ‡§ò‡•á‡§ä ‡§®‡§Ø‡•á‡§§ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ü‡§ø‡§™‡•ç‡§∏/‡§≠‡•á‡§ü‡§µ‡§∏‡•ç‡§§‡•Ç ‡§Æ‡§æ‡§ó‡•Ç ‡§®‡§Ø‡•á‡§§.",
        "sec_5": "5. ‡§´‡•å‡§ú‡§¶‡§æ‡§∞‡•Ä ‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ ‡§Ü‡§£‡§ø ‡§ï‡§æ‡§Ø‡§¶‡§æ",
        "sec_5_text": "‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞‡§≤‡§æ ‡§¶‡•á‡§∂‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§ï‡§æ‡§Ø‡§¶‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•Ä ‡§ú‡§æ‡§£‡•Ä‡§µ ‡§Ü‡§π‡•á:",
        "sec_5_1": "5.1. ‡§ö‡•ã‡§∞‡•Ä: ‡§ö‡•ã‡§∞‡•Ä‡§ö‡•ç‡§Ø‡§æ (‡§∞‡•ã‡§ñ, ‡§¶‡§æ‡§ó‡§ø‡§®‡•á, ‡§î‡§∑‡§ß‡•á) ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§ï‡•É‡§§‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø ‡§¶‡§Ç‡§° ‡§∏‡§Ç‡§π‡§ø‡§§‡•á‡§ö‡•ç‡§Ø‡§æ ‡§ï‡§≤‡§Æ 381 (‡§≤‡§ø‡§™‡•Ä‡§ï ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§®‡•ã‡§ï‡§∞‡§æ‡§®‡•á ‡§ï‡•á‡§≤‡•á‡§≤‡•Ä ‡§ö‡•ã‡§∞‡•Ä) ‡§Ö‡§Ç‡§§‡§∞‡•ç‡§ó‡§§ ‡§ñ‡§ü‡§≤‡§æ ‡§ö‡§æ‡§≤‡§µ‡§≤‡§æ ‡§ú‡§æ‡§à‡§≤, ‡§ú‡•ç‡§Ø‡§æ‡§Æ‡§ß‡•ç‡§Ø‡•á 7 ‡§µ‡§∞‡•ç‡§∑‡§æ‡§Ç‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§ ‡§§‡•Å‡§∞‡•Å‡§Ç‡§ó‡§µ‡§æ‡§∏‡§æ‡§ö‡•Ä ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ ‡§Ü‡§π‡•á.",
        "sec_5_2": "5.2. ‡§ú‡•ç‡§Ø‡•á‡§∑‡•ç‡§†‡§æ‡§Ç‡§ö‡§æ ‡§õ‡§≥: ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§ú‡•ç‡§Ø‡•á‡§∑‡•ç‡§† ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§æ‡§ö‡•Ä ‡§®‡§ø‡§∑‡•ç‡§ï‡§æ‡§≥‡§ú‡•Ä‡§™‡§£‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ó‡•à‡§∞‡§µ‡§∞‡•ç‡§§‡§® ‡§π‡§æ '‡§™‡§æ‡§≤‡§ï ‡§Ü‡§£‡§ø ‡§ú‡•ç‡§Ø‡•á‡§∑‡•ç‡§† ‡§®‡§æ‡§ó‡§∞‡§ø‡§ï‡§æ‡§Ç‡§ö‡•á ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§Ü‡§£‡§ø ‡§ï‡§≤‡•ç‡§Ø‡§æ‡§£ ‡§Ö‡§ß‡§ø‡§®‡§ø‡§Ø‡§Æ, 2007' ‡§Ö‡§Ç‡§§‡§∞‡•ç‡§ó‡§§ ‡§¶‡§Ç‡§°‡§®‡•Ä‡§Ø ‡§Ö‡§™‡§∞‡§æ‡§ß ‡§Ü‡§π‡•á.",
        "sec_6": "6. ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•Ä ‡§Ü‡§£‡§ø ‡§®‡•ã‡§ü‡•Ä‡§∏ ‡§ï‡§æ‡§≤‡§æ‡§µ‡§ß‡•Ä",
        "sec_6_1": "6.1. ‡§∞‡§æ‡§ú‡•Ä‡§®‡§æ‡§Æ‡§æ ‡§¶‡•á‡§£‡•ç‡§Ø‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡•Ä ‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞‡§®‡•á 30 ‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§ö‡•Ä ‡§≤‡•á‡§ñ‡•Ä ‡§®‡•ã‡§ü‡•Ä‡§∏ ‡§¶‡•á‡§£‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á.",
        "sec_6_2": "6.2. ‡§∞‡•Å‡§ó‡•ç‡§£ ‡§∏‡•ã‡§°‡•Ç‡§® ‡§ú‡§æ‡§£‡•á: ‡§∞‡•Å‡§ó‡•ç‡§£‡§æ‡§≤‡§æ ‡§°‡•ç‡§Ø‡•Å‡§ü‡•Ä‡§ö‡•ç‡§Ø‡§æ ‡§Æ‡§ß‡•ç‡§Ø‡§æ‡§§ ‡§∏‡•ã‡§°‡•Ç‡§® ‡§ú‡§æ‡§£‡•á ‡§π‡•á ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§â‡§≤‡•ç‡§≤‡§Ç‡§ò‡§® ‡§Ü‡§π‡•á. ‡§Ö‡§∂‡§æ ‡§™‡•ç‡§∞‡§ï‡§∞‡§£‡§æ‡§Ç‡§Æ‡§ß‡•ç‡§Ø‡•á, ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä ‡§∏‡§∞‡•ç‡§µ ‡§•‡§ï‡§¨‡§æ‡§ï‡•Ä ‡§ú‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§≤ ‡§Ü‡§£‡§ø ‡§®‡§ø‡§∑‡•ç‡§ï‡§æ‡§≥‡§ú‡•Ä‡§™‡§£‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡§æ‡§Ø‡§¶‡•á‡§∂‡•Ä‡§∞ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§à ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•á.",
        "sec_7": "7. ‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§≠‡§∞‡§™‡§æ‡§à",
        "sec_7_text": "‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞ ‡§∏‡•ç‡§µ‡§§‡§É‡§ö‡•ç‡§Ø‡§æ ‡§®‡§ø‡§∑‡•ç‡§ï‡§æ‡§≥‡§ú‡•Ä‡§™‡§£‡§æ‡§Æ‡•Å‡§≥‡•á ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ó‡•Å‡§®‡•ç‡§π‡•á‡§ó‡§æ‡§∞‡•Ä ‡§µ‡§∞‡•ç‡§§‡§®‡§æ‡§Æ‡•Å‡§≥‡•á ‡§â‡§¶‡•ç‡§≠‡§µ‡§£‡§æ‡§±‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§ï‡§æ‡§Ø‡§¶‡•á‡§∂‡•Ä‡§∞ ‡§ï‡§æ‡§∞‡§µ‡§æ‡§à ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§®‡•Å‡§ï‡§∏‡§æ‡§®‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§è‡§ú‡§®‡•ç‡§∏‡•Ä‡§≤‡§æ ‡§≠‡§∞‡§™‡§æ‡§à ‡§¶‡•á‡§£‡•ç‡§Ø‡§æ‡§∏ ‡§∏‡§π‡§Æ‡§§ ‡§Ü‡§π‡•á.",
        "sec_8": "8. ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞",
        "sec_8_text": "‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§∞‡§æ‡§§‡•Ç‡§® ‡§â‡§¶‡•ç‡§≠‡§µ‡§£‡§æ‡§∞‡•á ‡§∏‡§∞‡•ç‡§µ ‡§µ‡§æ‡§¶ ‡§ï‡•á‡§µ‡§≥ ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§®‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§≤‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§Ö‡§ß‡•Ä‡§® ‡§Ü‡§π‡•á‡§§:",
        "witness": "‡§∏‡§æ‡§ï‡•ç‡§∑‡•Ä‡§¶‡§æ‡§∞ ‡§Æ‡•ç‡§π‡§£‡•Ç‡§®, ‡§™‡§ï‡•ç‡§∑‡§æ‡§Ç‡§®‡•Ä ‡§Ø‡§æ ‡§ï‡§∞‡§æ‡§∞‡§æ‡§µ‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä ‡§ï‡•á‡§≤‡•Ä ‡§Ü‡§π‡•á.",
        "sign_caregiver": "‡§ï‡•á‡§Ö‡§∞‡§ó‡§ø‡§µ‡•ç‡§π‡§∞‡§ö‡•Ä ‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä",
        "sign_auth": "‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§∏‡•ç‡§µ‡§æ‡§ï‡•ç‡§∑‡§∞‡•Ä‡§ï‡§∞‡•ç‡§§‡§æ"
    }
}

# 2. LOGIC TO GET DUTIES BASED ON PLAN
def get_dynamic_duties(plan_name, sub_service, lang="English"):
    """
    Returns the Agreement Title and List of Duties based on the logic in 'Tab 5 Logic'.
    Translations for duties are kept simple (headers mostly) as technical terms remain in English usually.
    """
    plan_clean = str(plan_name).strip()
    sub_clean = str(sub_service).strip()
    
    title = plan_clean
    duties = []
    
    # --- LOGIC BLOCK: PLAN A to E ---
    if "Plan A" in plan_clean:
        title = "Patient Care Service"
        duties = [
            "Perform Bed Bath/Sponge Bath, Diaper Changing with hygienic disposal, Oral Care & Denture Cleaning.",
            "Execute Assisted Transfers (Bed to Chair/Wheelchair) and Turning & Positioning for Bed Sore Prevention.",
            "Oral/Spoon feeding assistance and strict monitoring of water intake. Record BP, Sugar, and Temperature using the patient's device.",
            "Maintain bed making and linen changing. Nail cutting, hair combing, and providing emotional support.",
            "Strictly Non-Invasive (No Injections/IVs allowed)."
        ]
    elif "Plan B" in plan_clean:
        title = "Nurse Service"
        duties = [
            "All duties of Patient Care Service (Plan A).",
            "Administration of IV Fluids, Injections (IM/IV/SC) as per Doctor's prescription.",
            "Ryle's Tube Feeding and Care, Catheter Care (Urobag changing), and Stoma Care.",
            "Wound Dressing (Aseptic technique), Suctioning (Oral/Tracheal), and Oxygen administration.",
            "Monitoring of critical vitals and maintaining clinical charts."
        ]
    elif "Plan C" in plan_clean:
        title = "Chronic and Holistic Healthcare Service"
        duties = [
            "Comprehensive management of chronic conditions (Dementia, Alzheimer's, Parkinson's).",
            "Assistance with Activities of Daily Living (ADLs) with a focus on dignity.",
            "Medication management and adherence monitoring.",
            "Prevention of complications (bedsores, aspiration, falls).",
            "Cognitive stimulation and companionship."
        ]
    elif "Plan D" in plan_clean:
        title = "Elderly and Well-being Care"
        duties = [
            "Companionship and emotional support.",
            "Assistance with mobility and fall prevention.",
            "Light meal preparation and medication reminders.",
            "Accompaniment to doctors visits or social walks.",
            "General safety supervision."
        ]
    elif "Plan E" in plan_clean:
        title = "Maternal & Newborn - Support for Women during and after Pregnancy"
        duties = [
            "Newborn Care: Bathing, massage, burping, and cord care.",
            "Mother Care: Postnatal wound care (Episiotomy/C-Section), lactation support.",
            "Sterilization of feeding bottles and hygiene management.",
            "Monitoring baby's sleep and feeding schedule."
        ]
        
    # --- LOGIC BLOCK: PLAN F (REHABILITATIVE) ---
    elif "Plan F" in plan_clean:
        title = f"Rehabilitative Care for {sub_clean}"
        duties = [
            f"**Primary Focus Area:** {sub_clean}",
            "One or Combinations of:",
            "Manual Therapy (Maitland/Mulligan Mobilization)",
            "Soft Tissue Release/Massage",
            "Kinesio-Taping application (Tape provided by client)",
            "Ergonomic & Postural Correction",
            "Cryotherapy/Heat application (using home packs)."
        ]
        
    # --- LOGIC BLOCK: A-LA-CARTE ---
    elif "A-la-carte" in plan_clean or "Other Service" in plan_clean:
        title = f"Other Service - {sub_clean}"
        duties = [
            f"Execution of specific service: **{sub_clean}**",
            "Adherence to strict hygiene and safety protocols.",
            "Reporting of service outcome to the Agency.",
            "Coordination with family for safe execution."
        ]
    else:
        # Fallback
        title = plan_clean
        duties = ["Duties as assigned by the Agency supervisor based on patient assessment."]

    # If Lang is Hindi/Marathi, we append a small note (Full translation of technical medical duties is complex/risky)
    if lang != "English":
        duties.append(f"(Duties listed in English for medical accuracy / ‡§µ‡•à‡§¶‡•ç‡§Ø‡§ï‡•Ä‡§Ø ‡§Ö‡§ö‡•Ç‡§ï‡§§‡•á‡§∏‡§æ‡§†‡•Ä ‡§ï‡§∞‡•ç‡§§‡§µ‡•ç‡§Ø‡•á ‡§á‡§Ç‡§ó‡•ç‡§∞‡§ú‡•Ä‡§§ ‡§∏‡•Ç‡§ö‡•Ä‡§¨‡§¶‡•ç‡§ß ‡§Ü‡§π‡•á‡§§)")

    return title, duties

# 3. HTML GENERATOR FUNCTION
def generate_agreement_html(data, lang="English"):
    t = AGREEMENT_I18N.get(lang, AGREEMENT_I18N["English"])
    
    # Unpack Data
    city = data.get("city", "Mumbai")
    date_str = data.get("date", "")
    nurse_name = data.get("nurse_name", "")
    nurse_age = data.get("nurse_age", "")
    nurse_aad = data.get("nurse_aadhar", "")
    nurse_addr = data.get("nurse_addr", "")
    role = data.get("role", "Caregiver") # Nurse/Attendant/Physio
    
    # Dynamic Duties
    srv_title, duties_list = get_dynamic_duties(data.get("plan", ""), data.get("sub_service", ""), lang)
    
    # Build Duties HTML
    duties_html = ""
    for d in duties_list:
        duties_html += f"<li class='mb-1'>{d}</li>"
        
    # Build Exclusion List HTML
    refuse_html = ""
    for r in t["refuse_list"]:
        refuse_html += f"<li>{r}</li>"
        
    # Build Prohibit List HTML
    prohibit_html = ""
    for p in t["prohibit_list"]:
        prohibit_html += f"<li>{p}</li>"
        
    # Build Breach List HTML
    breach_html = ""
    for b in t["breach_list"]:
        parts = b.split(":", 1)
        if len(parts) > 1:
            breach_html += f"<li><b>{parts[0]}:</b>{parts[1]}</li>"
        else:
            breach_html += f"<li>{b}</li>"

    # Signature Block (Company Stamp Logic)
    # Using simple HTML/CSS for the stamp overlay
    
    html = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@700&display=swap');
            body {{ font-family: 'Lato', sans-serif; font-size: 11pt; line-height: 1.4; color: #333; }}
            h1, h2, h3, h4 {{ font-family: 'Playfair Display', serif; color: #002147; }}
            .agreement-box {{ max-width: 210mm; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }}
            ul {{ padding-left: 20px; }}
            li {{ margin-bottom: 4px; }}
            .stamp-container {{ position: relative; width: 200px; height: 100px; margin-top: 10px; }}
            .stamp-box {{ position: absolute; top: 0; left: 0; width: 100%; border-bottom: 1px solid #333; }}
            .stamp-img {{ position: absolute; top: -30px; left: 20px; width: 100px; opacity: 0.8; transform: rotate(-10deg); }}
            .sign-img {{ position: absolute; top: -20px; left: 40px; width: 120px; z-index: 10; }}
            @media print {{ .agreement-box {{ box-shadow: none; padding: 0; }} }}
        </style>
    </head>
    <body class="bg-gray-100 py-10">
    <div class="agreement-box" id="agreement-content">
        <div class="text-center border-b-2 border-vesak-navy pb-4 mb-6">
            <h1 class="text-2xl font-bold uppercase tracking-wider">{t['title']}</h1>
            <h3 class="text-md font-bold text-gray-500 uppercase mt-1">{t['subtitle']}</h3>
        </div>

        <div class="mb-4">
            <p><strong>{t['agreement_made']}</strong> {city}, Maharashtra <strong>{t['on_date']}</strong> {date_str}.</p>
        </div>

        <div class="mb-4">
            <p class="font-bold text-center mb-2">{t['between']}</p>
            <p>{t['agency_desc']}</p>
        </div>

        <div class="mb-6">
            <p class="font-bold text-center mb-2">{t['and']}</p>
            <p>
                <strong>Mr./Ms. {nurse_name}</strong>, Age: [{nurse_age}], Aadhar No: [{nurse_aad}],<br>
                Residing at: {nurse_addr}<br>
                {t['retainer_def']} <strong>"{role.upper()} / RETAINER"</strong>.
            </p>
        </div>

        <div class="mb-6">
            <p class="font-bold">{t['whereas']}</p>
            <p>{t['whereas_a']}</p>
            <p>{t['whereas_b'].replace('Retainer', role)}</p>
        </div>

        <p class="font-bold uppercase mb-4 text-center">{t['agreed']}</p>

        <div class="space-y-4">
            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_1']}</h4>
                <p>1.1. {t['sec_1_1'].replace('Retainer', role)}</p>
                <p>1.2. {t['sec_1_2'].replace('Retainer', role)}</p>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_2']}</h4>
                <p class="font-bold text-vesak-gold">{srv_title}</p>
                <p>{t['sec_2_intro'].replace('Retainer', role)}</p>
                <ul class="list-disc text-sm mt-2 bg-gray-50 p-2 rounded">{duties_html}</ul>
                
                <p class="mt-3"><strong>{t['sec_2_1']}</strong></p>
                <p>{t['sec_2_1_text'].replace('Retainer', role)}</p>
                <ul class="list-disc text-sm text-red-700">{refuse_html}</ul>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_3']}</h4>
                <p><strong>{t['sec_3_1']}</strong></p>
                <p><strong>{t['sec_3_2']}</strong></p>
                <ul class="list-disc text-sm">{prohibit_html}</ul>
                <p class="mt-2"><strong>{t['sec_3_3']}</strong></p>
                <ul class="list-disc text-sm">{breach_html}</ul>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_4']}</h4>
                <p>{t['sec_4_1']}</p>
                <p>{t['sec_4_2']}</p>
                <p>{t['sec_4_3']}</p>
                <p>{t['sec_4_4']}</p>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_5']}</h4>
                <p>{t['sec_5_text']}</p>
                <p>{t['sec_5_1']}</p>
                <p>{t['sec_5_2']}</p>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_6']}</h4>
                <p>{t['sec_6_1']}</p>
                <p>{t['sec_6_2']}</p>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_7']}</h4>
                <p>{t['sec_7_text']}</p>
            </div>

            <div>
                <h4 class="font-bold uppercase text-sm border-b border-gray-300 inline-block mb-2">{t['sec_8']}</h4>
                <p>{t['sec_8_text']} <strong>{city}</strong>, Maharashtra.</p>
            </div>
        </div>

        <div class="mt-8 pt-4 border-t-2 border-gray-800">
            <p class="font-bold text-center uppercase">{t['witness']}</p>
        </div>

        <div class="flex justify-between items-start mt-12">
            <div class="w-1/3">
                <p class="font-bold uppercase mb-8">{t['sign_caregiver']}</p>
                <div class="border-b border-black w-full h-8"></div>
                <p class="text-xs mt-1">Date: _________________</p>
            </div>
            <div class="w-1/3">
                <p class="font-bold uppercase mb-2">{t['sign_auth']}</p>
                <div class="stamp-container">
                    <div class="text-xs text-gray-400 absolute top-4 left-4">[Stamp & Signature]</div>
                    <div class="stamp-box"></div>
                    <p class="text-xs mt-1">For Vesak Care Foundation</p>
                </div>
            </div>
        </div>

    </div>
    
    <script>
        function generatePDF() {{
            const element = document.getElementById('agreement-content');
            const opt = {{
                margin: [5, 5, 5, 5],
                filename: '{generate_filename("Nurse", "AGR", nurse_name)}',
                image: {{ type: 'jpeg', quality: 0.98 }},
                html2canvas: {{ scale: 2, useCORS: true }},
                jsPDF: {{ unit: 'mm', format: 'a4', orientation: 'portrait' }}
            }};
            html2pdf().set(opt).from(element).save();
        }}
    </script>
    </body>
    </html>
    """
    return html

# ==========================================
# CORE INVOICE FUNCTION - render_invoice_ui()
# ==========================================
def render_invoice_ui(df_main, mode="standard"):
    # ========================================================
    # ‚≠ê RESET TRIGGER CHECK (SOLVES THE STREAMLIT ERROR)
    # ========================================================
    # This block executes BEFORE the widgets are drawn.
    # It checks if the previous run requested a reset.
    if st.session_state.get(f"trigger_reset_{mode}", False):
        st.session_state[f"inv_d_{mode}"] = datetime.date.today()
        # Reset overwrite checkbox key if it exists
        if f"ow_{mode}" in st.session_state:
            st.session_state[f"ow_{mode}"] = False
        # Consume the trigger
        st.session_state[f"trigger_reset_{mode}"] = False
    
    # --------------------------------------------------------

    client = get_gspread_client()
    master_id = extract_id_from_url(sys_config.get("master_sheet_url"))

    if not master_id or not client:
        st.error("‚ùå Master Workbook not linked in Sidebar Settings."); return

    # --- FILTER SECTION ---
    st.subheader("1. Select Customer")
 
# ‚≠ê CHANGE: NEW CUSTOMER vs EXISTING CUSTOMER TOGGLE
    show_existing = st.toggle("üìÇ Switch List: üÜï New Customers ‚áÑ üìÇ Existing Customers", value=False)
															
    
    # Auto-set Overwrite checkbox based on toggle
																		
    st.session_state[f"ow_{mode}"] = show_existing    

    use_filters = st.checkbox("üîç Enable Search Filters (Date/Location)", key=f"use_filt_{mode}")

    df_view = df_main.copy()

# Filter logic    
    if use_filters:
        col_filt1, col_filt2 = st.columns(2)
        with col_filt1:
            filter_date = st.date_input("Filter Date (Search by Date):", value=datetime.date.today(), key=f"f_date_{mode}")
        with col_filt2:
            unique_locs = ["All"] + sorted(list(df_main['Location'].astype(str).unique()))
            filter_loc = st.selectbox("Filter Location:", unique_locs, key=f"f_loc_{mode}")

        if 'Call Date' in df_view.columns:
            df_view['TempDate'] = pd.to_datetime(df_view['Call Date'], errors='coerce').dt.date
            df_view = df_view[df_view['TempDate'] == filter_date]
        
        if filter_loc != "All":
            df_view = df_view[df_view['Location'].astype(str) == filter_loc]

    # --- CRITICAL POINT 2: EXCLUSION LOGIC (CACHED) ---
    current_mmm_yy = datetime.date.today().strftime("%b-%y")
    
    # UNPACK TUPLE: Get both 'Present' and 'Ended' lists
    present_refs, ended_refs = get_cached_exclusion_list(master_id, current_mmm_yy)

    # Filter list based on Toggle State
    df_view['Ref_Norm_View'] = df_view['Ref. No.'].apply(normalize_id)
    df_view['Ser_Norm_View'] = df_view['Serial No.'].apply(normalize_id)
    df_view['Unique_Key'] = df_view['Ref_Norm_View'] + "-" + df_view['Ser_Norm_View']

    if show_existing:
        # Switch ON: Show Existing Customers
        # CRITICAL: Exclude those with "Service Ended" data
        if present_refs:
            # Logic: Must be in History (Present) AND NOT in Ended List
            active_keys = set(present_refs) - set(ended_refs)
            df_view = df_view[df_view['Unique_Key'].isin(active_keys)]
        else:
             df_view = pd.DataFrame(columns=df_view.columns) # Empty if no history
    else:
        # Switch OFF: Show New Customers (Not in History)
        if present_refs:
             df_view = df_view[~df_view['Unique_Key'].isin(present_refs)]
    
    df_view = df_view.drop(columns=['Ref_Norm_View', 'Ser_Norm_View', 'Unique_Key'])

    df_view['Ref_Clean'] = df_view['Ref. No.'].astype(str).str.strip()
    df_view['Label'] = df_view['Name'].astype(str) + " (" + df_view['Mobile'].astype(str) + ")"
    
    if df_view.empty:
        if show_existing: st.info("üìÇ No existing invoices found for this month.")
        else: st.success("‚úÖ All customers have invoices! Switch toggle to view existing.")

        return

    selected_label = st.selectbox(f"Select Customer ({mode}):", [""] + list(df_view['Label'].unique()), key=f"sel_{mode}")
    
    if not selected_label: return

    row = df_view[df_view['Label'] == selected_label].iloc[0]
    
    c_ref = normalize_id(row.get('Ref. No.', '')).strip()
    c_serial = normalize_id(row.get('Serial No.', '')).strip()
    c_mob = normalize_id(row.get('Mobile', '')).strip()
    c_name = row.get('Name', '')
    c_plan = row.get('Service Required', '')
    c_age = str(row.get('Age', ''))
    c_gender = str(row.get('Gender', ''))
    c_loc = str(row.get('Location', ''))
    c_addr = str(row.get('Address', ''))
    c_shift = str(row.get('Shift', ''))
    c_rec = str(row.get('Recurring Service', ''))
    c_period = str(row.get('Period', ''))
    c_visits = str(row.get('Visits', ''))
    
    c_ref_code = clean_referral_field(row.get('Referral Code', ''))
    c_ref_name = clean_referral_field(row.get('Referral Name', ''))
# Process Credit (Handle number formatting from Excel)
    raw_credit = row.get('Referral Credit', '')
    c_ref_credit = str(int(float(raw_credit))) if str(raw_credit).replace('.', '', 1).isdigit() else clean_referral_field(raw_credit)

    # --- INVOICE DATE SECTION (NEW) ---
    st.divider()
    st.subheader("2. Invoice Details")

    # Overwrite Checkbox (Moved up to control Disabled state)
							  
    chk_overwrite = st.checkbox("Overwrite Existing Invoice", key=f"ow_{mode}")

    # --- INVOICE CALCULATION LOGIC ---
    inv_final = ""
    default_date = datetime.date.today()
    default_qty = 1
    
    # ----------------------------------------------------
    # ‚≠ê UPDATED NOTE LOGIC (REQUIREMENT C)
    # ----------------------------------------------------
    val_notes = row.get('Notes', '')
    default_notes = "" if pd.isna(val_notes) or str(val_notes).strip().lower() == 'nan' else str(val_notes)

    # Check if Plan F to append Disclaimer
    if "Plan F" in c_plan:
        disclaimer_text = "All medical equipment, consumables (gloves, cotton, medicines, oils, tapes), and assistive devices (walkers, beds, weights/bands) required for the execution of these duties must be provided by the Client. The Caregiver/Therapist provides expertise and labor only."
        if default_notes:
            default_notes += f"\n\n{disclaimer_text}"
        else:
            default_notes = disclaimer_text
    # ----------------------------------------------------

    conflict_exists = False
    existing_row_idx = None

    mmm_yy = default_date.strftime("%b-%y")

    sheet_obj = None
    try:
        wb_save = client.open_by_key(master_id)
        try:
            sheet_obj = wb_save.worksheet(mmm_yy)
        except:
            sheet_obj = wb_save.add_worksheet(title=mmm_yy, rows=1000, cols=34)
            sheet_obj.append_row(SHEET_HEADERS)
    except Exception as e:
        st.error(f"Connection Error: {e}")
        return

    # df_history = pd.DataFrame()
    # THE OVERWRITE FUNCTION LOGIC 
    if sheet_obj:
        master_records = sheet_obj.get_all_records()
        df_history = pd.DataFrame(master_records)
    
        if not df_history.empty:
            # Normalize values for accurate comparison
            df_history['Ref_Norm'] = df_history['Ref. No.'].apply(lambda x: normalize_id(x).strip())
            df_history['Ser_Norm'] = df_history['Serial No.'].apply(lambda x: normalize_id(x).strip())
    
            # ‚≠ê CHANGE #8: FIXED CONFLICT DETECTION LOGIC - MATCH ONLY ON REF. NO. AND SERIAL NO.
            # DO NOT MATCH ON INVOICE NO. because it changes for each invoice
            # This ensures we detect existing customers regardless of how many invoices they have
            match_mask = (
                (df_history['Ref_Norm'].astype(str) == str(c_ref)) &
                (df_history['Ser_Norm'].astype(str) == str(c_serial))
            )
    
            existing_matches = df_history[match_mask]
    
            if not existing_matches.empty:
                conflict_exists = True
                last_match = existing_matches.iloc[-1]
    
                inv_final = str(last_match.get('Invoice Number', ''))
    
                hist_note = str(last_match.get('Notes / Remarks', '')).strip()
                if hist_note:
                    default_notes = hist_note
    
                # Paid Units
                raw_paid_val = last_match.get('Paid for', '')
                try:
                    if raw_paid_val and str(raw_paid_val).strip().isdigit():
                        default_qty = int(str(raw_paid_val).strip())
                    else:
                        hist_details = str(last_match.get('Details', ''))
                        match_qty = re.search(
                            r'Paid for\s*(\d+)',
                            hist_details,
                            re.IGNORECASE
                        )
                        if match_qty:
                            default_qty = int(match_qty.group(1))
                except:
                    pass
    
                # Date
                try:
                    hist_date_str = str(last_match.get('Date', ''))
                    clean_date_str = re.sub(
                        r'(\d+)(st|nd|rd|th)',
                        r'\1',
                        hist_date_str
                    )
                    default_date = datetime.datetime.strptime(
                        clean_date_str,
                        "%b. %d %Y"
                    ).date()
                except:
                    pass
    
                # Get existing row index (WITHOUT Invoice No)
                try:
                    # Since we aren't matching invoice no, search manually
                    idx = existing_matches.index.tolist()[-1]
                    existing_row_idx = idx + 2   # +2 for header
                except:
                    existing_row_idx = None
    
            else:
                default_qty = 1
                conflict_exists = False
        else:
            default_qty = 1
            conflict_exists = False
    else:
        default_qty = 1
        conflict_exists = False

    if not conflict_exists:
        # 1. Setup STRICT Formatting Variables
        # Ensure Location matches exactly 3 letters (MUM or PUN)
        raw_loc = str(row.get('Location', '')).lower().strip()
        loc_code = "MUM" if "mumbai" in raw_loc else "PUN"
        
        # Current Date Targets
        target_month = default_date.month
        target_year = default_date.year
        
        # 2. THE HARDCORE LOGIC: Scan History for the Highest Sequence
        # We start at 0. If no history found, next is 0+1 = 1.
        max_existing_seq = 0

        if not df_history.empty and 'Invoice Number' in df_history.columns:
            # Convert column to string to avoid float errors (e.g. 1.0 vs 1)
            inv_series = df_history['Invoice Number'].dropna().astype(str)

            for existing_inv in inv_series:
                clean_inv = existing_inv.strip()
                
                # STRICT REGEX: Looks for LOC-DDMMYYYY-SEQ
                # This breaks the string into exact parts.
                # Example Match: PUN-12012026-005
                match = re.search(r'^([A-Z]{3})-(\d{2})(\d{2})(\d{4})-(\d+)$', clean_inv)
                
                if match:
                    f_loc = match.group(1)   # e.g., PUN
                    # f_day = match.group(2) # e.g., 12 (We ignore Day for sequencing)
                    f_month = int(match.group(3)) # e.g., 01
                    f_year = int(match.group(4))  # e.g., 2026
                    f_seq = int(match.group(5))   # e.g., 005
                    
                    # LOGIC: 
                    # 1. Location must match (PUN sequence is separate from MUM)
                    # 2. Month and Year must match (Sequence resets every month)
                    if f_loc == loc_code and f_month == target_month and f_year == target_year:
                        if f_seq > max_existing_seq:
                            max_existing_seq = f_seq
            
        # 3. Resume the Sequence
        # No matter if the last row was "Alphabet" or broken, we take the Max Number found + 1
        next_seq = max_existing_seq + 1

        # 4. Construct Final String
        # Result: PUN-12012026-006
        date_str_final = default_date.strftime('%d%m%Y')
        inv_final = f"{loc_code}-{date_str_final}-{next_seq:03d}"

    # ================= UI SECTION =================

    col_inv1, col_inv2 = st.columns(2)

    with col_inv1:
        inv_date_val = st.date_input(
            "Invoice Date:",
            value=default_date,
            key=f"inv_d_{mode}"
        )

    with col_inv2:
        is_inv_disabled = True if (conflict_exists and not chk_overwrite) else False
        inv_input = st.text_input(
            "Invoice Number",
            value=inv_final,
            disabled=is_inv_disabled,
            key=f"inv_n_{mode}"
        )

    st.write(f"**Plan:** {c_plan} | **Ref:** {c_ref} | **Serial:** {c_serial}")

    # ‚≠ê CHANGE #4: SMART WARNING MESSAGES
    if conflict_exists:
        if chk_overwrite:
            st.info(f"‚úÖ Overwrite is ON ‚Äì changes will update Invoice #{inv_final}")
        else:
            st.warning(f"‚ö†Ô∏è Customer exists (Ref: {c_ref}, Serial: {c_serial}). Tick 'Overwrite' to Update.")

    col3, col4 = st.columns(2)

    with col3:
        billing_qty = st.number_input(
            "Paid Units:",
            min_value=1,
            value=default_qty,
            key=f"qty_{mode}_{selected_label}"
        )
        notes = st.text_area(
            "Notes:",
            value=default_notes,
            key=f"note_{mode}"
        )

    with col4:
        gen_by_input = st.text_input(
            "Generated By:",
            value="",
            placeholder="Leave blank for Default",
            key=f"gen_{mode}"
        )
        gen_by_to_save = (
            gen_by_input if gen_by_input.strip() else "Vesak Patient Care"
        )

    st.subheader("Services")
    inc_list, exc_list = get_base_lists(c_plan, row.get('Sub Service', 'All'))

    sc1, sc2 = st.columns(2)

    with sc1:
        st.text_area("Included", ", ".join(inc_list), disabled=True)

    with sc2:
        exc_final = st.multiselect(
            "Excluded (Click X to remove):",
            options=exc_list,
            default=exc_list,
            key=f"exc_{mode}_{c_ref}"
        )
        exc_text_for_pdf = ", ".join(exc_final)

    # ‚≠ê NEW REFERRAL LOGIC
    # Logic: Disable if data exists, Enable if empty OR if Overwrite is checked
    disable_ref = False
    if c_ref_name and c_ref_code and c_ref_credit: disable_ref = True
    if chk_overwrite: disable_ref = False

    with st.expander("üéÅ Referral Details", expanded=True):
        cr1, cr2, cr3 = st.columns(3)
        with cr1: ref_name_input = st.text_input("Referral Name", value=c_ref_name, disabled=disable_ref, key=f"rn_{mode}")
        with cr2: ref_code_input = st.text_input("Referral Code", value=c_ref_code, disabled=disable_ref, key=f"rc_{mode}")
        with cr3: ref_credit_input = st.text_input("Referral Credit", value=c_ref_credit, disabled=disable_ref, key=f"rcred_{mode}")
    
# ========================================================
    # ‚≠ê PREVIEW SECTION - GENERATE HTML LIVE
    # ========================================================
    # This block generates the preview HTML using LIVE data from the inputs above.
    # It runs on every interaction, updating the preview instantly.
    preview_rate = float(row.get('Unit Rate', 0))
    preview_total = preview_rate * billing_qty
    preview_date_str = format_date_with_suffix(inv_date_val)
    preview_file_name = generate_filename("Invoice", inv_input, c_name)

    # Reuse existing helpers to generate parts of the HTML
    desc_col_html = construct_description_html(row)
    amount_col_html = construct_amount_html(row, billing_qty)
    
    # ----------------------------------------------------
    # ‚≠ê UPDATED PLAN NAME LOGIC (REQUIREMENT A & D)
    # ----------------------------------------------------
    pdf_display_plan = c_plan
    sub_srv_txt = str(row.get('Sub Service', '')).strip()

    if c_plan == "Plan A: Patient Attendant Care": pdf_display_plan = "Patient Care Service"
    elif c_plan == "Plan B: Skilled Nursing": pdf_display_plan = "Nurse Service"
    elif c_plan == "Plan C: Chronic Management": pdf_display_plan = "Chronic and Holistic Healthcare Service"
    elif c_plan == "Plan D: Elderly Companion": pdf_display_plan = "Elderly and Well-being Care"
    elif c_plan == "Plan E: Maternal & Newborn": pdf_display_plan = "Maternal & Newborn - Support for Women during and after Pregnancy"
    
    # --- PLAN F REQUIREMENT ---
    elif "Plan F" in c_plan: 
        pdf_display_plan = f"Rehabilitative Care for {sub_srv_txt}"
    
    # --- A-LA-CARTE REQUIREMENT ---
    elif "A-la-carte" in c_plan: 
        pdf_display_plan = f"Other Service - {sub_srv_txt}"
    
    clean_plan = pdf_display_plan
    # ----------------------------------------------------

    inc_html = "".join([f'<li class="mb-1 text-xs text-gray-700">{item}</li>' for item in inc_list])
    exc_html = "".join([f'<li class="mb-1 text-[10px] text-gray-500">{item}</li>' for item in exc_final])

    notes_section = ""
    if notes:
        notes_section = f"""<div class="mt-6 p-4 bg-gray-50 border border-gray-100 rounded"><h4 class="font-bold text-vesak-navy text-xs mb-1">NOTES:</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">{notes}</p></div>"""

    # --- HTML TEMPLATE WITH EMBEDDED BUTTONS (TAILWIND + JS) ---
    html_content = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {{
            theme: {{
                extend: {{
                    colors: {{ vesak: {{ navy: '#002147', gold: '#C5A065', orange: '#CC4E00' }} }},
                    fontFamily: {{ serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }}
                }}
            }}
        }}
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap');
        body {{ font-family: 'Lato', sans-serif; background: #f0f0f0; margin: 0; }}
        .invoice-page {{ position: relative; background: white; width: 210mm; height: 297mm; padding: 30px; padding-bottom: 120px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); display: flex; flex-direction: column; margin-left: auto; margin-right: auto; }}
        main {{ flex: none; }}
        footer {{ position: absolute; bottom: 7mm; left: 30px; right: 30px; text-align: center; }}
        .watermark-container {{ position: fixed; top: 148.5mm; left: 50%; transform: translateX(-50%) translateY(-50%); pointer-events: none; z-index: 0; }}
        .watermark-text {{ font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 800; color: rgba(0, 33, 71, 0.04); letter-spacing: 0.25em; }}
        @media print {{
            body {{ background: white; -webkit-print-color-adjust: exact; }}
            .invoice-page {{ width: 210mm; height: 297mm; padding: 20px; padding-bottom: 90px; box-shadow: none; }}
            footer {{ bottom: 7mm; width: calc(100% - 40px); }}
            .no-print {{ display: none !important; }}
            .watermark-container {{ opacity: 0.04 !important; }}
        }}
    </style>
</head>
<body class="py-10">
    <div class="max-w-[210mm] mx-auto mb-6 flex justify-end gap-3 no-print px-4">
        <button onclick="window.print()" class="bg-gray-600 text-white px-5 py-2 rounded shadow hover:bg-gray-800 transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-print mr-2"></i> Print / Save Vector PDF
        </button>
        <button onclick="generatePDF()" class="bg-vesak-navy text-white px-6 py-2 rounded shadow hover:bg-vesak-gold transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-download mr-2"></i> Download PDF
        </button>
    </div>

    <div class="invoice-page" id="invoice-content">
        <div class="watermark-container">
            <img src="data:image/png;base64,{logo_b64}" style="display:block; margin:0; padding:0; width:300px; opacity:0.04;">
            <div class="watermark-text mt-4">VESAK</div>
        </div>

        <header class="relative z-10 w-full mb-10">
            <div class="flex justify-between items-start border-b border-gray-100 pb-6">
                <div class="flex items-center gap-5">
                    <img src="data:image/png;base64,{logo_b64}" class="w-20 h-auto">
                    <div>
                        <h1 class="font-serif text-2xl font-bold text-vesak-navy tracking-wide leading-none mb-2">
                            Vesak Care <span class="text-vesak-gold font-normal">Foundation</span>
                        </h1>
                        <div class="flex flex-col text-xs text-gray-500 font-light tracking-wide space-y-0.5">
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Web</span> vesakcare.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Email</span> vesakcare@gmail.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Phone</span> +91 7777 000 878</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block font-serif text-3xl text-gray-200 tracking-widest mb-2">INVOICE</span>
                    <div class="text-xs text-vesak-navy">
                        <div class="mb-1"><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">Date</span> <b>{preview_date_str}</b></div>
                        <div><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">No.</span> <b>{inv_input}</b></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow relative z-10">
            
            <div class="flex mb-10 bg-gray-50 border-l-4 border-vesak-navy">
                <div class="w-1/2 p-4 border-r border-gray-200">
                    <div class="text-[10px] font-bold text-vesak-gold uppercase mb-1">Billed To</div>
                    <div class="text-lg font-bold text-vesak-navy">{c_name}</div>
                    <div class="flex gap-4 mt-2 text-xs text-gray-600">
                        <div class="flex items-center gap-1"><i class="fas fa-user text-vesak-gold"></i> {c_gender}</div>
                        <div class="flex items-center gap-1"><i class="fas fa-birthday-cake text-vesak-gold"></i> {c_age} Yrs</div>
                    </div>
                </div>
                <div class="w-1/2 p-4 flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                        <i class="fas fa-phone-alt text-vesak-gold w-4"></i> {c_mob}
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-map-marker-alt text-vesak-gold w-4 mt-0.5"></i> 
                        <span class="leading-tight">{c_addr}</span>
                    </div>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="bg-vesak-navy text-white text-xs uppercase tracking-wider text-left">
                        <th class="p-3 w-3/5">Description</th>
                        <th class="p-3 w-2/5 text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-gray-100">
                        <td class="p-4 align-top">
                            <div class="font-bold text-sm text-gray-800">{clean_plan}</div>
                            {desc_col_html}
                        </td>
                        <td class="p-4 text-right font-bold text-sm text-gray-800 align-top">
                            {amount_col_html}
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="grid grid-cols-2 gap-8">
                <div>
                    <h4 class="text-xs font-bold text-vesak-navy uppercase border-b border-vesak-gold pb-1 mb-3">Services Included</h4>
                    <ul class="list-disc pl-4 space-y-1">{inc_html}</ul>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase border-b border-gray-200 pb-1 mb-3">Services Not Included</h4>
                    <ul class="columns-1 text-[10px] text-gray-400 space-y-1">{exc_html}</ul>
                </div>
            </div>

            {notes_section}
            
        </main>

        <footer class="z-10">
            <div class="text-center text-xs text-gray-400 italic mb-4">
                Thank you for choosing Vesak Care Foundation!
            </div>
            <div class="w-full h-px bg-gradient-to-r from-gray-100 via-vesak-gold to-gray-100 opacity-50 mb-4"></div>
            <div class="flex justify-between items-end text-xs text-gray-500">
                <div>
                    <p class="font-serif italic text-vesak-navy mb-1 text-sm">Our Offices</p>
                    <div class="flex gap-2">
                        <span>Pune</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Mumbai</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Kolhapur</span>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <a href="https://www.instagram.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-instagram text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                    
                    <a href="https://www.facebook.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-facebook text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                </div>
            </div>
            <div class="mt-4 w-full h-1 bg-vesak-navy"></div>              
        </footer>
    </div>

    <script>
        function generatePDF() {{
            const element = document.getElementById('invoice-content');
            const opt = {{
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: '{preview_file_name}',
                image: {{ type: 'jpeg', quality: 1 }},
                html2canvas: {{ scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }},
                jsPDF: {{ unit: 'mm', format: 'a4', orientation: 'portrait' }}
            }};
            html2pdf().set(opt).from(element).save();
        }}
    </script>
</body>
</html>
"""
    # ========================================================
    # ‚≠ê BUTTONS MOVED HERE (ABOVE THE PREVIEW)
    # ========================================================
    btn_save = False
    
    if conflict_exists:
        if chk_overwrite:
            if st.button("Overwrite Invoice", type="primary", key=f"b_ov_{mode}"): btn_save = True
        else:
            st.button("Create Invoice", disabled=True, key=f"b_cr_dis_{mode}")
    else:
        if st.button("Create Invoice", type="primary", key=f"b_cr_{mode}"): btn_save = True
    
    st.markdown("---")  # Optional: Visual separator between buttons and preview
    
    # RENDER THE HTML COMPONENT SO THE USER CAN SEE AND CLICK DOWNLOAD
    components.html(html_content, height=1000, scrolling=True)
    # ========================================================

    if btn_save:
        rate = float(row.get('Unit Rate', 0))
        total = rate * billing_qty
        
        service_start_date = format_date_simple(inv_date_val)
        generated_at = datetime.datetime.now().strftime("%d-%m-%Y %H:%M:%S")

        # --- LOGIC FOR DETAILS COLUMN ---
        p_raw_check = str(row.get('Period', '')).strip()
        p_check_lower = p_raw_check.lower()
        shift_raw_check = str(row.get('Shift', '')).strip()
        shift_check_lower = shift_raw_check.lower()
        
        details_text = ""
        
        if "per visit" in shift_check_lower:
            if billing_qty == 1: details_text = f"Paid for {billing_qty} Visit"
            else: details_text = f"Paid for {billing_qty} Visits"
        
        elif "daily" in p_check_lower:
            if billing_qty == 1:
                details_text = f"Paid for {billing_qty} Day"
            elif billing_qty % 7 == 0:
                weeks_val = int(billing_qty / 7)
                if weeks_val == 1: details_text = f"Paid for {weeks_val} Week"
                else: details_text = f"Paid for {weeks_val} Weeks"
            else:
                details_text = f"Paid for {billing_qty} Days"
                
        elif "monthly" in p_check_lower:
            if billing_qty == 1: details_text = f"Paid for {billing_qty} Month"
            else: details_text = f"Paid for {billing_qty} Months"
            
        elif "weekly" in p_check_lower:
            if billing_qty == 1: details_text = f"Paid for {billing_qty} Week"
            else: details_text = f"Paid for {billing_qty} Weeks"
            
        else:
            details_text = f"Paid for {billing_qty} {p_raw_check}"
            
        if mode == "force_new": details_text += " (New)"

        # --- LOGIC FOR HISTORY PLAN NAME SAVING ---
        plan_to_save = c_plan
        sub_service_val = str(row.get('Sub Service', '')).strip()
        
        if c_plan == "Plan F: Rehabilitative Care":
            plan_to_save = f"Plan F: Rehabilitative Care and {sub_service_val}"
        elif c_plan == "A-la-carte Services":
            plan_to_save = f"Other Services - {sub_service_val}"
# Clean credit for save
        final_credit_val = ref_credit_input.strip()
        # If it looks like a float ending in .0, strip it
        if final_credit_val.replace('.', '', 1).isdigit():
             try: final_credit_val = str(int(float(final_credit_val)))
             except: pass  

        record = {
            "UID": "", 
            "Serial No.": c_serial, 
            "Ref. No.": c_ref,        
            "Invoice Number": inv_input, 
            "Date": format_date_with_suffix(inv_date_val),
            "Generated At": generated_at, 
            "Customer Name": c_name,
            "Age": c_age,
            "Gender": c_gender,
            "Location": c_loc,
            "Address": c_addr,
            "Mobile": c_mob, 
            "Plan": plan_to_save,
            "Shift": c_shift,
            "Recurring Service": c_rec,
            "Period": c_period,
            "Visits": c_visits,
            "Amount": rate, 
            "Amount Paid": total, 
            "Notes / Remarks": notes, 
            "Generated By": gen_by_to_save, 
            "Service Started": service_start_date,
            "Service Ended": "",
            "Details": details_text,
            "Paid for Raw": billing_qty,
            "Referral Code": c_ref_code,
            "Referral Name": c_ref_name,
            "Referral Credit": c_ref_credit
        }
        
        # ‚≠ê CHANGE #6: UPDATE vs APPEND LOGIC
        if conflict_exists and chk_overwrite and existing_row_idx:
            # ... existing update code ...
            update_invoice_in_gsheet(record, sheet_obj, existing_row_idx)
            st.success(f"Overwritten Row {existing_row_idx}!")
        else:
            save_invoice_to_gsheet(record, sheet_obj)
            st.success("Created New Row!")
        
        st.balloons()
        
        # ========================================================
        # ‚≠ê CRITICAL FIX: CLEAR CACHE IMMEDIATELY
        # ========================================================
        # This forces the program to re-read the Google Sheet 
        # immediately, updating the Exclusion List and Sequence.
        get_cached_exclusion_list.clear()
        # ========================================================
        
        # ========================================================
        # ‚≠ê RESET LOGIC - TRIGGER RERUN
        # ========================================================
        st.session_state[f"trigger_reset_{mode}"] = True
        time.sleep(0.5) 
        st.rerun()
        # ========================================================

if raw_file_obj:
    try:
        filename = getattr(raw_file_obj, "name", "data.xlsx")
        is_excel = filename.endswith('.xlsx')
        
        if is_excel:
            try:
                df = pd.read_excel(raw_file_obj, sheet_name='Confirmed', engine='openpyxl')
                st.sidebar.success("‚úÖ Reading 'Confirmed' Sheet from Vesak Care - Patient Logs")
            except ValueError:
                st.error("‚ùå CRITICAL ERROR: The sheet 'Confirmed' was not found in the uploaded workbook.")
                st.stop()
        else:
            df = pd.read_csv(raw_file_obj)
        
        df = normalize_columns(df, COLUMN_ALIASES)
        
        with tab1: render_invoice_ui(df, mode="standard")
        
        
        with tab2:
            st.header("¬©Ô∏è Duplicate Invoice")
            client = get_gspread_client()
            mid = extract_id_from_url(sys_config.get("master_sheet_url"))
            dup_date = st.date_input("Select Month:", value=datetime.date.today())
            mmm_yy = dup_date.strftime("%b-%y")
            
            if client and mid:
                try:
                    wb = client.open_by_key(mid)
                    ws = wb.worksheet(mmm_yy)
                    df_hist = pd.DataFrame(ws.get_all_records())
													 
								   
                    if not df_hist.empty and 'Invoice Number' in df_hist.columns:
                        df_hist['Display'] = df_hist['Invoice Number'].astype(str) + " - " + df_hist['Customer Name']
                        
                        # ‚≠ê CHANGE: Default selectbox index to None (Blank by default)
                        sel_dup = st.selectbox("Select Invoice:", df_hist['Display'].unique(), index=None, placeholder="Select an Invoice...")
							   
													 
																																  
																	
                        
                        if sel_dup:
                            row = df_hist[df_hist['Display'] == sel_dup].iloc[0]
                            st.info(f"Selected: {row['Customer Name']}")
                            
                            # Prepare Data for new HTML Preview
                            c_name = row.get("Customer Name", "")
                            c_gender = row.get("Gender", "")
                            c_age = row.get("Age", "")
                            c_mob = row.get("Mobile", "")
                            c_addr = row.get("Address", "")
                            c_plan = row.get("Plan", "")
                            inv_input = row.get("Invoice Number", "")
                            
                            # Clean Date
                            raw_date = row.get("Date", "")
                            preview_date_str = raw_date 
                            
                            # Generate Filename
                            preview_file_name = generate_filename("DUPLICATE", inv_input, c_name)
                            
                            # Helper Data Construction
                            desc_col_html = construct_description_html(row)
                            
                            # Amount logic & Clean Unit Rate (CRITICAL FIX for "0" Amount)
                            qty = 1
                            try:
                                paid_raw = row.get('Paid for', 1)
                                if str(paid_raw).isdigit(): qty = int(paid_raw)
                            except: pass
                            
                            # --- Fix: Clean the Amount from History (Remove commas/symbols) ---
                            try:
                                raw_hist_amt = str(row.get('Amount', '0'))
                                clean_hist_amt = raw_hist_amt.replace(',', '').replace('‚Çπ', '').replace('Rs.', '').strip()
                                row['Unit Rate'] = float(clean_hist_amt)
                            except:
                                row['Unit Rate'] = 0.0
                            # ------------------------------------------------------------------

                            
                            
                            amount_col_html = construct_amount_html(row, qty)
                            
                            # --- Logic for Plan Display Name (Your Requested Logic) ---
                            # Note: In history, 'Sub Service' isn't a separate column, it's merged in 'Plan'.
                            # We extract it loosely for the logic to work.
                            sub_srv_txt = ""
                            if " and " in c_plan: sub_srv_txt = c_plan.split(" and ")[-1]
                            elif " - " in c_plan: sub_srv_txt = c_plan.split(" - ")[-1]
                            
                            pdf_display_plan = c_plan
                            
                            # Match against base names to apply formatting
                            if "Plan A" in c_plan: pdf_display_plan = "Patient Care Service"
                            elif "Plan B" in c_plan: pdf_display_plan = "Nurse Service"
                            elif "Plan C" in c_plan: pdf_display_plan = "Chronic and Holistic Healthcare Service"
                            elif "Plan D" in c_plan: pdf_display_plan = "Elderly and Well-being Care"
                            elif "Plan E" in c_plan: pdf_display_plan = "Maternal & Newborn - Support for Women during and after Pregnancy"
                            elif "Plan F" in c_plan: pdf_display_plan = f"Rehabilitative Care for {sub_srv_txt}"
                            elif "Other" in c_plan or "A-la-carte" in c_plan: pdf_display_plan = f"Other Service - {sub_srv_txt}"
                            
                            clean_plan = pdf_display_plan
                            # ---------------------------------------------------------

                            # Lists Reconstruction 
                            inc_list, exc_list = get_base_lists(c_plan, "All") 
                            inc_html = "".join([f'<li class="mb-1 text-xs text-gray-700">{item}</li>' for item in inc_list])
                            exc_html = "".join([f'<li class="mb-1 text-[10px] text-gray-500">{item}</li>' for item in exc_list])
                            
                            notes = row.get("Notes / Remarks", "")
                            notes_section = ""
                            if notes:
                                notes_section = f"""<div class="mt-6 p-4 bg-gray-50 border border-gray-100 rounded"><h4 class="font-bold text-vesak-navy text-xs mb-1">NOTES:</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">{notes}</p></div>"""

                            # --- HTML CONSTRUCTION FOR TAB 2 ---
                            html_dup = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {{
            theme: {{
                extend: {{
                    colors: {{ vesak: {{ navy: '#002147', gold: '#C5A065', orange: '#CC4E00' }} }},
                    fontFamily: {{ serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }}
                }}
            }}
        }}
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap');
        body {{ font-family: 'Lato', sans-serif; background: #f0f0f0; margin: 0; }}
        .invoice-page {{ position: relative; background: white; width: 210mm; height: 297mm; padding: 30px; padding-bottom: 120px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); display: flex; flex-direction: column; margin-left: auto; margin-right: auto; }}
        main {{ flex: none; }}
        footer {{ position: absolute; bottom: 7mm; left: 30px; right: 30px; text-align: center; }}
        .watermark-container {{ position: fixed; top: 148.5mm; left: 50%; transform: translateX(-50%) translateY(-50%); pointer-events: none; z-index: 0; }}
        .watermark-text {{ font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 800; color: rgba(0, 33, 71, 0.04); letter-spacing: 0.25em; }}
        @media print {{
            body {{ background: white; -webkit-print-color-adjust: exact; }}
            .invoice-page {{ width: 210mm; height: 297mm; padding: 20px; padding-bottom: 90px; box-shadow: none; }}
            footer {{ bottom: 7mm; width: calc(100% - 40px); }}
            .no-print {{ display: none !important; }}
            .watermark-container {{ opacity: 0.04 !important; }}
        }}
    </style>
</head>
<body class="py-10">
    <div class="max-w-[210mm] mx-auto mb-6 flex justify-end gap-3 no-print px-4">
        <button onclick="window.print()" class="bg-gray-600 text-white px-5 py-2 rounded shadow hover:bg-gray-800 transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-print mr-2"></i> Print / Save Vector PDF
        </button>
        <button onclick="generatePDF()" class="bg-vesak-navy text-white px-6 py-2 rounded shadow hover:bg-vesak-gold transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-download mr-2"></i> Download PDF
        </button>
    </div>

    <div class="invoice-page" id="invoice-content">
        <div class="watermark-container">
            <img src="data:image/png;base64,{logo_b64}" style="display:block; margin:0; padding:0; width:300px; opacity:0.04;">
            <div class="watermark-text mt-4">VESAK</div>
        </div>

        <header class="relative z-10 w-full mb-10">
            <div class="flex justify-between items-start border-b border-gray-100 pb-6">
                <div class="flex items-center gap-5">
                    <img src="data:image/png;base64,{logo_b64}" class="w-20 h-auto">
												
																		  
						
																 
																							  
																										   
																				 
						
																												   
																 
						
																					 
																			 
						
																								   
													 
																											 
										
						
																													
																										 
						
																	 
                    <div>
                        <h1 class="font-serif text-2xl font-bold text-vesak-navy tracking-wide leading-none mb-2">
                            Vesak Care <span class="text-vesak-gold font-normal">Foundation</span>
                        </h1>
                        <div class="flex flex-col text-xs text-gray-500 font-light tracking-wide space-y-0.5">
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Web</span> vesakcare.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Email</span> vesakcare@gmail.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Phone</span> +91 7777 000 878</span>
									 
																																																																																		   
												 
									 
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block font-serif text-3xl text-gray-200 tracking-widest mb-2">INVOICE</span>
                    <div class="text-xs text-vesak-navy">
                        <div class="mb-1"><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">Date</span> <b>{preview_date_str}</b></div>
                        <div><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">No.</span> <b>{inv_input}</b></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow relative z-10">
            
            <div class="flex mb-10 bg-gray-50 border-l-4 border-vesak-navy">
                <div class="w-1/2 p-4 border-r border-gray-200">
                    <div class="text-[10px] font-bold text-vesak-gold uppercase mb-1">Billed To</div>
                    <div class="text-lg font-bold text-vesak-navy">{c_name}</div>
                    <div class="flex gap-4 mt-2 text-xs text-gray-600">
                        <div class="flex items-center gap-1"><i class="fas fa-user text-vesak-gold"></i> {c_gender}</div>
                        <div class="flex items-center gap-1"><i class="fas fa-birthday-cake text-vesak-gold"></i> {c_age} Yrs</div>
                    </div>
                </div>
                <div class="w-1/2 p-4 flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                        <i class="fas fa-phone-alt text-vesak-gold w-4"></i> {c_mob}
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-map-marker-alt text-vesak-gold w-4 mt-0.5"></i> 
                        <span class="leading-tight">{c_addr}</span>
                    </div>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="bg-vesak-navy text-white text-xs uppercase tracking-wider text-left">
                        <th class="p-3 w-3/5">Description</th>
                        <th class="p-3 w-2/5 text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-gray-100">
                        <td class="p-4 align-top">
                            <div class="font-bold text-sm text-gray-800">{clean_plan}</div>
                            {desc_col_html}
                        </td>
                        <td class="p-4 text-right font-bold text-sm text-gray-800 align-top">
                            {amount_col_html}
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="grid grid-cols-2 gap-8">
                <div>
                    <h4 class="text-xs font-bold text-vesak-navy uppercase border-b border-vesak-gold pb-1 mb-3">Services Included</h4>
                    <ul class="list-disc pl-4 space-y-1">{inc_html}</ul>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase border-b border-gray-200 pb-1 mb-3">Services Not Included</h4>
                    <ul class="columns-1 text-[10px] text-gray-400 space-y-1">{exc_html}</ul>
                </div>
            </div>

            {notes_section}
            
        </main>

        <footer class="z-10">
            <div class="text-center text-xs text-gray-400 italic mb-4">
                Thank you for choosing Vesak Care Foundation!
            </div>
            <div class="w-full h-px bg-gradient-to-r from-gray-100 via-vesak-gold to-gray-100 opacity-50 mb-4"></div>
            <div class="flex justify-between items-end text-xs text-gray-500">
                <div>
                    <p class="font-serif italic text-vesak-navy mb-1 text-sm">Our Offices</p>
                    <div class="flex gap-2">
                        <span>Pune</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Mumbai</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Kolhapur</span>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <a href="https://www.instagram.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-instagram text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                    
                    <a href="https://www.facebook.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-facebook text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                </div>
            </div>
            <div class="mt-4 w-full h-1 bg-vesak-navy"></div>              
        </footer>
    </div>

    <script>
        function generatePDF() {{
            const element = document.getElementById('invoice-content');
            const opt = {{
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: '{preview_file_name}',
                image: {{ type: 'jpeg', quality: 1 }},
                html2canvas: {{ scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }},
                jsPDF: {{ unit: 'mm', format: 'a4', orientation: 'portrait' }}
            }};
            html2pdf().set(opt).from(element).save();
        }}
    </script>
</body>
</html>
"""
																								
						
								
                            components.html(html_dup, height=1000, scrolling=True)

                    else: st.warning("No records found in this month.")
																							
                except Exception as e: st.error(f"Could not load history for this month: {e}")

        with tab3:
            st.header("üõ† Manage Services")
            
            client_srv = get_gspread_client()
            mid_srv = extract_id_from_url(sys_config.get("master_sheet_url"))
            
            if client_srv and mid_srv:
                try:
                    wb_srv = client_srv.open_by_key(mid_srv)
                    cur_month_srv = datetime.date.today().strftime("%b-%y")
                    try:
                        ws_srv = wb_srv.worksheet(cur_month_srv)
                        data_srv = ws_srv.get_all_records()
                        df_srv = pd.DataFrame(data_srv)
                        
                        if not df_srv.empty and 'Customer Name' in df_srv.columns:
                            # Filter: Show only customers where 'Service Ended' is BLANK
                            if 'Service Ended' in df_srv.columns:
                                df_active = df_srv[df_srv['Service Ended'].astype(str).str.strip() == ""]
                                
                                if not df_active.empty:
                                    # Create Display Label: Name (Invoice No)
                                    df_active['Display'] = df_active['Customer Name'] + " (" + df_active['Invoice Number'].astype(str) + ")"
                                    
                                    # a. Selectbox Default is Blank (index=None)
                                    sel_srv = st.selectbox(
                                        "Select Customer to End Service:", 
                                        df_active['Display'].unique(), 
                                        index=None, 
                                        placeholder="Select active customer..."
                                    )
                                    
                                    if sel_srv:
                                        row_srv = df_active[df_active['Display'] == sel_srv].iloc[0]
                                        st.warning(f"You are ending service for: **{row_srv['Customer Name']}**")
                                        
                                        # e. End Service Button
                                        if st.button("üõë Confirm End Service", type="primary"):
                                            try:
                                                # Find the cell to update using Invoice Number (Unique)
                                                cell = ws_srv.find(str(row_srv['Invoice Number']))
                                                if cell:
                                                    r_idx = cell.row
                                                    # Column X is index 24
                                                    today_str = datetime.date.today().strftime("%d-%m-%Y")
                                                    
                                                    # Update 'Service Ended' (Col 24 / X)
                                                    ws_srv.update_cell(r_idx, 24, today_str)
                                                    
                                                    # d. Format Cell Color to Red (#ea9999)
                                                    # Target 1: Service Ended (X) -> f"X{r_idx}"
                                                    # Target 2: Invoice Number (D) -> f"D{r_idx}"
                                                    
                                                    red_format = {
                                                        "backgroundColor": {
                                                            "red": 0.9176, "green": 0.6, "blue": 0.6
                                                        }
                                                    }
                                                    
                                                    # Apply to both cells
                                                    ws_srv.format(f"X{r_idx}", red_format)
                                                    ws_srv.format(f"D{r_idx}", red_format)									  
																						  
                                                    
                                                    st.success(f"‚úÖ Service Ended for {row_srv['Customer Name']}!")
                                                    
                                                    # f. Force Clear Cache Immediately
                                                    get_cached_exclusion_list.clear()
                                                    time.sleep(1)
                                                    st.rerun()
                                            except Exception as ex:
                                                st.error(f"Update failed: {ex}")
                                else:
                                    st.success("‚úÖ All services in this month are currently Ended or Empty.")
                            else:
                                st.error("Column 'Service Ended' missing in Sheet.")
                        else:
                            st.warning("No records found in this month's sheet.")
                            
                    except gspread.exceptions.WorksheetNotFound:
                        st.error(f"Sheet '{cur_month_srv}' not found.")
                except Exception as e:
                    st.error(f"Connection Error: {e}")
            else:
                st.error("Please configure Master Sheet URL in sidebar.")
		
# ‚≠ê REPLACE ENTIRE 'with tab4:' BLOCK
        with tab4:
            st.header("üí∞ Nurse Management")
            
            client_nur = get_gspread_client()
            mid_nur = extract_id_from_url(sys_config.get("master_sheet_url"))
            
            if client_nur and mid_nur:
                try:
                    wb_nur = client_nur.open_by_key(mid_nur)
                    cur_month_nur = datetime.date.today().strftime("%b-%y")
                    ws_nur = wb_nur.worksheet(cur_month_nur)
                    
                    # Get all data for filtering
                    data_nur = ws_nur.get_all_records()
                    df_nur = pd.DataFrame(data_nur)
                    
                    if not df_nur.empty and 'Invoice Number' in df_nur.columns:
                        # h. Switch List Toggle
                        show_exist_nur = st.toggle("üìÇ Switch List: Mode (Overwrite Existing Nurse Data)")
                        
                        # Filter Logic based on 'Nurse Payment' (Col AC)
                        if 'Nurse Payment' in df_nur.columns:
                            # Clean payment column to string for checking
                            df_nur['Pay_Str'] = df_nur['Nurse Payment'].astype(str).str.strip()
                            
                            if show_exist_nur:
                                # Switch ON: Show customers WITH payment data
                                df_target = df_nur[df_nur['Pay_Str'] != ""]
                            else:
                                # Switch OFF: Show customers WITHOUT payment data (New Entry)
                                df_target = df_nur[df_nur['Pay_Str'] == ""]
                                
                            if not df_target.empty:
                                df_target['Display'] = df_target['Customer Name'] + " (" + df_target['Invoice Number'].astype(str) + ")"
                                
                                # g. Select Customer (Default None/Blank)
                                sel_nur = st.selectbox(
                                    "Select Customer:", 
                                    df_target['Display'].unique(), 
                                    index=None,
                                    placeholder="Select a customer..."
                                )
                                
                                # Defaults for input fields (Empty by default)
                                val_name = ""
                                val_extra = ""
                                val_note = ""
                                val_pay = 0
                                is_editable = False # Disable until customer is selected
                                
                                if sel_nur:
                                    is_editable = True # Unlock fields when selected
                                    # i. If Overwrite Mode: Pull existing data from sheet
                                    if show_exist_nur:
                                        row_nur = df_target[df_target['Display'] == sel_nur].iloc[0]
                                        val_name = str(row_nur.get('Nurse Name', ''))         # Col AF
                                        val_extra = str(row_nur.get('Nurse Name (Extra)', '')) # Col AG
                                        val_note = str(row_nur.get('Nurse Note', ''))          # Col AH
                                        # Parse Payment (Col AC) safely
                                        try: val_pay = int(float(str(row_nur.get('Nurse Payment', 0)).replace(',', '')))
                                        except: val_pay = 0

                                # UI: Four Text Boxes (ALWAYS EDITABLE)
                                st.divider()
                                c1, c2 = st.columns(2)
                                with c1:
                                    # b. Nurse Name
                                    in_name = st.text_input("Nurse Name:", value=val_name, key="n_nm")
                                    # c. Nurse Name (Extra)
                                    in_extra = st.text_input("Nurse Name (Extra):", value=val_extra, key="n_ex")
                                with c2:
                                    # e. Nurse Payment (Numbers Only, No Decimal)
                                    in_pay = st.number_input("Nurse Payment (No Decimals):", min_value=0, value=val_pay, step=1, format="%d", key="n_py")
                                    # d. Nurse Note
                                    in_note = st.text_area("Nurse Note:", value=val_note, key="n_nt")
                                
                                # Update Button (Only visible if customer selected)
                                if is_editable:
                                    btn_label = "Update / Overwrite Data" if show_exist_nur else "Add Nurse Payment"
                                    if st.button(btn_label, type="primary"):
                                        row_save = df_target[df_target['Display'] == sel_nur].iloc[0]
                                        inv_num = row_save['Invoice Number']
                                        
                                        success = update_nurse_management(
                                            ws_nur, inv_num, in_pay, in_name, in_extra, in_note
                                        )
                                        
                                        if success:
                                            st.success("‚úÖ Nurse details updated successfully!")
                                            time.sleep(1)
                                            st.rerun()
                                    st.info("üëÜ Please select a customer to enable the Update button.")	 
                            else:
                                msg = "No customers found with existing Nurse Payments." if show_exist_nur else "No customers found requiring new Nurse Payment."
                                st.info(msg)
                        else:
                            st.error("Column 'Nurse Payment' not found in Master Sheet.")
                    else:
                        st.warning("No data found in Master Sheet.")
                        
                except Exception as e:
                    st.error(f"Connection Error: {e}")

        with tab5:
            st.header("üìù Create Agreements (Nurse/Patient)")
            
            # --- 1. Selection & Filtering ---
            col_sel_1, col_sel_2 = st.columns([1, 2])
            
            with col_sel_1:
                use_filt_ag = st.checkbox("üîç Enable Filters", key="use_filt_ag")
                if use_filt_ag:
                    f_dt = st.date_input("Filter Date:", value=datetime.date.today(), key="ag_dt")
                    u_locs = ["All"] + sorted(list(df['Location'].astype(str).unique()))
                    f_lc = st.selectbox("Filter Location:", u_locs, key="ag_lc")
                
                # Filter Data
                df_ag = df.copy()
                if use_filt_ag:
                    if 'Call Date' in df_ag.columns:
                        df_ag['TempDate'] = pd.to_datetime(df_ag['Call Date'], errors='coerce').dt.date
                        df_ag = df_ag[df_ag['TempDate'] == f_dt]
                    if f_lc != "All":
                        df_ag = df_ag[df_ag['Location'].astype(str) == f_lc]
                        
                df_ag['Label'] = df_ag['Name'].astype(str) + " (" + df_ag['Mobile'].astype(str) + ")"
                
                sel_cust_ag = st.selectbox("Select Customer:", [""] + list(df_ag['Label'].unique()), key="sel_ag")

            # --- 2. Input Form (Visible only upon selection) ---
            if sel_cust_ag:
                row_ag = df_ag[df_ag['Label'] == sel_cust_ag].iloc[0]
                
                # Extract Base Data
                c_plan = str(row_ag.get('Service Required', ''))
                c_sub = str(row_ag.get('Sub Service', ''))
                c_ref_name = str(row_ag.get('Referral Name', '')) # Nurse Name Source
                c_ref_name_extra = str(row_ag.get('Referral Name', '')) # Fallback for extra
                c_loc = str(row_ag.get('Location', ''))
                c_date_raw = row_ag.get('Date', datetime.date.today())
                c_formatted_date = format_date_with_suffix(c_date_raw)
                
                # Determine Role based on Plan
                role_default = "Caregiver"
                is_physio = False
                is_attendant = False
                
                if "Plan B" in c_plan: role_default = "Nurse"
                elif "Plan F" in c_plan: 
                    role_default = "Physiotherapist"
                    is_physio = True
                elif "A-la-carte" in c_plan: 
                    role_default = "Attendant"
                    is_attendant = True
                else: 
                    # Default list for Plan A, C, D, E
                    role_default = "Nurse" 

                with col_sel_2:
                    st.info(f"**Selected Plan:** {c_plan} | **Sub Service:** {c_sub}")
                    st.success(f"**Auto-Detected Role:** {role_default}")

                st.divider()
                st.subheader("1. Agreement Details Input")
                
                # Dynamic Role Selection (User can override)
                role_options = ["Nurse", "Caregiver", "Attendant", "Physiotherapist"]
                if role_default not in role_options: role_options.append(role_default)
                
                col_inp_1, col_inp_2, col_inp_3 = st.columns(3)
                
                with col_inp_1:
                    sel_role = st.selectbox("Select Role Title:", role_options, index=role_options.index(role_default), key="role_sel")
                    
                    # Logic: Name Field Label
                    name_label = f"{sel_role} Name"
                    val_name = c_ref_name # Default from Referral Name
                    in_nurse_name = st.text_input(name_label, value=val_name, key="in_nn")
                    
                    in_nurse_age = st.text_input("Age:", key="in_na")
                    in_nurse_aad = st.text_input("Aadhar No:", key="in_nad")
                    
                with col_inp_2:
                    st.write("üìç **Location Details**")
                    in_city = st.text_input("City (e.g., Mumbai/Pune):", value=c_loc, key="in_ct")
                    in_date_str = st.text_input("Agreement Date Text:", value=c_formatted_date, help="e.g., 25th day of Jan, 2026", key="in_dt")
                    in_nurse_addr = st.text_area("Residing Address:", height=100, key="in_adr")

                with col_inp_3:
                    # EXTRA FIELDS (Conditional)
                    # Logic: Remove Extra boxes if Plan F or A-la-carte
                    if not (is_physio or is_attendant):
                        st.write("‚ûï **Extra Staff (Optional)**")
                        in_extra_name = st.text_input(f"{sel_role} Name (Extra):", key="in_ex_n")
                        in_extra_age = st.text_input("Age (Extra):", key="in_ex_a")
                        in_extra_aad = st.text_input("Aadhar (Extra):", key="in_ex_aad")
                        in_extra_addr = st.text_area("Address (Extra):", height=68, key="in_ex_adr")
                    else:
                        st.empty() # Placeholder to keep layout aligned

                # --- 2. Generation & Preview ---
                st.divider()
                st.subheader("2. Generate Document")
                
                lang_sel = st.radio("Select Document Language:", ["English", "Hindi", "Marathi"], horizontal=True)
                
                # Combine Data for Generator
                data_packet = {
                    "city": in_city,
                    "date": in_date_str,
                    "nurse_name": in_nurse_name,
                    "nurse_age": in_nurse_age,
                    "nurse_aadhar": in_nurse_aad,
                    "nurse_addr": in_nurse_addr,
                    "role": sel_role,
                    "plan": c_plan,
                    "sub_service": c_sub
                }
                
                # Append Extra info if exists
                if not (is_physio or is_attendant) and 'in_extra_name' in locals() and in_extra_name:
                    data_packet["nurse_name"] += f" & {in_extra_name}"
                    if in_extra_age: data_packet["nurse_age"] += f" / {in_extra_age}"
                    if in_extra_aad: data_packet["nurse_aadhar"] += f" / {in_extra_aad}"
                    if in_extra_addr: data_packet["nurse_addr"] += f" & {in_extra_addr}"

                # Generate HTML
                html_preview = generate_agreement_html(data_packet, lang=lang_sel)
                
                # Show Buttons
                c_btn_1, c_btn_2 = st.columns([1, 4])
                with c_btn_1:
                    # Using HTML/JS print within the component is safer for local download
                    # We render a hidden button in the HTML logic, but here is a backup Streamlit button
                    # Converting to PDF bytes for streamlit download button
                    pdf_bytes = convert_html_to_pdf(html_preview)
                    if pdf_bytes:
                        fname = generate_filename("Nurse", "AGR", in_nurse_name)
                        st.download_button(
                            label=f"‚¨áÔ∏è Download PDF ({lang_sel})",
                            data=pdf_bytes,
                            file_name=fname,
                            mime="application/pdf",
                            type="primary"
                        )
                
                # Render Preview
                st.markdown("### üìÑ Document Preview")
                components.html(html_preview, height=1200, scrolling=True)

    except Exception as e: st.error(f"Error: {e}")
