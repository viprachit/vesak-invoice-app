import streamlit as st
import pandas as pd
import base64
import os
import datetime
import requests
import math 
import re 
import json
import time 
from io import BytesIO
from PIL import Image, ImageFile
import streamlit.components.v1 as components
from xhtml2pdf import pisa 
import gspread
from google.oauth2.service_account import Credentials
import numpy as np

# --- CRITICAL FIX FOR BROKEN IMAGES ---
ImageFile.LOAD_TRUNCATED_IMAGES = True

# ==========================================
# 1. SETUP & CONFIGURATION
# ==========================================
st.set_page_config(page_title="Vesak Care Invoice", layout="wide", page_icon="üè•")

LOGO_FILE = "logo.png"
URL_CONFIG_FILE = "url_config.txt"
SYSTEM_CONFIG_FILE = "system_config.json" 

# --- HEADERS (34 COLUMNS) ---
# ‚≠ê CHANGE: Swapped positions of Referral Name (now Y) and Referral Code (now Z)
SHEET_HEADERS = [
    "UID", "Serial No.", "Ref. No.", "Invoice Number", "Date", "Generated At",
    "Customer Name", "Age", "Gender", "Location", "Address", "Mobile",
    "Plan", "Shift", "Recurring Service", "Period", "Visits", "Amount",
    "Notes / Remarks", "Generated By", "Amount Paid", "Details",
    "Service Started", "Service Ended", "Referral Name", "Referral Code",
    "Referral Credit", "Net Amount", "Nurse Payment", "Paid for", "Earnings",
    "Nurse Name", "Nurse Name (Extra)", "Nurse Note" 
]

# --- SESSION STATE INITIALIZATION ---
if 'chk_overwrite' not in st.session_state: st.session_state.chk_overwrite = False
if 'show_existing_customers' not in st.session_state: st.session_state.show_existing_customers = False    

# --- CONFIGURATION LOADER ---
def load_system_config():
    default_config = {
        "master_sheet_url": "",
        "backup_sheet_url": ""
    }
    if os.path.exists(SYSTEM_CONFIG_FILE):
        try:
            with open(SYSTEM_CONFIG_FILE, "r") as f:
                return json.load(f)
        except: return default_config
    return default_config

def save_system_config(config_data):
    with open(SYSTEM_CONFIG_FILE, "w") as f:
        json.dump(config_data, f)

def load_config_path(file_name):
    if os.path.exists(file_name):
        with open(file_name, "r") as f: return f.read().strip()
    return ""

def save_config_path(path, file_name):
    with open(file_name, "w") as f: f.write(path.replace('"', '').strip())
    return path

def extract_id_from_url(url):
    if not url: return ""
    match = re.search(r"/d/([a-zA-Z0-9-_]+)", url)
    if match: return match.group(1)
    if len(url) > 20 and "/" not in url: return url
    return ""

sys_config = load_system_config()

# --- GOOGLE AUTHENTICATION ---
@st.cache_resource
def get_credentials():
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        s_info = st.secrets["connections"]["gsheets"]
        private_key = s_info.get("private_key").replace("\\n", "\n")
        creds_dict = {
            "type": s_info.get("type"),
            "project_id": s_info.get("project_id"),
            "private_key_id": s_info.get("private_key_id"),
            "private_key": private_key,
            "client_email": s_info.get("client_email"),
            "client_id": s_info.get("client_id"),
            "auth_uri": s_info.get("auth_uri"),
            "token_uri": s_info.get("token_uri"),
            "auth_provider_x509_cert_url": s_info.get("auth_provider_x509_cert_url"),
            "client_x509_cert_url": s_info.get("client_x509_cert_url"),
        }
        return Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return None

def get_gspread_client():
    creds = get_credentials()
    if creds: return gspread.authorize(creds)
    return None

# ==========================================
# FILE HANDLING & HELPERS
# ==========================================
@st.cache_data(ttl=180, show_spinner=False)
def robust_file_downloader(url):
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Referer': 'https://www.google.com/'
    })
    download_url = url
    if "?" in url: base_url = url.split("?")[0]
    else: base_url = url
    if "1drv.ms" in url or "sharepoint" in url or "onedrive" in url:
        download_url = base_url + "?download=1"
    try:
        response = session.get(download_url, verify=False, allow_redirects=True)
        if response.status_code == 200:
            return BytesIO(response.content)
        raise Exception(f"Status Code: {response.status_code}")
    except Exception as e: return None

def format_date_with_suffix(d):
    """
    Returns date in format: "Jan 23rd 2026"
    """
    if pd.isna(d): return "N/A"
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        if not isinstance(d, datetime.date): return str(d)
        
        day = d.day
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(day % 10, "th") if not 10 < day < 14 else "th"
        return d.strftime(f"%b. {day}{suffix} %Y")
    except: return str(d)

def format_date_simple(d):
    """
    Returns date in format: "DD-MM-YYYY" (No Time)
    """
    if pd.isna(d): return ""
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        return d.strftime("%d-%m-%Y")
    except: return str(d)

def clean_text(text): return str(text).strip() if isinstance(text, str) else str(text)

# ===== CRITICAL FIX 1: ID NORMALIZATION (NO DECIMALS) =====
def normalize_id(val):
	   
						 
																	   
												 
										 
							 
	   
    if pd.isna(val): return ""
    s_val = str(val).strip()
    if s_val == "" or s_val.lower() == "nan": return ""
    try:
        return str(int(float(s_val)))
    except:
        return s_val

# --- CRITICAL FIX 2: CLEAN REFERRAL DATA (NO 'nan') ---
def clean_referral_field(val):
	   
																  
									  
	   
    if pd.isna(val): return ""
    s_val = str(val).strip()
    if s_val.lower() == "nan": return ""
    if s_val.lower() == "none": return ""
    if s_val == "": return ""
    return s_val

# --- CRITICAL FIX 3: CACHED EXCLUSION LIST (FIXES 429 ERROR) ---
@st.cache_data(ttl=300, show_spinner=False)
def get_cached_exclusion_list(master_id, month_str):
	   
																				 
	   
    client = get_gspread_client()
    if not client or not master_id: return []
	
    excluded_refs = []
    try:
        wb = client.open_by_key(master_id)
        try:
            sheet_check = wb.worksheet(month_str)
            data_check = sheet_check.get_all_records()
            df_check = pd.DataFrame(data_check)
			
            if not df_check.empty:
                df_check['Ref_Norm'] = df_check['Ref. No.'].apply(normalize_id)
                df_check['Ser_Norm'] = df_check['Serial No.'].apply(normalize_id)
                
                # Check for existing invoices (regardless of ended service)
                # We need all Ref-Serial pairs present in history
 
 
	
                for _, row in df_check.iterrows():
                    key = f"{row['Ref_Norm']}-{row['Ser_Norm']}"
                    excluded_refs.append(key)
        except gspread.exceptions.WorksheetNotFound: pass
    except Exception as e:
        return []
		
    return excluded_refs

# ==========================================
# SECTION 1: FUNCTION 2 - ENHANCED generate_filename()
# ==========================================
def generate_filename(doc_type, invoice_no, customer_name):
	   
										   
												  
										 
	   
    prefix = {
        "Invoice": "IN", 
        "Nurse": "NU", 
        "Patient": "PA",
        "DUPLICATE INVOICE": "DUP"
    }.get(doc_type, "DOC")
    
    clean_name = re.sub(r'[^a-zA-Z0-9]', '-', str(customer_name)).upper().strip('-')
    invoice_no_clean = str(invoice_no).strip()
    
    return f"{prefix}-{invoice_no_clean}-{clean_name}.pdf"

# --- HELPER FUNCTIONS FOR LISTS ---
def get_base_lists(selected_plan, selected_sub_service):
    SERVICES_MASTER = {
        "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
        "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
        "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
        "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
        "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
        "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
        "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
    }
    STANDARD_PLANS = list(SERVICES_MASTER.keys())[:5]
    
    # Fuzzy match plan name if it was modified (e.g. Plan F with suffix)
    base_plan = selected_plan
    if selected_plan not in SERVICES_MASTER:
        for k in SERVICES_MASTER.keys():
            if k in selected_plan:
                base_plan = k
                break

    master_list = SERVICES_MASTER.get(base_plan, [])
    if "All" in str(selected_sub_service) and base_plan in STANDARD_PLANS:
        included_raw = [s for s in master_list if s.lower() != "all"]
    else: included_raw = [x.strip() for x in str(selected_sub_service).split(',')]
    included_clean = sorted(list(set([clean_text(s) for s in included_raw if clean_text(s)])))
    not_included_clean = []
    if base_plan in STANDARD_PLANS:
        for plan_name in STANDARD_PLANS:
            if plan_name == base_plan: continue 
            for item in SERVICES_MASTER.get(plan_name, []):
                if item.lower() == "all": continue
                cleaned = clean_text(item)
                if cleaned: not_included_clean.append(cleaned)
    else:
        for item in master_list:
            cleaned = clean_text(item)
            if cleaned and cleaned not in included_clean: not_included_clean.append(cleaned)
    return included_clean, list(set(not_included_clean))

# --- NEW HTML HELPERS ---
def construct_description_html(row):
    shift_raw = str(row.get('Shift', '')).strip()
    recurring = str(row.get('Recurring Service', '')).strip().lower()
    period_raw = str(row.get('Period', '')).strip()
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_str = shift_map.get(shift_raw, shift_raw)
    time_suffix = " (Time)" if "12" in shift_str else ""
    return f"""<div style="margin-top: 4px;"><div style="font-size: 12px; color: #4a4a4a; font-weight: bold;">{shift_str}{time_suffix}</div><div style="font-size: 10px; color: #777; font-style: italic; margin-top: 2px;">{period_raw}</div></div>"""

def construct_amount_html(row, billing_qty):
    try: unit_rate = float(row.get('Unit Rate', 0)) 
    except: 
        try: unit_rate = float(row.get('Amount', 0))
        except: unit_rate = 0.0
        
    try: visits_needed = int(float(row.get('Visits', 0)))
    except: visits_needed = 0
    
    # --- 1. DEFINE DETAILS TEXT (Fixes NameError) ---
    p_raw_check = str(row.get('Period', '')).strip()
    p_check_lower = p_raw_check.lower()
    shift_raw_check = str(row.get('Shift', '')).strip()
    shift_check_lower = shift_raw_check.lower()
    
    details_text = ""
    
    if "per visit" in shift_check_lower:
        if billing_qty == 1: details_text = f"Paid for {billing_qty} Visit"
        else: details_text = f"Paid for {billing_qty} Visits"
    
    elif "daily" in p_check_lower:
        if billing_qty == 1:
            details_text = f"Paid for {billing_qty} Day"
        elif billing_qty % 7 == 0:
            weeks_val = int(billing_qty / 7)
            if weeks_val == 1: details_text = f"Paid for {weeks_val} Week"
            else: details_text = f"Paid for {weeks_val} Weeks"
        else:
            details_text = f"Paid for {billing_qty} Days"
            
    elif "monthly" in p_check_lower:
        if billing_qty == 1: details_text = f"Paid for {billing_qty} Month"
        else: details_text = f"Paid for {billing_qty} Months"
        
    elif "weekly" in p_check_lower:
        if billing_qty == 1: details_text = f"Paid for {billing_qty} Week"
        else: details_text = f"Paid for {billing_qty} Weeks"
        
    else:
        details_text = f"Paid for {billing_qty} {p_raw_check}"

    # --- 2. BILLING NOTE LOGIC ---
    billing_note = ""
    is_per_visit = "per visit" in shift_check_lower
    
    if is_per_visit:
        if visits_needed > 1 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif billing_qty >= visits_needed: billing_note = f"Paid for {visits_needed} Visits."
        elif visits_needed == 1: billing_note = "Paid for 1 Visit."
        elif billing_qty < visits_needed: billing_note = f"Next Bill will be Generated after {billing_qty} Visits."
        else: billing_note = details_text
        
    elif "month" in p_check_lower or "week" in p_check_lower:
        base_unit = "Month" if "month" in p_check_lower else "Week"
        plural_unit = base_unit + "s" if billing_qty > 1 else base_unit
        
        if visits_needed > 1 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif visits_needed > billing_qty: billing_note = f"Next Bill will be Generated after {billing_qty} {plural_unit}."
        else: billing_note = details_text
        
    elif "daily" in p_check_lower:
        if 1 < visits_needed < 6 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif billing_qty >= visits_needed: billing_note = f"Paid for {visits_needed} Days."
        elif visits_needed == 1: billing_note = "Paid for 1 Day."
        elif billing_qty < visits_needed: billing_note = f"Next Bill will be Generated after {billing_qty} Days."
        else: billing_note = details_text

    total_amount = unit_rate * billing_qty
    
    # --- 3. SHIFT & PERIOD DISPLAY LOGIC ---
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_display = shift_map.get(shift_raw_check, shift_raw_check)
    if "12" in shift_display and "Time" not in shift_display: shift_display += " (Time)"
    
    # Logic: Monthly -> Month, Weekly -> Week, Daily -> Day
    period_display = p_raw_check # Default fallback
    if "month" in p_check_lower: period_display = "Month"
    elif "week" in p_check_lower: period_display = "Week"
    elif "daily" in p_check_lower: period_display = "Day"
    
    # Remove "Visit" from period display if it's per visit (handled in rate_line_html below)
    
    unit_rate_str = "{:,.0f}".format(unit_rate)
    total_amount_str = "{:,.0f}".format(total_amount)
    
    # --- 4. RATE LINE FORMATTING (Per Visit Logic) ---
    if is_per_visit:
        # RESULT: Per Visit = ‚Çπ 900
        rate_line_html = f"{shift_display} = <b>‚Çπ {unit_rate_str}</b>"
    else:
        # RESULT: 12 Hours.. / Month = ‚Çπ 30,000
        rate_line_html = f"{shift_display} / {period_display} = <b>‚Çπ {unit_rate_str}</b>"

    # --- 5. CHECK FOR OVERRIDE FROM TAB 2 ---
    if 'Details_Override' in row:
        paid_for_text = row['Details_Override']
    else:
        paid_for_text = details_text

    return f"""
    <div style="text-align: right; font-size: 13px; color: #555;">
        <div style="margin-bottom: 4px;">{rate_line_html}</div>
        <div style="color: #CC4E00; font-weight: bold; font-size: 14px; margin: 2px 0;">X</div>
        <div style="font-weight: bold; font-size: 13px; margin: 2px 0; color: #333;">{paid_for_text}</div>
        <div style="border-bottom: 1px solid #ccc; width: 100%; margin: 6px 0;"></div>
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px;">
            <span style="font-size: 13px; font-weight: 800; color: #002147; text-transform: uppercase;">TOTAL - </span>
            <span style="font-size: 16px; font-weight: bold; color: #000;">Rs. {total_amount_str}</span>
        </div>
        <div style="font-size: 10px; color: #666; font-style: italic; margin-top: 6px;">{billing_note}</div>
    </div>
    """

# ==========================================
# FUNCTION 5: KEEP YOUR EXISTING convert_html_to_pdf()
# ==========================================
def convert_html_to_pdf(source_html):
    """
    Converts HTML to PDF using xhtml2pdf.
    NOTE: This function is now a FALLBACK for compatibility.
    """
    result = BytesIO()
    pisa_status = pisa.CreatePDF(source_html, dest=result)
    if pisa_status.err: 
        return None
    return result.getvalue()

def normalize_columns(df, aliases):
    df.columns = df.columns.astype(str).str.strip()
    for standard_name, possible_aliases in aliases.items():
        if standard_name in df.columns: continue 
        for alias in possible_aliases:
            for df_col in df.columns:
                if df_col.lower() == alias.lower():
                    df.rename(columns={df_col: standard_name}, inplace=True); break 
    return df

COLUMN_ALIASES = {
    'Serial No.': ['Serial No.', 'serial no', 'sr no', 'sr. no.', 'id'],
    'Ref. No.': ['Ref. No.', 'ref no', 'ref. no.', 'reference no', 'reference number'],
    'Name': ['Name', 'name', 'patient name', 'client name'],
    'Mobile': ['Mobile', 'mobile', 'phone', 'contact'],
    'Location': ['Location', 'location', 'city'], 
    'Address': ['Address', 'address', 'residence'],
    'Gender': ['Gender', 'gender', 'sex'],
    'Age': ['Age', 'age'],
    'Service Required': ['Service Required', 'service required', 'plan'],
    'Sub Service': ['Sub Service', 'sub service', 'sub plan'],
    'Final Rate': ['Final Rate', 'final rate', 'amount', 'total amount'],
    'Unit Rate': ['Rate Agreed (‚Çπ)', 'rate agreed', 'unit rate', 'per day rate'],
    'Call Date': ['Call Date', 'call date', 'date'],
    'Notes': ['Notes / Remarks', 'notes', 'remark'],
    'Shift': ['Shift', 'shift'],
    'Recurring Service': ['Recurring Service', 'recurring', 'recurring service'],
    'Period': ['Period', 'period'],
    'Visits': ['Visits', 'visits', 'visit', 'vists'],
    'Referral Code': ['Referral Code', 'referral code', 'ref code'],
    'Referral Name': ['Referral Name', 'referral name', 'ref name'],
    'Referral Credit': ['Referral Credit', 'referral credit', 'ref credit']
}

# --- DATABASE HELPERS ---
def save_invoice_to_gsheet(data_dict, sheet_obj):
    if sheet_obj is None: return False
    try:
        all_vals = sheet_obj.get_all_values()
        next_row_num = len(all_vals) + 1
        
        existing_uids = []
        for r in all_vals[1:]: 
            if r[0] and r[0].isdigit(): existing_uids.append(int(r[0]))
        
        if existing_uids: new_uid = max(existing_uids) + 1
        else: new_uid = 1
        final_uid = f"{new_uid:04d}"

        formula_net_amount = f"=U{next_row_num}-AA{next_row_num}"
        formula_earnings = f"=AB{next_row_num}-(AC{next_row_num}*AD{next_row_num})"
        
        qty_extracted = data_dict.get("Paid for Raw", 1)
        
        # ‚≠ê CRITICAL CHANGE HERE: SWAPPED Referral Code and Name
        row_values = [
            final_uid,
            data_dict.get("Serial No.", ""),
            data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""),
            data_dict.get("Date", ""),
            data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""),
            data_dict.get("Age", ""),
            data_dict.get("Gender", ""),
            data_dict.get("Location", ""),
            data_dict.get("Address", ""),
            data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""),
            data_dict.get("Shift", ""),
            data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""),
            data_dict.get("Visits", ""),
            data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""),
            data_dict.get("Generated By", ""),
            data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""),
            data_dict.get("Service Started", ""),
            data_dict.get("Service Ended", ""),
            data_dict.get("Referral Code", ""), # ‚≠ê SWAPPED: Code is now in Name col (index 24)
            data_dict.get("Referral Name", ""), # ‚≠ê SWAPPED: Name is now in Code col (index 25)
            data_dict.get("Referral Credit", ""),
            formula_net_amount,
            "",
            qty_extracted,
            formula_earnings,
            "",
            "",
            ""
        ]
        sheet_obj.append_row(row_values, value_input_option='USER_ENTERED')
        return True
    except Exception as e: st.error(f"Save Error: {e}"); return False

# ‚≠ê CHANGE #7: NEW FUNCTION - update_invoice_in_gsheet()
def update_invoice_in_gsheet(data_dict, sheet_obj, row_idx):
    """
    Updates an existing row in the Google Sheet instead of appending.
    Only updates columns A through X (customer data).
    Preserves UID and other calculated columns.
    """
    if sheet_obj is None: return False
    try:
        row_values = [
            data_dict.get("UID", ""), 
            data_dict.get("Serial No.", ""), 
            data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""), 
            data_dict.get("Date", ""), 
            data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""), 
            data_dict.get("Age", ""), 
            data_dict.get("Gender", ""),
            data_dict.get("Location", ""), 
            data_dict.get("Address", ""), 
            data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""), 
            data_dict.get("Shift", ""), 
            data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""), 
            data_dict.get("Visits", ""), 
            data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""), 
            data_dict.get("Generated By", ""), 
            data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""), 
            data_dict.get("Service Started", ""), 
            data_dict.get("Service Ended", "")
        ]
        range_name = f"A{row_idx}:X{row_idx}"
        sheet_obj.update(range_name, [row_values], value_input_option='USER_ENTERED')
        
        # ‚≠ê CRITICAL CHANGE HERE: SWAPPED Referral Code and Name for Updates
        ref_values = [[
            data_dict.get("Referral Code", ""), # ‚≠ê SWAPPED
            data_dict.get("Referral Name", ""), # ‚≠ê SWAPPED
            data_dict.get("Referral Credit", "")
        ]]
        sheet_obj.update(f"Y{row_idx}:AA{row_idx}", ref_values, value_input_option='USER_ENTERED')

        qty_extracted = data_dict.get("Paid for Raw", 1)
        sheet_obj.update(f"AD{row_idx}", [[qty_extracted]], value_input_option='USER_ENTERED')

        return True
    except Exception as e: st.error(f"Update Error: {e}"); return False

def update_nurse_management(sheet_obj, invoice_number, payment_amount, nurse_name, nurse_extra, nurse_note):
    if sheet_obj is None: return False, None
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4) 
        if cell:
            row_idx = cell.row
            details_val = sheet_obj.cell(row_idx, 22).value
            qty = 1
            if details_val:
                match = re.search(r'Paid for\s*:?\s*(\d+)', str(details_val), re.IGNORECASE)
                if match: qty = int(match.group(1))
            
            formula_string = f"=AB{row_idx}-(AC{row_idx}*AD{row_idx})"
            range_update = f"AC{row_idx}:AH{row_idx}"
            values = [[payment_amount, qty, formula_string, nurse_name, nurse_extra, nurse_note]]
            sheet_obj.update(range_update, values, value_input_option='USER_ENTERED')
            return True, formula_string
        return False, None
    except Exception as e: st.error(f"Nurse Update Error: {e}"); return False, None

def mark_service_ended(sheet_obj, invoice_number, end_date):
    if sheet_obj is None: return False, "No Sheet"
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            end_time_str = format_date_simple(end_date)
            range_name = f"X{cell.row}"
            sheet_obj.update(range_name, [[end_time_str]])
            return True, end_time_str
        return False, "Invoice not found"
    except Exception as e: return False, str(e)

def get_clean_image_base64(file_path):
    if not os.path.exists(file_path): return None
    try:
        img = Image.open(file_path).convert("RGBA")
        buffer = BytesIO()
        img.save(buffer, format="PNG", optimize=True)
        return base64.b64encode(buffer.getvalue()).decode('utf-8')
    except: return None

def get_absolute_path(filename):
    if os.path.exists(filename): return os.path.abspath(filename).replace('\\', '/')
    return None

# ==========================================
# BACKUP LOGIC
# ==========================================
def perform_backup_logic(master_data, backup_url, target_month_str):
    client = get_gspread_client()
    backup_id = extract_id_from_url(backup_url)
    if not backup_id or not client: return False, "Invalid Backup Configuration."
    try:
        backup_wb = client.open_by_key(backup_id)
        try:
            target_ws = backup_wb.worksheet(target_month_str)
            return False, f"Backup for {target_month_str} already exists. Skipping to prevent overwrite."
        except gspread.exceptions.WorksheetNotFound: pass

        try:
            default_ws = backup_wb.worksheet("Sheet1")
            default_ws.update_title(target_month_str)
            target_ws = default_ws
        except gspread.exceptions.WorksheetNotFound:
            target_ws = backup_wb.add_worksheet(title=target_month_str, rows=1000, cols=34)

        target_ws.clear()
        target_ws.update(range_name="A1", values=master_data, value_input_option='USER_ENTERED')
        try: target_ws.format("A1:AH1", {"textFormat": {"bold": True}, "backgroundColor": {"red": 0.8, "green": 0.8, "blue": 0.8}})
        except: pass
        return True, f"‚úÖ Success! Data backed up to sheet '{target_month_str}' in Backup Workbook."
    except Exception as e: return False, f"Backup Failed: {str(e)}"

# ==========================================
# UI & MAIN LOGIC
# ==========================================
st.title("üè• Vesak Care - Invoice Generator")

abs_logo_path = get_absolute_path(LOGO_FILE)
logo_b64 = get_clean_image_base64(LOGO_FILE)

# --- SIDEBAR CONFIGURATION ---
with st.sidebar:
    with st.expander("‚öôÔ∏è System Configuration", expanded=True):
        st.write("Enter Google Sheet Links:")
        m_link = st.text_input("Master Workbook Link (Active):", value=sys_config.get("master_sheet_url", ""))
        b_link = st.text_input("Backup Workbook Link (Archive):", value=sys_config.get("backup_sheet_url", ""))
        
        if st.button("üíæ Save Settings"):
            new_conf = { "master_sheet_url": m_link, "backup_sheet_url": b_link }
            save_system_config(new_conf)
            st.success("Settings Saved!")
            st.rerun()

    st.header("üóÑÔ∏è Backup Manager")
    backup_date = datetime.date.today()
    backup_month_str = backup_date.strftime("%b-%y") 
    st.info(f"Current Period: **{backup_month_str}**")
    
    if st.button("üöÄ Run Monthly Backup Now"):
        if not sys_config["master_sheet_url"] or not sys_config["backup_sheet_url"]:
            st.error("Please configure Master and Backup links first.")
        else:
            client = get_gspread_client()
            master_id = extract_id_from_url(sys_config["master_sheet_url"])
            try:
                wb_master = client.open_by_key(master_id)
                ws_master = wb_master.worksheet(backup_month_str) 
                data_to_copy = ws_master.get_all_values()
                if not data_to_copy: st.warning("Master sheet is empty.")
                else:
                    status, msg = perform_backup_logic(data_to_copy, sys_config["backup_sheet_url"], backup_month_str)
                    if status: st.success(msg)
                    else: st.warning(msg)
            except Exception as e: st.error(f"Could not read Master Workbook: {e}")

    
    data_source = st.radio("Load Customer Data via:", ["Upload File", "OneDrive Link"])
    if st.button("üîÑ Refresh"): st.cache_data.clear(); st.rerun()

# --- LOAD INPUT FILE ---
raw_file_obj = None
if data_source == "Upload File":
    uploaded_file = st.sidebar.file_uploader("Upload Excel/CSV", type=['xlsx', 'csv'])
    if uploaded_file: raw_file_obj = uploaded_file
elif data_source == "OneDrive Link":
    current_url = load_config_path(URL_CONFIG_FILE)
    url_input = st.sidebar.text_input("Paste Link:", value=current_url)
    if st.sidebar.button("Load"): save_config_path(url_input, URL_CONFIG_FILE); st.rerun()
    if current_url: raw_file_obj = robust_file_downloader(current_url)

# --- MAIN TABS ---
						   
tab1, tab2, tab3, tab4, tab5, = st.tabs([
    "üßæ Generate Invoice", 
    "¬©Ô∏è Duplicate Invoice", 
    "üõ† Manage Services", 
    "üí∞ Nurse Manage",
    "üìù Create Agreements"
])

# ==========================================
# CORE INVOICE FUNCTION - render_invoice_ui()
# ==========================================
def render_invoice_ui(df_main, mode="standard"):
    # ========================================================
    # ‚≠ê RESET TRIGGER CHECK (SOLVES THE STREAMLIT ERROR)
    # ========================================================
    # This block executes BEFORE the widgets are drawn.
    # It checks if the previous run requested a reset.
    if st.session_state.get(f"trigger_reset_{mode}", False):
        st.session_state[f"inv_d_{mode}"] = datetime.date.today()
        # Reset overwrite checkbox key if it exists
        if f"ow_{mode}" in st.session_state:
            st.session_state[f"ow_{mode}"] = False
        # Consume the trigger
        st.session_state[f"trigger_reset_{mode}"] = False
    
    # --------------------------------------------------------

    client = get_gspread_client()
    master_id = extract_id_from_url(sys_config.get("master_sheet_url"))

    if not master_id or not client:
        st.error("‚ùå Master Workbook not linked in Sidebar Settings."); return

    # --- FILTER SECTION ---
    st.subheader("1. Select Customer")
 
# ‚≠ê CHANGE: NEW CUSTOMER vs EXISTING CUSTOMER TOGGLE
    show_existing = st.toggle("üìÇ Switch List: üÜï New Customers ‚áÑ üìÇ Existing Customers", value=False)
															
    
    # Auto-set Overwrite checkbox based on toggle
																		
    st.session_state[f"ow_{mode}"] = show_existing    

    use_filters = st.checkbox("üîç Enable Search Filters (Date/Location)", key=f"use_filt_{mode}")

    df_view = df_main.copy()

# Filter logic    
    if use_filters:
        col_filt1, col_filt2 = st.columns(2)
        with col_filt1:
            filter_date = st.date_input("Filter Date (Search by Date):", value=datetime.date.today(), key=f"f_date_{mode}")
        with col_filt2:
            unique_locs = ["All"] + sorted(list(df_main['Location'].astype(str).unique()))
            filter_loc = st.selectbox("Filter Location:", unique_locs, key=f"f_loc_{mode}")

        if 'Call Date' in df_view.columns:
            df_view['TempDate'] = pd.to_datetime(df_view['Call Date'], errors='coerce').dt.date
            df_view = df_view[df_view['TempDate'] == filter_date]
        
        if filter_loc != "All":
            df_view = df_view[df_view['Location'].astype(str) == filter_loc]

    # --- CRITICAL POINT 2: EXCLUSION LOGIC (CACHED) ---
    current_mmm_yy = datetime.date.today().strftime("%b-%y")
    excluded_refs = get_cached_exclusion_list(master_id, current_mmm_yy)
# ‚≠ê CHANGE: Filter list based on Toggle State
    df_view['Ref_Norm_View'] = df_view['Ref. No.'].apply(normalize_id)
    df_view['Ser_Norm_View'] = df_view['Serial No.'].apply(normalize_id)
    df_view['Unique_Key'] = df_view['Ref_Norm_View'] + "-" + df_view['Ser_Norm_View']

    if show_existing:
        # Show ONLY existing customers (those in excluded list)
        if excluded_refs:
            df_view = df_view[df_view['Unique_Key'].isin(excluded_refs)]
        else:
             df_view = pd.DataFrame(columns=df_view.columns) # Empty if no history
    else:
        # Show ONLY new customers (those NOT in excluded list)
        if excluded_refs:
             df_view = df_view[~df_view['Unique_Key'].isin(excluded_refs)]
    
    df_view = df_view.drop(columns=['Ref_Norm_View', 'Ser_Norm_View', 'Unique_Key'])

    df_view['Ref_Clean'] = df_view['Ref. No.'].astype(str).str.strip()
    df_view['Label'] = df_view['Name'].astype(str) + " (" + df_view['Mobile'].astype(str) + ")"
    
    if df_view.empty:
        if show_existing: st.info("üìÇ No existing invoices found for this month.")
        else: st.success("‚úÖ All customers have invoices! Switch toggle to view existing.")

        return

    selected_label = st.selectbox(f"Select Customer ({mode}):", [""] + list(df_view['Label'].unique()), key=f"sel_{mode}")
    
    if not selected_label: return

    row = df_view[df_view['Label'] == selected_label].iloc[0]
    
    c_ref = normalize_id(row.get('Ref. No.', '')).strip()
    c_serial = normalize_id(row.get('Serial No.', '')).strip()
    c_mob = normalize_id(row.get('Mobile', '')).strip()
    c_name = row.get('Name', '')
    c_plan = row.get('Service Required', '')
    c_age = str(row.get('Age', ''))
    c_gender = str(row.get('Gender', ''))
    c_loc = str(row.get('Location', ''))
    c_addr = str(row.get('Address', ''))
    c_shift = str(row.get('Shift', ''))
    c_rec = str(row.get('Recurring Service', ''))
    c_period = str(row.get('Period', ''))
    c_visits = str(row.get('Visits', ''))
    
    c_ref_code = clean_referral_field(row.get('Referral Code', ''))
    c_ref_name = clean_referral_field(row.get('Referral Name', ''))
# Process Credit (Handle number formatting from Excel)
    raw_credit = row.get('Referral Credit', '')
    c_ref_credit = str(int(float(raw_credit))) if str(raw_credit).replace('.', '', 1).isdigit() else clean_referral_field(raw_credit)

    # --- INVOICE DATE SECTION (NEW) ---
    st.divider()
    st.subheader("2. Invoice Details")

    # Overwrite Checkbox (Moved up to control Disabled state)
							  
    chk_overwrite = st.checkbox("Overwrite Existing Invoice", key=f"ow_{mode}")

    # --- INVOICE CALCULATION LOGIC ---
    inv_final = ""
    default_date = datetime.date.today()
    default_qty = 1
    
    val_notes = row.get('Notes', '')
    default_notes = "" if pd.isna(val_notes) or str(val_notes).strip().lower() == 'nan' else str(val_notes)
    
    conflict_exists = False
    existing_row_idx = None

    mmm_yy = default_date.strftime("%b-%y")

    sheet_obj = None
    try:
        wb_save = client.open_by_key(master_id)
        try:
            sheet_obj = wb_save.worksheet(mmm_yy)
        except:
            sheet_obj = wb_save.add_worksheet(title=mmm_yy, rows=1000, cols=34)
            sheet_obj.append_row(SHEET_HEADERS)
    except Exception as e:
        st.error(f"Connection Error: {e}")
        return

    # df_history = pd.DataFrame()
    # THE OVERWRITE FUNCTION LOGIC 
    if sheet_obj:
        master_records = sheet_obj.get_all_records()
        df_history = pd.DataFrame(master_records)
    
        if not df_history.empty:
            # Normalize values for accurate comparison
            df_history['Ref_Norm'] = df_history['Ref. No.'].apply(lambda x: normalize_id(x).strip())
            df_history['Ser_Norm'] = df_history['Serial No.'].apply(lambda x: normalize_id(x).strip())
    
            # ‚≠ê CHANGE #8: FIXED CONFLICT DETECTION LOGIC - MATCH ONLY ON REF. NO. AND SERIAL NO.
            # DO NOT MATCH ON INVOICE NO. because it changes for each invoice
            # This ensures we detect existing customers regardless of how many invoices they have
            match_mask = (
                (df_history['Ref_Norm'].astype(str) == str(c_ref)) &
                (df_history['Ser_Norm'].astype(str) == str(c_serial))
            )
    
            existing_matches = df_history[match_mask]
    
            if not existing_matches.empty:
                conflict_exists = True
                last_match = existing_matches.iloc[-1]
    
                inv_final = str(last_match.get('Invoice Number', ''))
    
                hist_note = str(last_match.get('Notes / Remarks', '')).strip()
                if hist_note:
                    default_notes = hist_note
    
                # Paid Units
                raw_paid_val = last_match.get('Paid for', '')
                try:
                    if raw_paid_val and str(raw_paid_val).strip().isdigit():
                        default_qty = int(str(raw_paid_val).strip())
                    else:
                        hist_details = str(last_match.get('Details', ''))
                        match_qty = re.search(
                            r'Paid for\s*(\d+)',
                            hist_details,
                            re.IGNORECASE
                        )
                        if match_qty:
                            default_qty = int(match_qty.group(1))
                except:
                    pass
    
                # Date
                try:
                    hist_date_str = str(last_match.get('Date', ''))
                    clean_date_str = re.sub(
                        r'(\d+)(st|nd|rd|th)',
                        r'\1',
                        hist_date_str
                    )
                    default_date = datetime.datetime.strptime(
                        clean_date_str,
                        "%b. %d %Y"
                    ).date()
                except:
                    pass
    
                # Get existing row index (WITHOUT Invoice No)
                try:
                    # Since we aren't matching invoice no, search manually
                    idx = existing_matches.index.tolist()[-1]
                    existing_row_idx = idx + 2   # +2 for header
                except:
                    existing_row_idx = None
    
            else:
                default_qty = 1
                conflict_exists = False
        else:
            default_qty = 1
            conflict_exists = False
    else:
        default_qty = 1
        conflict_exists = False

    if not conflict_exists:
        # 1. Setup STRICT Formatting Variables
        # Ensure Location matches exactly 3 letters (MUM or PUN)
        raw_loc = str(row.get('Location', '')).lower().strip()
        loc_code = "MUM" if "mumbai" in raw_loc else "PUN"
        
        # Current Date Targets
        target_month = default_date.month
        target_year = default_date.year
        
        # 2. THE HARDCORE LOGIC: Scan History for the Highest Sequence
        # We start at 0. If no history found, next is 0+1 = 1.
        max_existing_seq = 0

        if not df_history.empty and 'Invoice Number' in df_history.columns:
            # Convert column to string to avoid float errors (e.g. 1.0 vs 1)
            inv_series = df_history['Invoice Number'].dropna().astype(str)

            for existing_inv in inv_series:
                clean_inv = existing_inv.strip()
                
                # STRICT REGEX: Looks for LOC-DDMMYYYY-SEQ
                # This breaks the string into exact parts.
                # Example Match: PUN-12012026-005
                match = re.search(r'^([A-Z]{3})-(\d{2})(\d{2})(\d{4})-(\d+)$', clean_inv)
                
                if match:
                    f_loc = match.group(1)   # e.g., PUN
                    # f_day = match.group(2) # e.g., 12 (We ignore Day for sequencing)
                    f_month = int(match.group(3)) # e.g., 01
                    f_year = int(match.group(4))  # e.g., 2026
                    f_seq = int(match.group(5))   # e.g., 005
                    
                    # LOGIC: 
                    # 1. Location must match (PUN sequence is separate from MUM)
                    # 2. Month and Year must match (Sequence resets every month)
                    if f_loc == loc_code and f_month == target_month and f_year == target_year:
                        if f_seq > max_existing_seq:
                            max_existing_seq = f_seq
            
        # 3. Resume the Sequence
        # No matter if the last row was "Alphabet" or broken, we take the Max Number found + 1
        next_seq = max_existing_seq + 1

        # 4. Construct Final String
        # Result: PUN-12012026-006
        date_str_final = default_date.strftime('%d%m%Y')
        inv_final = f"{loc_code}-{date_str_final}-{next_seq:03d}"

    # ================= UI SECTION =================

    col_inv1, col_inv2 = st.columns(2)

    with col_inv1:
        inv_date_val = st.date_input(
            "Invoice Date:",
            value=default_date,
            key=f"inv_d_{mode}"
        )

    with col_inv2:
        is_inv_disabled = True if (conflict_exists and not chk_overwrite) else False
        inv_input = st.text_input(
            "Invoice Number",
            value=inv_final,
            disabled=is_inv_disabled,
            key=f"inv_n_{mode}"
        )

    st.write(f"**Plan:** {c_plan} | **Ref:** {c_ref} | **Serial:** {c_serial}")

    # ‚≠ê CHANGE #4: SMART WARNING MESSAGES
    if conflict_exists:
        if chk_overwrite:
            st.info(f"‚úÖ Overwrite is ON ‚Äì changes will update Invoice #{inv_final}")
        else:
            st.warning(f"‚ö†Ô∏è Customer exists (Ref: {c_ref}, Serial: {c_serial}). Tick 'Overwrite' to Update.")

    col3, col4 = st.columns(2)

    with col3:
        billing_qty = st.number_input(
            "Paid Units:",
            min_value=1,
            value=default_qty,
            key=f"qty_{mode}_{selected_label}"
        )
        notes = st.text_area(
            "Notes:",
            value=default_notes,
            key=f"note_{mode}"
        )

    with col4:
        gen_by_input = st.text_input(
            "Generated By:",
            value="",
            placeholder="Leave blank for Default",
            key=f"gen_{mode}"
        )
        gen_by_to_save = (
            gen_by_input if gen_by_input.strip() else "Vesak Patient Care"
        )

    st.subheader("Services")
    inc_list, exc_list = get_base_lists(c_plan, row.get('Sub Service', 'All'))

    sc1, sc2 = st.columns(2)

    with sc1:
        st.text_area("Included", ", ".join(inc_list), disabled=True)

    with sc2:
        exc_final = st.multiselect(
            "Excluded (Click X to remove):",
            options=exc_list,
            default=exc_list,
            key=f"exc_{mode}_{c_ref}"
        )
        exc_text_for_pdf = ", ".join(exc_final)

    # ‚≠ê NEW REFERRAL LOGIC
    # Logic: Disable if data exists, Enable if empty OR if Overwrite is checked
    disable_ref = False
    if c_ref_name and c_ref_code and c_ref_credit: disable_ref = True
    if chk_overwrite: disable_ref = False

    with st.expander("üéÅ Referral Details", expanded=True):
        cr1, cr2, cr3 = st.columns(3)
        with cr1: ref_name_input = st.text_input("Referral Name", value=c_ref_name, disabled=disable_ref, key=f"rn_{mode}")
        with cr2: ref_code_input = st.text_input("Referral Code", value=c_ref_code, disabled=disable_ref, key=f"rc_{mode}")
        with cr3: ref_credit_input = st.text_input("Referral Credit", value=c_ref_credit, disabled=disable_ref, key=f"rcred_{mode}")
    
# ========================================================
    # ‚≠ê PREVIEW SECTION - GENERATE HTML LIVE
    # ========================================================
    # This block generates the preview HTML using LIVE data from the inputs above.
    # It runs on every interaction, updating the preview instantly.
    preview_rate = float(row.get('Unit Rate', 0))
    preview_total = preview_rate * billing_qty
    preview_date_str = format_date_with_suffix(inv_date_val)
    preview_file_name = generate_filename("Invoice", inv_input, c_name)

    # Reuse existing helpers to generate parts of the HTML
    desc_col_html = construct_description_html(row)
    amount_col_html = construct_amount_html(row, billing_qty)
    
    # Logic for Plan Display Name
    pdf_display_plan = c_plan
    sub_srv_txt = str(row.get('Sub Service', '')).strip()
    if c_plan == "Plan A: Patient Attendant Care": pdf_display_plan = "Patient Care Service"
    elif c_plan == "Plan B: Skilled Nursing": pdf_display_plan = "Nurse Service"
    elif c_plan == "Plan C: Chronic Management": pdf_display_plan = "Chronic and Holistic Healthcare Service"
    elif c_plan == "Plan D: Elderly Companion": pdf_display_plan = "Elderly and Well-being Care"
    elif c_plan == "Plan E: Maternal & Newborn": pdf_display_plan = "Maternal & Newborn - Support for Women during and after Pregnancy"
    elif c_plan == "Plan F: Rehabilitative Care": pdf_display_plan = f"Rehabilitative Care for {sub_srv_txt}"
    elif c_plan == "A-la-carte Services": pdf_display_plan = f"Other Service - {sub_srv_txt}"
    
    clean_plan = pdf_display_plan
    inc_html = "".join([f'<li class="mb-1 text-xs text-gray-700">{item}</li>' for item in inc_list])
    exc_html = "".join([f'<li class="mb-1 text-[10px] text-gray-500">{item}</li>' for item in exc_final])

    notes_section = ""
    if notes:
        notes_section = f"""<div class="mt-6 p-4 bg-gray-50 border border-gray-100 rounded"><h4 class="font-bold text-vesak-navy text-xs mb-1">NOTES:</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">{notes}</p></div>"""

    # --- HTML TEMPLATE WITH EMBEDDED BUTTONS (TAILWIND + JS) ---
    html_content = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {{
            theme: {{
                extend: {{
                    colors: {{ vesak: {{ navy: '#002147', gold: '#C5A065', orange: '#CC4E00' }} }},
                    fontFamily: {{ serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }}
                }}
            }}
        }}
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap');
        body {{ font-family: 'Lato', sans-serif; background: #f0f0f0; margin: 0; }}
        .invoice-page {{ position: relative; background: white; width: 210mm; height: 297mm; padding: 30px; padding-bottom: 120px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); display: flex; flex-direction: column; margin-left: auto; margin-right: auto; }}
        main {{ flex: none; }}
        footer {{ position: absolute; bottom: 7mm; left: 30px; right: 30px; text-align: center; }}
        .watermark-container {{ position: fixed; top: 148.5mm; left: 50%; transform: translateX(-50%) translateY(-50%); pointer-events: none; z-index: 0; }}
        .watermark-text {{ font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 800; color: rgba(0, 33, 71, 0.04); letter-spacing: 0.25em; }}
        @media print {{
            body {{ background: white; -webkit-print-color-adjust: exact; }}
            .invoice-page {{ width: 210mm; height: 297mm; padding: 20px; padding-bottom: 90px; box-shadow: none; }}
            footer {{ bottom: 7mm; width: calc(100% - 40px); }}
            .no-print {{ display: none !important; }}
            .watermark-container {{ opacity: 0.04 !important; }}
        }}
    </style>
</head>
<body class="py-10">
    <div class="max-w-[210mm] mx-auto mb-6 flex justify-end gap-3 no-print px-4">
        <button onclick="window.print()" class="bg-gray-600 text-white px-5 py-2 rounded shadow hover:bg-gray-800 transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-print mr-2"></i> Print / Save Vector PDF
        </button>
        <button onclick="generatePDF()" class="bg-vesak-navy text-white px-6 py-2 rounded shadow hover:bg-vesak-gold transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-download mr-2"></i> Download PDF
        </button>
    </div>

    <div class="invoice-page" id="invoice-content">
        <div class="watermark-container">
            <img src="data:image/png;base64,{logo_b64}" style="display:block; margin:0; padding:0; width:300px; opacity:0.04;">
            <div class="watermark-text mt-4">VESAK</div>
        </div>

        <header class="relative z-10 w-full mb-10">
            <div class="flex justify-between items-start border-b border-gray-100 pb-6">
                <div class="flex items-center gap-5">
                    <img src="data:image/png;base64,{logo_b64}" class="w-20 h-auto">
                    <div>
                        <h1 class="font-serif text-2xl font-bold text-vesak-navy tracking-wide leading-none mb-2">
                            Vesak Care <span class="text-vesak-gold font-normal">Foundation</span>
                        </h1>
                        <div class="flex flex-col text-xs text-gray-500 font-light tracking-wide space-y-0.5">
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Web</span> vesakcare.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Email</span> vesakcare@gmail.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Phone</span> +91 7777 000 878</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block font-serif text-3xl text-gray-200 tracking-widest mb-2">INVOICE</span>
                    <div class="text-xs text-vesak-navy">
                        <div class="mb-1"><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">Date</span> <b>{preview_date_str}</b></div>
                        <div><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">No.</span> <b>{inv_input}</b></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow relative z-10">
            
            <div class="flex mb-10 bg-gray-50 border-l-4 border-vesak-navy">
                <div class="w-1/2 p-4 border-r border-gray-200">
                    <div class="text-[10px] font-bold text-vesak-gold uppercase mb-1">Billed To</div>
                    <div class="text-lg font-bold text-vesak-navy">{c_name}</div>
                    <div class="flex gap-4 mt-2 text-xs text-gray-600">
                        <div class="flex items-center gap-1"><i class="fas fa-user text-vesak-gold"></i> {c_gender}</div>
                        <div class="flex items-center gap-1"><i class="fas fa-birthday-cake text-vesak-gold"></i> {c_age} Yrs</div>
                    </div>
                </div>
                <div class="w-1/2 p-4 flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                        <i class="fas fa-phone-alt text-vesak-gold w-4"></i> {c_mob}
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-map-marker-alt text-vesak-gold w-4 mt-0.5"></i> 
                        <span class="leading-tight">{c_addr}</span>
                    </div>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="bg-vesak-navy text-white text-xs uppercase tracking-wider text-left">
                        <th class="p-3 w-3/5">Description</th>
                        <th class="p-3 w-2/5 text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-gray-100">
                        <td class="p-4 align-top">
                            <div class="font-bold text-sm text-gray-800">{clean_plan}</div>
                            {desc_col_html}
                        </td>
                        <td class="p-4 text-right font-bold text-sm text-gray-800 align-top">
                            {amount_col_html}
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="grid grid-cols-2 gap-8">
                <div>
                    <h4 class="text-xs font-bold text-vesak-navy uppercase border-b border-vesak-gold pb-1 mb-3">Services Included</h4>
                    <ul class="list-disc pl-4 space-y-1">{inc_html}</ul>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase border-b border-gray-200 pb-1 mb-3">Services Not Included</h4>
                    <ul class="columns-1 text-[10px] text-gray-400 space-y-1">{exc_html}</ul>
                </div>
            </div>

            {notes_section}
            
        </main>

        <footer class="z-10">
            <div class="text-center text-xs text-gray-400 italic mb-4">
                Thank you for choosing Vesak Care Foundation!
            </div>
            <div class="w-full h-px bg-gradient-to-r from-gray-100 via-vesak-gold to-gray-100 opacity-50 mb-4"></div>
            <div class="flex justify-between items-end text-xs text-gray-500">
                <div>
                    <p class="font-serif italic text-vesak-navy mb-1 text-sm">Our Offices</p>
                    <div class="flex gap-2">
                        <span>Pune</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Mumbai</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Kolhapur</span>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <a href="https://www.instagram.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-instagram text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                    
                    <a href="https://www.facebook.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-facebook text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                </div>
            </div>
            <div class="mt-4 w-full h-1 bg-vesak-navy"></div>              
        </footer>
    </div>

    <script>
        function generatePDF() {{
            const element = document.getElementById('invoice-content');
            const opt = {{
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: '{preview_file_name}',
                image: {{ type: 'jpeg', quality: 1 }},
                html2canvas: {{ scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }},
                jsPDF: {{ unit: 'mm', format: 'a4', orientation: 'portrait' }}
            }};
            html2pdf().set(opt).from(element).save();
        }}
    </script>
</body>
</html>
"""
    # ========================================================
    # ‚≠ê BUTTONS MOVED HERE (ABOVE THE PREVIEW)
    # ========================================================
    btn_save = False
    
    if conflict_exists:
        if chk_overwrite:
            if st.button("Overwrite Invoice", type="primary", key=f"b_ov_{mode}"): btn_save = True
        else:
            st.button("Create Invoice", disabled=True, key=f"b_cr_dis_{mode}")
    else:
        if st.button("Create Invoice", type="primary", key=f"b_cr_{mode}"): btn_save = True
    
    st.markdown("---")  # Optional: Visual separator between buttons and preview
    
    # RENDER THE HTML COMPONENT SO THE USER CAN SEE AND CLICK DOWNLOAD
    components.html(html_content, height=1000, scrolling=True)
    # ========================================================

    if btn_save:
        rate = float(row.get('Unit Rate', 0))
        total = rate * billing_qty
        
        service_start_date = format_date_simple(inv_date_val)
        generated_at = datetime.datetime.now().strftime("%d-%m-%Y %H:%M:%S")

        # --- LOGIC FOR DETAILS COLUMN ---
        p_raw_check = str(row.get('Period', '')).strip()
        p_check_lower = p_raw_check.lower()
        shift_raw_check = str(row.get('Shift', '')).strip()
        shift_check_lower = shift_raw_check.lower()
        
        details_text = ""
        
        if "per visit" in shift_check_lower:
            if billing_qty == 1: details_text = f"Paid for {billing_qty} Visit"
            else: details_text = f"Paid for {billing_qty} Visits"
        
        elif "daily" in p_check_lower:
            if billing_qty == 1:
                details_text = f"Paid for {billing_qty} Day"
            elif billing_qty % 7 == 0:
                weeks_val = int(billing_qty / 7)
                if weeks_val == 1: details_text = f"Paid for {weeks_val} Week"
                else: details_text = f"Paid for {weeks_val} Weeks"
            else:
                details_text = f"Paid for {billing_qty} Days"
                
        elif "monthly" in p_check_lower:
            if billing_qty == 1: details_text = f"Paid for {billing_qty} Month"
            else: details_text = f"Paid for {billing_qty} Months"
            
        elif "weekly" in p_check_lower:
            if billing_qty == 1: details_text = f"Paid for {billing_qty} Week"
            else: details_text = f"Paid for {billing_qty} Weeks"
            
        else:
            details_text = f"Paid for {billing_qty} {p_raw_check}"
            
        if mode == "force_new": details_text += " (New)"

        # --- LOGIC FOR HISTORY PLAN NAME SAVING ---
        plan_to_save = c_plan
        sub_service_val = str(row.get('Sub Service', '')).strip()
        
        if c_plan == "Plan F: Rehabilitative Care":
            plan_to_save = f"Plan F: Rehabilitative Care and {sub_service_val}"
        elif c_plan == "A-la-carte Services":
            plan_to_save = f"Other Services - {sub_service_val}"
# Clean credit for save
        final_credit_val = ref_credit_input.strip()
        # If it looks like a float ending in .0, strip it
        if final_credit_val.replace('.', '', 1).isdigit():
             try: final_credit_val = str(int(float(final_credit_val)))
             except: pass  

        record = {
            "UID": "", 
            "Serial No.": c_serial, 
            "Ref. No.": c_ref,        
            "Invoice Number": inv_input, 
            "Date": format_date_with_suffix(inv_date_val),
            "Generated At": generated_at, 
            "Customer Name": c_name,
            "Age": c_age,
            "Gender": c_gender,
            "Location": c_loc,
            "Address": c_addr,
            "Mobile": c_mob, 
            "Plan": plan_to_save,
            "Shift": c_shift,
            "Recurring Service": c_rec,
            "Period": c_period,
            "Visits": c_visits,
            "Amount": rate, 
            "Amount Paid": total, 
            "Notes / Remarks": notes, 
            "Generated By": gen_by_to_save, 
            "Service Started": service_start_date,
            "Service Ended": "",
            "Details": details_text,
            "Paid for Raw": billing_qty,
            "Referral Code": c_ref_code,
            "Referral Name": c_ref_name,
            "Referral Credit": c_ref_credit
        }
        
        # ‚≠ê CHANGE #6: UPDATE vs APPEND LOGIC
        if conflict_exists and chk_overwrite and existing_row_idx:
            record["UID"] = df_history.iloc[existing_row_idx-2]["UID"] 
            try:
                actual_uid = sheet_obj.cell(existing_row_idx, 1).value
                record["UID"] = actual_uid
            except: pass
            
            update_invoice_in_gsheet(record, sheet_obj, existing_row_idx)
            st.success(f"Overwritten Row {existing_row_idx}!")
        else:
            save_invoice_to_gsheet(record, sheet_obj)
            st.success("Created New Row!")
        st.balloons()
        
        # ========================================================
        # ‚≠ê RESET LOGIC - TRIGGER RERUN (SOLVES THE ERROR)
        # ========================================================
        # Instead of modifying the widget key directly (which crashes),
        # we set a trigger flag for the NEXT run and rerun immediately.
        st.session_state[f"trigger_reset_{mode}"] = True
        time.sleep(0.5) # Short delay for balloons/visual feedback
        st.rerun()
        # ========================================================

if raw_file_obj:
    try:
        filename = getattr(raw_file_obj, "name", "data.xlsx")
        is_excel = filename.endswith('.xlsx')
        
        if is_excel:
            try:
                df = pd.read_excel(raw_file_obj, sheet_name='Confirmed', engine='openpyxl')
                st.sidebar.success("‚úÖ Reading 'Confirmed' Sheet from Vesak Care - Patient Logs")
            except ValueError:
                st.error("‚ùå CRITICAL ERROR: The sheet 'Confirmed' was not found in the uploaded workbook.")
                st.stop()
        else:
            df = pd.read_csv(raw_file_obj)
        
        df = normalize_columns(df, COLUMN_ALIASES)
        
        with tab1: render_invoice_ui(df, mode="standard")
        
        
        with tab2:
            st.header("¬©Ô∏è Duplicate Invoice")
            client = get_gspread_client()
            mid = extract_id_from_url(sys_config.get("master_sheet_url"))
            dup_date = st.date_input("Select Month:", value=datetime.date.today())
            mmm_yy = dup_date.strftime("%b-%y")
            
            if client and mid:
                try:
                    wb = client.open_by_key(mid)
                    ws = wb.worksheet(mmm_yy)
                    df_hist = pd.DataFrame(ws.get_all_records())
													 
								   
                    if not df_hist.empty and 'Invoice Number' in df_hist.columns:
                        df_hist['Display'] = df_hist['Invoice Number'].astype(str) + " - " + df_hist['Customer Name']
                        
                        # ‚≠ê CHANGE: Default selectbox index to None (Blank by default)
                        sel_dup = st.selectbox("Select Invoice:", df_hist['Display'].unique(), index=None, placeholder="Select an Invoice...")
							   
													 
																																  
																	
                        
                        if sel_dup:
                            row = df_hist[df_hist['Display'] == sel_dup].iloc[0]
                            st.info(f"Selected: {row['Customer Name']}")
                            
                            # Prepare Data for new HTML Preview
                            c_name = row.get("Customer Name", "")
                            c_gender = row.get("Gender", "")
                            c_age = row.get("Age", "")
                            c_mob = row.get("Mobile", "")
                            c_addr = row.get("Address", "")
                            c_plan = row.get("Plan", "")
                            inv_input = row.get("Invoice Number", "")
                            
                            # Clean Date
                            raw_date = row.get("Date", "")
                            preview_date_str = raw_date 
                            
                            # Generate Filename
                            preview_file_name = generate_filename("DUPLICATE", inv_input, c_name)
                            
                            # Helper Data Construction
                            desc_col_html = construct_description_html(row)
                            
                            # Amount logic & Clean Unit Rate (CRITICAL FIX for "0" Amount)
                            qty = 1
                            try:
                                paid_raw = row.get('Paid for', 1)
                                if str(paid_raw).isdigit(): qty = int(paid_raw)
                            except: pass
                            
                            # --- Fix: Clean the Amount from History (Remove commas/symbols) ---
                            try:
                                raw_hist_amt = str(row.get('Amount', '0'))
                                clean_hist_amt = raw_hist_amt.replace(',', '').replace('‚Çπ', '').replace('Rs.', '').strip()
                                row['Unit Rate'] = float(clean_hist_amt)
                            except:
                                row['Unit Rate'] = 0.0
                            # ------------------------------------------------------------------

                            
                            
                            amount_col_html = construct_amount_html(row, qty)
                            
                            # --- Logic for Plan Display Name (Your Requested Logic) ---
                            # Note: In history, 'Sub Service' isn't a separate column, it's merged in 'Plan'.
                            # We extract it loosely for the logic to work.
                            sub_srv_txt = ""
                            if " and " in c_plan: sub_srv_txt = c_plan.split(" and ")[-1]
                            elif " - " in c_plan: sub_srv_txt = c_plan.split(" - ")[-1]
                            
                            pdf_display_plan = c_plan
                            
                            # Match against base names to apply formatting
                            if "Plan A" in c_plan: pdf_display_plan = "Patient Care Service"
                            elif "Plan B" in c_plan: pdf_display_plan = "Nurse Service"
                            elif "Plan C" in c_plan: pdf_display_plan = "Chronic and Holistic Healthcare Service"
                            elif "Plan D" in c_plan: pdf_display_plan = "Elderly and Well-being Care"
                            elif "Plan E" in c_plan: pdf_display_plan = "Maternal & Newborn - Support for Women during and after Pregnancy"
                            elif "Plan F" in c_plan: pdf_display_plan = f"Rehabilitative Care for {sub_srv_txt}"
                            elif "Other" in c_plan or "A-la-carte" in c_plan: pdf_display_plan = f"Other Service - {sub_srv_txt}"
                            
                            clean_plan = pdf_display_plan
                            # ---------------------------------------------------------

                            # Lists Reconstruction 
                            inc_list, exc_list = get_base_lists(c_plan, "All") 
                            inc_html = "".join([f'<li class="mb-1 text-xs text-gray-700">{item}</li>' for item in inc_list])
                            exc_html = "".join([f'<li class="mb-1 text-[10px] text-gray-500">{item}</li>' for item in exc_list])
                            
                            notes = row.get("Notes / Remarks", "")
                            notes_section = ""
                            if notes:
                                notes_section = f"""<div class="mt-6 p-4 bg-gray-50 border border-gray-100 rounded"><h4 class="font-bold text-vesak-navy text-xs mb-1">NOTES:</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">{notes}</p></div>"""

                            # --- HTML CONSTRUCTION FOR TAB 2 ---
                            html_dup = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {{
            theme: {{
                extend: {{
                    colors: {{ vesak: {{ navy: '#002147', gold: '#C5A065', orange: '#CC4E00' }} }},
                    fontFamily: {{ serif: ['"Playfair Display"', 'serif'], sans: ['"Lato"', 'sans-serif'] }}
                }}
            }}
        }}
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap');
        body {{ font-family: 'Lato', sans-serif; background: #f0f0f0; margin: 0; }}
        .invoice-page {{ position: relative; background: white; width: 210mm; height: 297mm; padding: 30px; padding-bottom: 120px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); display: flex; flex-direction: column; margin-left: auto; margin-right: auto; }}
        main {{ flex: none; }}
        footer {{ position: absolute; bottom: 7mm; left: 30px; right: 30px; text-align: center; }}
        .watermark-container {{ position: fixed; top: 148.5mm; left: 50%; transform: translateX(-50%) translateY(-50%); pointer-events: none; z-index: 0; }}
        .watermark-text {{ font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 800; color: rgba(0, 33, 71, 0.04); letter-spacing: 0.25em; }}
        @media print {{
            body {{ background: white; -webkit-print-color-adjust: exact; }}
            .invoice-page {{ width: 210mm; height: 297mm; padding: 20px; padding-bottom: 90px; box-shadow: none; }}
            footer {{ bottom: 7mm; width: calc(100% - 40px); }}
            .no-print {{ display: none !important; }}
            .watermark-container {{ opacity: 0.04 !important; }}
        }}
    </style>
</head>
<body class="py-10">
    <div class="max-w-[210mm] mx-auto mb-6 flex justify-end gap-3 no-print px-4">
        <button onclick="window.print()" class="bg-gray-600 text-white px-5 py-2 rounded shadow hover:bg-gray-800 transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-print mr-2"></i> Print / Save Vector PDF
        </button>
        <button onclick="generatePDF()" class="bg-vesak-navy text-white px-6 py-2 rounded shadow hover:bg-vesak-gold transition font-bold text-xs uppercase tracking-widest">
            <i class="fas fa-download mr-2"></i> Download PDF
        </button>
    </div>

    <div class="invoice-page" id="invoice-content">
        <div class="watermark-container">
            <img src="data:image/png;base64,{logo_b64}" style="display:block; margin:0; padding:0; width:300px; opacity:0.04;">
            <div class="watermark-text mt-4">VESAK</div>
        </div>

        <header class="relative z-10 w-full mb-10">
            <div class="flex justify-between items-start border-b border-gray-100 pb-6">
                <div class="flex items-center gap-5">
                    <img src="data:image/png;base64,{logo_b64}" class="w-20 h-auto">
												
																		  
						
																 
																							  
																										   
																				 
						
																												   
																 
						
																					 
																			 
						
																								   
													 
																											 
										
						
																													
																										 
						
																	 
                    <div>
                        <h1 class="font-serif text-2xl font-bold text-vesak-navy tracking-wide leading-none mb-2">
                            Vesak Care <span class="text-vesak-gold font-normal">Foundation</span>
                        </h1>
                        <div class="flex flex-col text-xs text-gray-500 font-light tracking-wide space-y-0.5">
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Web</span> vesakcare.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Email</span> vesakcare@gmail.com</span>
                            <span><span class="font-bold text-vesak-gold uppercase w-12 inline-block">Phone</span> +91 7777 000 878</span>
									 
																																																																																		   
												 
									 
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block font-serif text-3xl text-gray-200 tracking-widest mb-2">INVOICE</span>
                    <div class="text-xs text-vesak-navy">
                        <div class="mb-1"><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">Date</span> <b>{preview_date_str}</b></div>
                        <div><span class="text-gray-400 uppercase tracking-wider text-[10px] mr-2">No.</span> <b>{inv_input}</b></div>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow relative z-10">
            
            <div class="flex mb-10 bg-gray-50 border-l-4 border-vesak-navy">
                <div class="w-1/2 p-4 border-r border-gray-200">
                    <div class="text-[10px] font-bold text-vesak-gold uppercase mb-1">Billed To</div>
                    <div class="text-lg font-bold text-vesak-navy">{c_name}</div>
                    <div class="flex gap-4 mt-2 text-xs text-gray-600">
                        <div class="flex items-center gap-1"><i class="fas fa-user text-vesak-gold"></i> {c_gender}</div>
                        <div class="flex items-center gap-1"><i class="fas fa-birthday-cake text-vesak-gold"></i> {c_age} Yrs</div>
                    </div>
                </div>
                <div class="w-1/2 p-4 flex flex-col justify-center">
                    <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                        <i class="fas fa-phone-alt text-vesak-gold w-4"></i> {c_mob}
                    </div>
                    <div class="flex items-start gap-2 text-xs text-gray-600">
                        <i class="fas fa-map-marker-alt text-vesak-gold w-4 mt-0.5"></i> 
                        <span class="leading-tight">{c_addr}</span>
                    </div>
                </div>
            </div>

            <table class="w-full mb-8">
                <thead>
                    <tr class="bg-vesak-navy text-white text-xs uppercase tracking-wider text-left">
                        <th class="p-3 w-3/5">Description</th>
                        <th class="p-3 w-2/5 text-right">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-gray-100">
                        <td class="p-4 align-top">
                            <div class="font-bold text-sm text-gray-800">{clean_plan}</div>
                            {desc_col_html}
                        </td>
                        <td class="p-4 text-right font-bold text-sm text-gray-800 align-top">
                            {amount_col_html}
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="grid grid-cols-2 gap-8">
                <div>
                    <h4 class="text-xs font-bold text-vesak-navy uppercase border-b border-vesak-gold pb-1 mb-3">Services Included</h4>
                    <ul class="list-disc pl-4 space-y-1">{inc_html}</ul>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase border-b border-gray-200 pb-1 mb-3">Services Not Included</h4>
                    <ul class="columns-1 text-[10px] text-gray-400 space-y-1">{exc_html}</ul>
                </div>
            </div>

            {notes_section}
            
        </main>

        <footer class="z-10">
            <div class="text-center text-xs text-gray-400 italic mb-4">
                Thank you for choosing Vesak Care Foundation!
            </div>
            <div class="w-full h-px bg-gradient-to-r from-gray-100 via-vesak-gold to-gray-100 opacity-50 mb-4"></div>
            <div class="flex justify-between items-end text-xs text-gray-500">
                <div>
                    <p class="font-serif italic text-vesak-navy mb-1 text-sm">Our Offices</p>
                    <div class="flex gap-2">
                        <span>Pune</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Mumbai</span><span class="text-vesak-gold">‚Ä¢</span>
                        <span>Kolhapur</span>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <a href="https://www.instagram.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-instagram text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                    
                    <a href="https://www.facebook.com/VesakCare/" target="_blank" class="flex items-center gap-2 text-gray-500 hover:text-vesak-gold transition-colors">
                        <i class="fab fa-facebook text-lg"></i>
                        <span>@VesakCare</span>
                    </a>
                </div>
            </div>
            <div class="mt-4 w-full h-1 bg-vesak-navy"></div>              
        </footer>
    </div>

    <script>
        function generatePDF() {{
            const element = document.getElementById('invoice-content');
            const opt = {{
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: '{preview_file_name}',
                image: {{ type: 'jpeg', quality: 1 }},
                html2canvas: {{ scale: 2, useCORS: true, letterRendering: true, scrollY: 0 }},
                jsPDF: {{ unit: 'mm', format: 'a4', orientation: 'portrait' }}
            }};
            html2pdf().set(opt).from(element).save();
        }}
    </script>
</body>
</html>
"""
																								
						
								
                            components.html(html_dup, height=1000, scrolling=True)

                    else: st.warning("No records found in this month.")
																							
                except Exception as e: st.error(f"Could not load history for this month: {e}")

        with tab3:
            st.header("üõ† Manage Services")
            SERVICES_MASTER = {
                "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
                "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
                "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
                "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
                "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
                "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
                "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
            }
            ms_plan = st.selectbox("Select Plan to View:", list(SERVICES_MASTER.keys()))
            ms_sub = st.text_input("Simulate Sub-Services Input:", value="All")
            inc, exc = get_base_lists(ms_plan, ms_sub)
            c1, c2 = st.columns(2)
            with c1: 
                st.success(f"‚úÖ Included ({len(inc)})")
                for i in inc: st.write(f"- {i}")
            with c2: 
                st.error(f"‚ùå Excluded ({len(exc)})")
                for e in exc: st.write(f"- {e}")
        
        with tab4:
            st.header("Nurse Management")
            client = get_gspread_client()
            mid = extract_id_from_url(sys_config.get("master_sheet_url"))
            
            if client and mid:
                try:
                    wb = client.open_by_key(mid)
                    ws = wb.worksheet(datetime.date.today().strftime("%b-%y"))
                    st.write("Enter Invoice Number to manage nurse payments:")
                    inv_to_pay = st.text_input("Invoice No:")
                    st.divider()
                    col_n1, col_n2 = st.columns(2)
                    with col_n1:
                        amt = st.number_input("Nurse Payment Amount:", min_value=0.0)
                        nm = st.text_input("Nurse Name:")
                    with col_n2:
                        nm_extra = st.text_input("Nurse Name (Extra):")
                        nm_note = st.text_area("Nurse Note")
                    if st.button("Update Nurse Details (Overwrite)"):
                        success, form = update_nurse_management(ws, inv_to_pay, amt, nm, nm_extra, nm_note)
                        if success: st.success("‚úÖ Nurse details updated successfully in sheet!")
                        else: st.error("‚ùå Invoice not found in current month's sheet.")
                except Exception as e: st.error(f"Error accessing sheet: {e}")
            else:
                st.warning("Please configure Master Sheet URL in Sidebar.")

        with tab5:
            st.header("üìù Create Agreements")
            
            use_filt_ag = st.checkbox("üîç Enable Search Filters (Date/Location)", key="use_filt_ag")
            df_ag = df.copy()
            
            if use_filt_ag:
                c1, c2 = st.columns(2)
                with c1: f_dt = st.date_input("Filter Date:", value=datetime.date.today(), key="ag_dt")
                with c2: 
                    u_locs = ["All"] + sorted(list(df['Location'].astype(str).unique()))
                    f_lc = st.selectbox("Filter Location:", u_locs, key="ag_lc")
                
                if 'Call Date' in df_ag.columns:
                    df_ag['TempDate'] = pd.to_datetime(df_ag['Call Date'], errors='coerce').dt.date
                    df_ag = df_ag[df_ag['TempDate'] == f_dt]
                if f_lc != "All": df_ag = df_ag[df_ag['Location'].astype(str) == f_lc]
            
            df_ag['Ref_Clean'] = df_ag['Ref. No.'].astype(str).str.strip()
            df_ag['Label'] = df_ag['Name'].astype(str) + " (" + df_ag['Mobile'].astype(str) + ")"
            
            if df_ag.empty: st.warning("No customers found.")
            else:
                sel_cust_ag = st.selectbox("Select Customer for Agreement:", [""] + list(df_ag['Label'].unique()), key="sel_ag")
                if sel_cust_ag:
                    row_ag = df_ag[df_ag['Label'] == sel_cust_ag].iloc[0]
                    st.info(f"Selected: {row_ag['Name']} | Ref: {normalize_id(row_ag.get('Ref. No.'))}")
                    
                    c_ref_ag = normalize_id(row_ag.get('Ref. No.', ''))
                    pdf_date_str = format_date_with_suffix(datetime.date.today())
                    
                    col_b1, col_b2 = st.columns(2)
                    with col_b1: 
                        if st.button("Nurse Agreement", key="btn_nu_ag"):
                            display_type = "NURSE AGREEMENT"
                            file_name = generate_filename("Nurse", "AGR", row_ag['Name'])
                            html_content = f"""<!DOCTYPE html><html><head><style>@page {{ size: a4 portrait; margin: 1cm; }} body {{ font-family: 'Helvetica', sans-serif; }} .header {{ text-align: center; }}</style></head><body><div class="header"><img src="data:image/png;base64,{logo_b64}" width="100"><h2>Vesak Care Foundation</h2></div><h3>{display_type}</h3><p><strong>Ref:</strong> {c_ref_ag}</p><p><strong>Date:</strong> {pdf_date_str}</p><br><br><br><p>Authorized Signatory</p></body></html>"""
                            pdf_bytes = convert_html_to_pdf(html_content)
                            if pdf_bytes: st.download_button(f"‚¨áÔ∏è Download Nurse Agreement", data=pdf_bytes, file_name=file_name, mime="application/pdf")
                    
                    with col_b2: 
                        if st.button("Patient Agreement", key="btn_pa_ag"):
                            display_type = "PATIENT AGREEMENT"
                            file_name = generate_filename("Patient", "AGR", row_ag['Name'])
                            html_content = f"""<!DOCTYPE html><html><head><style>@page {{ size: a4 portrait; margin: 1cm; }} body {{ font-family: 'Helvetica', sans-serif; }} .header {{ text-align: center; }}</style></head><body><div class="header"><img src="data:image/png;base64,{logo_b64}" width="100"><h2>Vesak Care Foundation</h2></div><h3>{display_type}</h3><p><strong>Ref:</strong> {c_ref_ag}</p><p><strong>Date:</strong> {pdf_date_str}</p><br><br><br><p>Authorized Signatory</p></body></html>"""
                            pdf_bytes = convert_html_to_pdf(html_content)
                            if pdf_bytes: st.download_button(f"‚¨áÔ∏è Download Patient Agreement", data=pdf_bytes, file_name=file_name, mime="application/pdf")

    except Exception as e: st.error(f"Error: {e}")
