import streamlit as st
import pandas as pd
import base64
import os
import datetime
import requests
import math 
import re 
import json
from io import BytesIO
from PIL import Image, ImageFile
import streamlit.components.v1 as components
from xhtml2pdf import pisa 
import gspread
from google.oauth2.service_account import Credentials
import numpy as np

# --- CRITICAL FIX FOR BROKEN IMAGES ---
ImageFile.LOAD_TRUNCATED_IMAGES = True

# ==========================================
# 1. SETUP & CONFIGURATION
# ==========================================
st.set_page_config(page_title="Vesak Care Invoice", layout="wide", page_icon="ğŸ¥")

LOGO_FILE = "logo.png"
URL_CONFIG_FILE = "url_config.txt"
SYSTEM_CONFIG_FILE = "system_config.json" 

# --- HEADERS (34 COLUMNS) ---
SHEET_HEADERS = [
    "UID", "Serial No.", "Ref. No.", "Invoice Number", "Date", "Generated At",
    "Customer Name", "Age", "Gender", "Location", "Address", "Mobile",
    "Plan", "Shift", "Recurring Service", "Period", "Visits", "Amount",
    "Notes / Remarks", "Generated By", "Amount Paid", "Details",
    "Service Started", "Service Ended", "Referral Code", "Referral Name",
    "Referral Credit", "Net Amount", "Nurse Payment", "Paid for", "Earnings",
    "Nurse Name", "Nurse Name (Extra)", "Nurse Note" 
]

# --- SESSION STATE INITIALIZATION ---
if 'chk_overwrite' not in st.session_state: st.session_state.chk_overwrite = False

# --- CONFIGURATION LOADER ---
def load_system_config():
    default_config = {
        "master_sheet_url": "",
        "backup_sheet_url": ""
    }
    if os.path.exists(SYSTEM_CONFIG_FILE):
        try:
            with open(SYSTEM_CONFIG_FILE, "r") as f:
                return json.load(f)
        except: return default_config
    return default_config

def save_system_config(config_data):
    with open(SYSTEM_CONFIG_FILE, "w") as f:
        json.dump(config_data, f)

def load_config_path(file_name):
    if os.path.exists(file_name):
        with open(file_name, "r") as f: return f.read().strip()
    return ""

def save_config_path(path, file_name):
    with open(file_name, "w") as f: f.write(path.replace('\"', '').strip())
    return path

def extract_id_from_url(url):
    if not url: return ""
    match = re.search(r"/d/([a-zA-Z0-9-_]+)", url)
    if match: return match.group(1)
    if len(url) > 20 and "/" not in url: return url
    return ""

sys_config = load_system_config()

# --- GOOGLE AUTHENTICATION ---
@st.cache_resource
def get_credentials():
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        s_info = st.secrets["connections"]["gsheets"]
        private_key = s_info.get("private_key").replace("\\\\n", "\\n")
        creds_dict = {
            "type": s_info.get("type"),
            "project_id": s_info.get("project_id"),
            "private_key_id": s_info.get("private_key_id"),
            "private_key": private_key,
            "client_email": s_info.get("client_email"),
            "client_id": s_info.get("client_id"),
            "auth_uri": s_info.get("auth_uri"),
            "token_uri": s_info.get("token_uri"),
            "auth_provider_x509_cert_url": s_info.get("auth_provider_x509_cert_url"),
            "client_x509_cert_url": s_info.get("client_x509_cert_url"),
        }
        return Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return None

def get_gspread_client():
    creds = get_credentials()
    if creds: return gspread.authorize(creds)
    return None

# ==========================================
# FILE HANDLING & HELPERS
# ==========================================
@st.cache_data(show_spinner=False)
def robust_file_downloader(url):
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Referer': 'https://www.google.com/'
    })
    download_url = url
    if "?" in url: base_url = url.split("?")[0]
    else: base_url = url
    if "1drv.ms" in url or "sharepoint" in url or "onedrive" in url:
        download_url = base_url + "?download=1"
    try:
        response = session.get(download_url, verify=False, allow_redirects=True)
        if response.status_code == 200:
            return BytesIO(response.content)
        raise Exception(f"Status Code: {response.status_code}")
    except Exception as e: return None

def format_date_with_suffix(d):
    """
    Returns date in format: "Jan 23rd 2026"
    """
    if pd.isna(d): return "N/A"
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        if not isinstance(d, datetime.date): return str(d)
        
        day = d.day
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(day % 10, "th") if not 10 < day < 14 else "th"
        return d.strftime(f"%b. {day}{suffix} %Y")
    except: return str(d)

def format_date_simple(d):
    """
    Returns date in format: "DD-MM-YYYY" (No Time)
    """
    if pd.isna(d): return ""
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        return d.strftime("%d-%m-%Y")
    except: return str(d)

def clean_text(text): return str(text).strip() if isinstance(text, str) else str(text)

# ===== CRITICAL FIX 1: ID NORMALIZATION (NO DECIMALS) =====
# â­ CHANGE #1: ENHANCED normalize_id() FUNCTION
def normalize_id(val):
    """
    Robust normalization:
    1. Handles "1.0" (float string) -> float 1.0 -> int 1 -> string "1"
    2. Handles 1.0 (float) -> int 1 -> string "1"
    3. Handles "1" (string) -> string "1"
    4. Handles NaN/None -> ""
    """
    if pd.isna(val): return ""
    s_val = str(val).strip()
    if s_val == "" or s_val.lower() == "nan": return ""
    try:
        # Convert to float first (handles "123.0"), then int (drops .0), then str
        return str(int(float(s_val)))
    except:
        # If conversion fails (e.g., alphanumeric "A123"), return stripped string
        return s_val

# --- CRITICAL FIX 2: CLEAN REFERRAL DATA (NO 'nan') ---
def clean_referral_field(val):
    """
    Ensures that empty cells in Excel stay empty in Google Sheets.
    Removes 'nan', 'NaN', 'None', etc.
    """
    if pd.isna(val): return ""
    s_val = str(val).strip()
    if s_val.lower() == "nan": return ""
    if s_val.lower() == "none": return ""
    if s_val == "": return ""
    return s_val

# --- CRITICAL FIX 3: CACHED EXCLUSION LIST (FIXES 429 ERROR) ---
@st.cache_data(ttl=300, show_spinner=False)
def get_cached_exclusion_list(master_id, month_str):
    """
    Fetches the exclusion list with caching (5 mins) to prevent 429 Quota Errors.
    """
    client = get_gspread_client()
    if not client or not master_id: return []
    
    excluded_refs = []
    try:
        wb = client.open_by_key(master_id)
        try:
            sheet_check = wb.worksheet(month_str)
            data_check = sheet_check.get_all_records()
            df_check = pd.DataFrame(data_check)
            
            if not df_check.empty and 'Service Ended' in df_check.columns:
                df_check['Ref_Norm'] = df_check['Ref. No.'].apply(normalize_id)
                df_check['Ser_Norm'] = df_check['Serial No.'].apply(normalize_id)
                
                date_pattern = r'\d{1,2}-\d{1,2}-\d{2,4}'
                ended_mask = df_check['Service Ended'].astype(str).str.contains(date_pattern, regex=True, na=False)
                ended_rows = df_check[ended_mask]
                
                if not ended_rows.empty:
                    for _, r_end in ended_rows.iterrows():
                        key = f"{normalize_id(r_end['Ref. No.'])}-{normalize_id(r_end['Serial No.'])}"
                        excluded_refs.append(key)
        except gspread.exceptions.WorksheetNotFound: pass
    except Exception as e:
        return []
        
    return excluded_refs

def generate_filename(doc_type, invoice_no, customer_name):
    """
    Generates consistent filename format for all invoice types.
    Format: {PREFIX}-{INVOICE_NO}-{CUSTOMER_NAME}.pdf
    """
    prefix = {
        "Invoice": "IN",
        "Nurse": "NU",
        "Patient": "PA"
    }.get(doc_type, "DOC")
    
    # Remove special characters and convert to uppercase
    clean_name = re.sub(r'[^a-zA-Z0-9]', '-', str(customer_name)).upper().strip('-')
    
    return f"{prefix}-{invoice_no}-{clean_name}.pdf"

# --- HELPER FUNCTIONS FOR LISTS ---
def get_base_lists(selected_plan, selected_sub_service):
    SERVICES_MASTER = {
        "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
        "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
        "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
        "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
        "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
        "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
        "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
    }
    STANDARD_PLANS = list(SERVICES_MASTER.keys())[:5]
    
    master_list = SERVICES_MASTER.get(selected_plan, [])
    if "All" in str(selected_sub_service) and selected_plan in STANDARD_PLANS:
        included_raw = [s for s in master_list if s.lower() != "all"]
    else: included_raw = [x.strip() for x in str(selected_sub_service).split(',')]
    included_clean = sorted(list(set([clean_text(s) for s in included_raw if clean_text(s)])))
    not_included_clean = []
    if selected_plan in STANDARD_PLANS:
        for plan_name in STANDARD_PLANS:
            if plan_name == selected_plan: continue 
            for item in SERVICES_MASTER.get(plan_name, []):
                if item.lower() == "all": continue
                cleaned = clean_text(item)
                if cleaned: not_included_clean.append(cleaned)
    else:
        for item in master_list:
            cleaned = clean_text(item)
            if cleaned and cleaned not in included_clean: not_included_clean.append(cleaned)
    return included_clean, list(set(not_included_clean))

# --- NEW HTML HELPERS (INSERTED) ---
def construct_description_html(row):
    shift_raw = str(row.get('Shift', '')).strip()
    recurring = str(row.get('Recurring Service', '')).strip().lower()
    period_raw = str(row.get('Period', '')).strip()
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_str = shift_map.get(shift_raw, shift_raw)
    time_suffix = " (Time)" if "12" in shift_str else ""
    return f"""<div style="margin-top: 4px;"><div style="font-size: 12px; color: #4a4a4a; font-weight: bold;">{shift_str}{time_suffix}</div><div style="font-size: 10px; color: #777; font-style: italic; margin-top: 2px;">{period_raw}</div></div>"""

def construct_amount_html(row, billing_qty):
    try: unit_rate = float(row.get('Unit Rate', 0)) 
    except: unit_rate = 0.0
    try: visits_needed = int(float(row.get('Visits', 0)))
    except: visits_needed = 0
    
    period_raw = str(row.get('Period', '')).strip()
    period_lower = period_raw.lower()
    shift_raw = str(row.get('Shift', '')).strip()
    
    # NEW LOGIC FOR DETECTING "PER VISIT"
    is_per_visit = "per visit" in shift_raw.lower()
    
    billing_note = ""
    def get_plural(unit, qty):
        if "month" in unit.lower(): return "Months" if qty > 1 else "Month"
        if "week" in unit.lower(): return "Weeks" if qty > 1 else "Week"
        if "day" in unit.lower(): return "Days" if qty > 1 else "Day"
        if "visit" in unit.lower(): return "Visits" if qty > 1 else "Visit" 
        return unit

    if is_per_visit:
        paid_text = f"Paid for {billing_qty} {get_plural('Visit', billing_qty)}"
        if visits_needed > 1 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif billing_qty >= visits_needed: billing_note = f"Paid for {visits_needed} Visits."
        elif visits_needed == 1: billing_note = "Paid for 1 Visit."
        elif billing_qty < visits_needed: billing_note = f"Next Bill will be Generated after {billing_qty} Visits."
        else: billing_note = paid_text
    elif "month" in period_lower or "week" in period_lower:
        base_unit = "Month" if "month" in period_lower else "Week"
        paid_text = f"Paid for {billing_qty} {get_plural(base_unit, billing_qty)}"
        if visits_needed > 1 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif visits_needed > billing_qty: billing_note = f"Next Bill will be Generated after {billing_qty} {get_plural(base_unit, billing_qty)}."
        else: billing_note = paid_text
    elif "daily" in period_lower:
        paid_text = f"Paid for {billing_qty} {get_plural('Day', billing_qty)}"
        if 1 < visits_needed < 6 and billing_qty == 1: billing_note = "Next Billing will be generated after the Payment to Continue the Service."
        elif billing_qty >= visits_needed: billing_note = f"Paid for {visits_needed} Days."
        elif visits_needed == 1: billing_note = "Paid for 1 Day."
        elif billing_qty < visits_needed: billing_note = f"Next Bill will be Generated after {billing_qty} Days."
        else: billing_note = paid_text
    else:
        paid_text = f"Paid for {billing_qty} {period_raw}"
        billing_note = ""
    
    total_amount = unit_rate * billing_qty
    shift_map = {"12-hr Day": "12 Hours - Day", "12-hr Night": "12 Hours - Night", "24-hr": "24 Hours"}
    shift_display = shift_map.get(shift_raw, shift_raw)
    if "12" in shift_display and "Time" not in shift_display: shift_display += " (Time)"
    
    period_display = "Monthly" if "month" in period_lower else period_raw.capitalize()
    if "daily" in period_lower: period_display = "Daily"
    if is_per_visit: period_display = "Visit"
    
    unit_rate_str = "{:,.0f}".format(unit_rate)
    total_amount_str = "{:,.0f}".format(total_amount)
    
    unit_label = "Month" if "month" in period_lower else "Week" if "week" in period_lower else "Day"
    if is_per_visit: unit_label = "Visit"
    
    paid_for_text = f"Paid for {billing_qty} {get_plural(unit_label, billing_qty)}"

    return f"""
    <div style="text-align: right; font-size: 13px; color: #555;">
        <div style="margin-bottom: 4px;">{shift_display} / {period_display} = <b>â‚¹ {unit_rate_str}</b></div>
        <div style="color: #CC4E00; font-weight: bold; font-size: 14px; margin: 2px 0;">X</div>
        <div style="font-weight: bold; font-size: 13px; margin: 2px 0; color: #333;">{paid_for_text}</div>
        <div style="border-bottom: 1px solid #ccc; width: 100%; margin: 6px 0;"></div>
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px;">
            <span style="font-size: 13px; font-weight: 800; color: #002147; text-transform: uppercase;">TOTAL - </span>
            <span style="font-size: 16px; font-weight: bold; color: #000;">Rs. {total_amount_str}</span>
        </div>
        <div style="font-size: 10px; color: #666; font-style: italic; margin-top: 6px;">{billing_note}</div>
    </div>
    """

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â­ CHANGE #1: ENHANCED PDF CONVERSION FUNCTION (PDF QUALITY FIX)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def convert_html_to_pdf(source_html, page_size="A4"):
    """
    Enhanced PDF conversion with print optimization.
    - Optimizes margins for A4 page
    - Ensures single-page fitting
    - Improves color/image quality
    - Applies print-friendly styling
    
    CHANGED: Added page_size parameter, enhanced CSS injection, added xhtml=True
    """
    result = BytesIO()
    
    # Inject print-optimized CSS wrapper
    enhanced_html = f"""
    <html>
    <head>
    <style>
        @page {{
            size: A4;
            margin: 0.5cm 0.5cm 0.5cm 0.5cm;
            orphans: 0;
            widows: 0;
        }}
        @media print {{
            * {{
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }}
            body {{
                margin: 0;
                padding: 0;
                background: white;
            }}
            img {{
                max-width: 100%;
                height: auto;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }}
        }}
    </style>
    </head>
    <body>
    {source_html}
    </body>
    </html>
    """
    
    try:
        pisa_status = pisa.CreatePDF(
            enhanced_html, 
            dest=result,
            xhtml=True
        )
        if pisa_status.err:
            return None
        result.seek(0)
        return result.getvalue()
    except Exception as e:
        st.error(f"PDF Generation Error: {e}")
        return None

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â­ CHANGE #2: COMPLETE REDESIGNED INVOICE HTML (SINGLE PAGE + HIGH QUALITY)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
def construct_offline_invoice_html(data_dict, logo_b64, doc_type="INVOICE"):
    """
    Generates optimized single-page HTML for PDF/Print.
    - Compact layout fits A4 page perfectly
    - Professional styling matches preview
    - Print-friendly colors and contrast
    - Optimized margins and spacing
    
    CHANGED: Complete redesign for single-page, high-quality output
    """
    # Extract Data
    inv_num = data_dict.get("Invoice Number", "")
    date_str = data_dict.get("Date", "")
    c_name = data_dict.get("Customer Name", "")
    c_age = data_dict.get("Age", "")
    c_gender = data_dict.get("Gender", "")
    c_mob = data_dict.get("Mobile", "")
    c_addr = data_dict.get("Address", "")
    c_location = data_dict.get("Location", "")
    
    # Plan & Service Details
    plan_name = data_dict.get("Plan", "")
    shift = data_dict.get("Shift", "")
    period = data_dict.get("Period", "")
    recurring = str(data_dict.get("Recurring Service", "")).strip()
    
    # Financial Data
    try: 
        amt_paid = float(data_dict.get("Amount Paid", 0))
        amt_paid_str = "{:,.0f}".format(amt_paid)
    except: 
        amt_paid_str = "0"
    
    try: 
        unit_rate = float(data_dict.get("Unit Rate", 0))
        unit_rate_str = "{:,.0f}".format(unit_rate)
    except: 
        unit_rate_str = "0"
    
    # Additional Fields
    notes = data_dict.get("Notes / Remarks", "")
    generated_by = data_dict.get("Generated By", "")
    service_started = data_dict.get("Service Started", "")
    
    # Colors
    col_navy = "#002147"
    col_gold = "#C5A065"
    
    # Build shift display
    shift_display = shift
    if "12" in str(shift) and "Time" not in str(shift): 
        shift_display += " (Time)"
    
    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style>
        @page {{
            size: A4 portrait;
            margin: 0.5cm;
            orphans: 0;
            widows: 0;
        }}
        
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: Helvetica, Arial, sans-serif;
            font-size: 12px;
            color: #333;
            background: white;
            line-height: 1.4;
        }}
        
        .container {{
            width: 100%;
            padding: 0;
            background: white;
        }}
        
        /* Header Section */
        .header {{
            display: table;
            width: 100%;
            margin-bottom: 10px;
            border-bottom: 2px solid {col_navy};
            padding-bottom: 8px;
        }}
        
        .header-left {{
            display: table-cell;
            width: 60%;
            vertical-align: top;
        }}
        
        .header-right {{
            display: table-cell;
            width: 40%;
            vertical-align: top;
            text-align: right;
        }}
        
        .logo {{
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
        }}
        
        .company-name {{
            font-size: 16px;
            font-weight: bold;
            color: {col_navy};
            margin-bottom: 2px;
        }}
        
        .company-details {{
            font-size: 9px;
            color: #666;
            line-height: 1.3;
        }}
        
        .invoice-type {{
            font-size: 28px;
            color: #e8e8e8;
            font-weight: bold;
            margin-bottom: 2px;
            letter-spacing: 3px;
        }}
        
        .invoice-meta {{
            font-size: 10px;
            color: #666;
        }}
        
        .invoice-meta-label {{
            font-weight: bold;
            color: {col_navy};
        }}
        
        /* Bill To Section */
        .bill-section {{
            background-color: #f6f8fa;
            border-left: 4px solid {col_navy};
            padding: 8px;
            margin: 8px 0;
            page-break-inside: avoid;
        }}
        
        .bill-title {{
            font-size: 9px;
            font-weight: bold;
            color: {col_gold};
            text-transform: uppercase;
            margin-bottom: 4px;
        }}
        
        .customer-name {{
            font-size: 13px;
            font-weight: bold;
            color: {col_navy};
            margin-bottom: 2px;
        }}
        
        .customer-meta {{
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
        }}
        
        .contact-info {{
            font-size: 10px;
            color: #555;
            line-height: 1.3;
        }}
        
        .contact-info b {{
            color: {col_navy};
        }}
        
        /* Items Table */
        .items-table {{
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            page-break-inside: avoid;
        }}
        
        .items-table th {{
            background-color: {col_navy};
            color: white;
            padding: 6px 8px;
            text-align: left;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            border: 1px solid {col_navy};
        }}
        
        .items-table td {{
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }}
        
        .items-table tr:last-child td {{
            border-bottom: 2px solid {col_navy};
        }}
        
        .desc-service {{
            font-weight: bold;
            color: #000;
            margin-bottom: 2px;
        }}
        
        .desc-shift {{
            font-size: 10px;
            color: #555;
            margin: 3px 0;
        }}
        
        .desc-period {{
            font-size: 9px;
            color: #777;
            font-style: italic;
        }}
        
        .amount-column {{
            text-align: right;
            font-weight: bold;
        }}
        
        .amount-value {{
            font-size: 12px;
            color: #000;
            margin-bottom: 2px;
        }}
        
        .amount-note {{
            font-size: 9px;
            color: #777;
            font-style: italic;
        }}
        
        /* Total Section */
        .total-section {{
            margin-top: 8px;
            text-align: right;
            page-break-inside: avoid;
        }}
        
        .total-label {{
            font-size: 12px;
            font-weight: bold;
            color: {col_navy};
            text-transform: uppercase;
        }}
        
        .total-amount {{
            font-size: 18px;
            font-weight: bold;
            color: #000;
            margin-top: 2px;
        }}
        
        /* Footer */
        .footer {{
            margin-top: 12px;
            border-top: 1px solid #ddd;
            padding-top: 6px;
            font-size: 9px;
            color: #777;
            text-align: center;
            line-height: 1.3;
            page-break-inside: avoid;
        }}
        
        /* Notes Section */
        .notes {{
            font-size: 9px;
            color: #666;
            margin-top: 6px;
            font-style: italic;
            page-break-inside: avoid;
        }}
        
        @media print {{
            * {{
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }}
            
            body {{
                margin: 0;
                padding: 0;
            }}
            
            .container {{
                page-break-after: avoid;
            }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="header-left">
                <img src="data:image/png;base64,{logo_b64}" class="logo" alt="Logo">
                <div class="company-name">Vesak Care</div>
                <div class="company-details">
                    Foundation<br>
                    Web: vesakcare.com<br>
                    Phone: +91 7777 000 878<br>
                    Email: vesakcare@gmail.com
                </div>
            </div>
            <div class="header-right">
                <div class="invoice-type">{doc_type}</div>
                <div class="invoice-meta">
                    <span class="invoice-meta-label">Date:</span> {date_str}<br>
                    <span class="invoice-meta-label">Invoice No.:</span> {inv_num}
                </div>
            </div>
        </div>
        
        <!-- BILL TO -->
        <div class="bill-section">
            <div class="bill-title">Billed To</div>
            <div class="customer-name">{c_name}</div>
            <div class="customer-meta">{c_gender} | {c_age} Years</div>
            <div class="contact-info">
                <b>Phone:</b> {c_mob}<br>
                <b>Location:</b> {c_location}<br>
                <b>Address:</b> {c_addr}
            </div>
        </div>
        
        <!-- ITEMS TABLE -->
        <table class="items-table">
            <thead>
                <tr>
                    <th width="65%">Description</th>
                    <th width="35%" style="text-align: right;">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div class="desc-service">{plan_name}</div>
                        <div class="desc-shift">{shift_display} / {period}</div>
                        {f'<div class="desc-period">Recurring: {recurring}</div>' if recurring else ''}
                    </td>
                    <td class="amount-column">
                        <div class="amount-value">â‚¹ {amt_paid_str}</div>
                        <div class="amount-note">@ â‚¹ {unit_rate_str} per unit</div>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <!-- TOTAL -->
        <div class="total-section">
            <div class="total-label">Total Amount</div>
            <div class="total-amount">â‚¹ {amt_paid_str}</div>
        </div>
        
        <!-- NOTES -->
        {f'<div class="notes"><b>Notes:</b> {notes}</div>' if notes else ''}
        
        <!-- FOOTER -->
        <div class="footer">
            <strong>Thank you for choosing Vesak Care Foundation!</strong><br>
            Offices: Pune â€¢ Mumbai â€¢ Kolhapur<br>
            @VesakCare | ISO Certified Healthcare Provider
        </div>
    </div>
</body>
</html>
"""
    return html

def normalize_columns(df, aliases):
    df.columns = df.columns.astype(str).str.strip()
    for standard_name, possible_aliases in aliases.items():
        if standard_name in df.columns: continue 
        for alias in possible_aliases:
            for df_col in df.columns:
                if df_col.lower() == alias.lower():
                    df.rename(columns={df_col: standard_name}, inplace=True); break 
    return df

COLUMN_ALIASES = {
    'Serial No.': ['Serial No.', 'serial no', 'sr no', 'sr. no.', 'id'],
    'Ref. No.': ['Ref. No.', 'ref no', 'ref. no.', 'reference no', 'reference number'],
    'Name': ['Name', 'name', 'patient name', 'client name'],
    'Mobile': ['Mobile', 'mobile', 'phone', 'contact'],
    'Location': ['Location', 'location', 'city'], 
    'Address': ['Address', 'address', 'residence'],
    'Gender': ['Gender', 'gender', 'sex'],
    'Age': ['Age', 'age'],
    'Service Required': ['Service Required', 'service required', 'plan'],
    'Sub Service': ['Sub Service', 'sub service', 'sub plan'],
    'Final Rate': ['Final Rate', 'final rate', 'amount', 'total amount'],
    'Unit Rate': ['Rate Agreed (â‚¹)', 'rate agreed', 'unit rate', 'per day rate'],
    'Call Date': ['Call Date', 'call date', 'date'],
    'Notes': ['Notes / Remarks', 'notes', 'remark'],
    'Shift': ['Shift', 'shift'],
    'Recurring Service': ['Recurring Service', 'recurring', 'recurring service'],
    'Period': ['Period', 'period'],
    'Visits': ['Visits', 'visits', 'visit', 'vists'],
    'Referral Code': ['Referral Code', 'referral code', 'ref code'],
    'Referral Name': ['Referral Name', 'referral name', 'ref name'],
    'Referral Credit': ['Referral Credit', 'referral credit', 'ref credit']
}

# --- DATABASE HELPERS ---
def save_invoice_to_gsheet(data_dict, sheet_obj):
    if sheet_obj is None: return False
    try:
        all_vals = sheet_obj.get_all_values()
        next_row_num = len(all_vals) + 1
        
        existing_uids = []
        for r in all_vals[1:]: 
            if r[0] and r[0].isdigit(): existing_uids.append(int(r[0]))
        
        if existing_uids: new_uid = max(existing_uids) + 1
        else: new_uid = 1
        final_uid = f"{new_uid:04d}"

        formula_net_amount = f"=U{next_row_num}-AA{next_row_num}"
        formula_earnings = f"=AB{next_row_num}-(AC{next_row_num}*AD{next_row_num})"
        
        # --- FIXED: Use passed Raw Value, no regex needed ---
        qty_extracted = data_dict.get("Paid for Raw", 1)
        # --------------------------------------------------

        row_values = [
            final_uid,                              # A
            data_dict.get("Serial No.", ""),        # B
            data_dict.get("Ref. No.", ""),          # C
            data_dict.get("Invoice Number", ""),    # D
            data_dict.get("Date", ""),              # E
            data_dict.get("Generated At", ""),      # F
            data_dict.get("Customer Name", ""),     # G
            data_dict.get("Age", ""),               # H
            data_dict.get("Gender", ""),            # I
            data_dict.get("Location", ""),          # J
            data_dict.get("Address", ""),           # K
            data_dict.get("Mobile", ""),            # L
            data_dict.get("Plan", ""),              # M
            data_dict.get("Shift", ""),             # N
            data_dict.get("Recurring Service", ""), # O
            data_dict.get("Period", ""),            # P
            data_dict.get("Visits", ""),            # Q
            data_dict.get("Amount", ""),            # R
            data_dict.get("Notes / Remarks", ""),   # S
            data_dict.get("Generated By", ""),      # T
            data_dict.get("Amount Paid", ""),       # U
            data_dict.get("Details", ""),           # V
            data_dict.get("Service Started", ""),   # W (DD-MM-YYYY)
            data_dict.get("Service Ended", ""),     # X (DD-MM-YYYY)
            data_dict.get("Referral Code", ""),     # Y
            data_dict.get("Referral Name", ""),     # Z
            data_dict.get("Referral Credit", ""),   # AA
            formula_net_amount,                     # AB
            "",                                     # AC
            qty_extracted,                          # AD (Updated with RAW)
            formula_earnings,                       # AE
            "",                                     # AF
            "",                                     # AG
            ""                                      # AH
        ]
        sheet_obj.append_row(row_values, value_input_option='USER_ENTERED')
        return True
    except Exception as e: st.error(f"Save Error: {e}"); return False

# â­ CHANGE #7: NEW FUNCTION - update_invoice_in_gsheet()
def update_invoice_in_gsheet(data_dict, sheet_obj, row_idx):
    """
    Updates an existing row in the Google Sheet instead of appending.
    Only updates columns A through X (customer data).
    Preserves UID and other calculated columns.
    """
    if sheet_obj is None: return False
    try:
        # Update columns A through X (Indices 0 to 23 in data, 1-24 in Sheet)
        row_values = [
            data_dict.get("UID", ""), 
            data_dict.get("Serial No.", ""), 
            data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""), 
            data_dict.get("Date", ""), 
            data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""), 
            data_dict.get("Age", ""), 
            data_dict.get("Gender", ""),
            data_dict.get("Location", ""), 
            data_dict.get("Address", ""), 
            data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""), 
            data_dict.get("Shift", ""), 
            data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""), 
            data_dict.get("Visits", ""), 
            data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""), 
            data_dict.get("Generated By", ""), 
            data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""), 
            data_dict.get("Service Started", ""), 
            data_dict.get("Service Ended", "")
        ]
        range_name = f"A{row_idx}:X{row_idx}"
        sheet_obj.update(range_name, [row_values], value_input_option='USER_ENTERED')
        
        # --- NEW CODE: Update Column AD (Paid for) ---
        # Fixed: Use exact raw number passed from data_dict
        qty_extracted = data_dict.get("Paid for Raw", 1)
        sheet_obj.update(f"AD{row_idx}", [[qty_extracted]], value_input_option='USER_ENTERED')
        # -----------------------------------------------

        return True
    except Exception as e: st.error(f"Update Error: {e}"); return False

def update_nurse_management(sheet_obj, invoice_number, payment_amount, nurse_name, nurse_extra, nurse_note):
    if sheet_obj is None: return False, None
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4) 
        if cell:
            row_idx = cell.row
            details_val = sheet_obj.cell(row_idx, 22).value
            qty = 1
            if details_val:
                match = re.search(r'Paid for\s*:?\s*(\d+)', str(details_val), re.IGNORECASE)
                if match: qty = int(match.group(1))
            
            formula_string = f"=AB{row_idx}-(AC{row_idx}*AD{row_idx})"
            range_update = f"AC{row_idx}:AH{row_idx}"
            values = [[payment_amount, qty, formula_string, nurse_name, nurse_extra, nurse_note]]
            sheet_obj.update(range_update, values, value_input_option='USER_ENTERED')
            return True, formula_string
        return False, None
    except Exception as e: st.error(f"Nurse Update Error: {e}"); return False, None

def mark_service_ended(sheet_obj, invoice_number, end_date):
    if sheet_obj is None: return False, "No Sheet"
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            # CRITICAL: Format DD-MM-YYYY NO TIME
            end_time_str = format_date_simple(end_date)
            range_name = f"X{cell.row}"
            sheet_obj.update(range_name, [[end_time_str]])
            return True, end_time_str
        return False, "Invoice not found"
    except Exception as e: return False, str(e)

def get_clean_image_base64(file_path):
    if not os.path.exists(file_path): return None
    try:
        img = Image.open(file_path).convert("RGBA")
        buffer = BytesIO()
        img.save(buffer, format="PNG", optimize=True)
        return base64.b64encode(buffer.getvalue()).decode('utf-8')
    except: return None

def get_absolute_path(filename):
    if os.path.exists(filename): return os.path.abspath(filename).replace('\\\\', '/')
    return None

# ==========================================
# BACKUP LOGIC
# ==========================================
def perform_backup_logic(master_data, backup_url, target_month_str):
    client = get_gspread_client()
    backup_id = extract_id_from_url(backup_url)
    if not backup_id or not client: return False, "Invalid Backup Configuration."
    try:
        backup_wb = client.open_by_key(backup_id)
        try:
            target_ws = backup_wb.worksheet(target_month_str)
            return False, f"Backup for {target_month_str} already exists. Skipping to prevent overwrite."
        except gspread.exceptions.WorksheetNotFound: pass

        try:
            default_ws = backup_wb.worksheet("Sheet1")
            default_ws.update_title(target_month_str)
            target_ws = default_ws
        except gspread.exceptions.WorksheetNotFound:
            target_ws = backup_wb.add_worksheet(title=target_month_str, rows=1000, cols=34)

        target_ws.clear()
        target_ws.update(range_name="A1", values=master_data, value_input_option='USER_ENTERED')
        try: target_ws.format("A1:AH1", {"textFormat": {"bold": True}, "backgroundColor": {"red": 0.8, "green": 0.8, "blue": 0.8}})
        except: pass
        return True, f"âœ… Success! Data backed up to sheet '{target_month_str}' in Backup Workbook."
    except Exception as e: return False, f"Backup Failed: {str(e)}"

# ==========================================
# UI & MAIN LOGIC
# ==========================================
st.title("ğŸ¥ Vesak Care - Invoice Generator")

abs_logo_path = get_absolute_path(LOGO_FILE)
logo_b64 = get_clean_image_base64(LOGO_FILE)

# --- SIDEBAR CONFIGURATION ---
with st.sidebar:
    with st.expander("âš™ï¸ Configuration", expanded=False):
        st.subheader("Google Sheet URLs")
        master_url = st.text_input(
            "Master Sheet URL",
            value=sys_config.get("master_sheet_url", ""),
            key="master_url_input"
        )
        if master_url:
            sys_config["master_sheet_url"] = master_url
            save_system_config(sys_config)
        
        backup_url = st.text_input(
            "Backup Sheet URL (Optional)",
            value=sys_config.get("backup_sheet_url", ""),
            key="backup_url_input"
        )
        if backup_url:
            sys_config["backup_sheet_url"] = backup_url
            save_system_config(sys_config)
        
        if st.button("âœ… Save Configuration"):
            st.success("Configuration saved!")

# --- EXTRACT SHEET IDs ---
master_id = extract_id_from_url(sys_config.get("master_sheet_url", ""))
backup_id = extract_id_from_url(sys_config.get("backup_sheet_url", ""))

# --- GET CURRENT MONTH STRING ---
current_month_str = datetime.datetime.now().strftime("%B %Y")

# --- FETCH MASTER SHEET ---
df_master = None
client = get_gspread_client()

if client and master_id:
    try:
        wb = client.open_by_key(master_id)
        try:
            ws = wb.worksheet(current_month_str)
        except gspread.exceptions.WorksheetNotFound:
            ws = wb.add_worksheet(title=current_month_str, rows=1000, cols=34)
        
        all_records = ws.get_all_records()
        if all_records:
            df_master = pd.DataFrame(all_records)
        else:
            df_master = pd.DataFrame()
    except Exception as e:
        st.error(f"Error connecting to Master Sheet: {e}")
        df_master = None
else:
    st.warning("âš ï¸ Master Sheet not configured. Please configure in Settings.")
    df_master = None

# --- MAIN TABS ---
tab1, tab2, tab3, tab4 = st.tabs(["ğŸ“ Create Invoice", "ğŸ“Š View History", "ğŸ’¾ Backup", "â„¹ï¸ Info"])

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 1: CREATE INVOICE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab1:
    st.header("ğŸ“ Create New Invoice")
    
    col_mode = st.columns(2)
    with col_mode[0]:
        mode = st.radio("Select Mode:", ["From Confirmed List", "Manual Entry"], horizontal=True, key="mode_select")
    
    if mode == "From Confirmed List":
        if df_master is not None and not df_master.empty:
            st.subheader("Select Customer from Confirmed Customers")
            
            # Normalize columns
            df_master = normalize_columns(df_master, COLUMN_ALIASES)
            
            # Extract unique customers
            customers = []
            for idx, row in df_master.iterrows():
                serial = normalize_id(row.get('Serial No.', ''))
                ref = normalize_id(row.get('Ref. No.', ''))
                name = clean_text(row.get('Name', row.get('Customer Name', 'Unknown')))
                mob = clean_text(row.get('Mobile', ''))
                
                if serial and ref and name:
                    customers.append({
                        'Serial No.': serial,
                        'Ref. No.': ref,
                        'Customer Name': name,
                        'Mobile': mob,
                        'idx': idx
                    })
            
            if customers:
                # Display customers
                customer_options = [f"{c['Customer Name']} (Ref: {c['Ref. No.']}, Serial: {c['Serial No.']})" for c in customers]
                selected_idx = st.selectbox("Choose Customer:", range(len(customer_options)), format_func=lambda i: customer_options[i], key="customer_select")
                selected_customer = customers[selected_idx]
                selected_row = df_master.iloc[selected_customer['idx']]
                
                st.write("---")
                
                # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                # â­ CHANGE #3: ENHANCED DOWNLOAD BUTTON (HIGH QUALITY + FILENAME)
                # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                
                # Get exclusion list
                excluded_refs = get_cached_exclusion_list(master_id, current_month_str)
                conflict_key = f"{selected_customer['Ref. No.']}-{selected_customer['Serial No.']}"
                is_excluded = conflict_key in excluded_refs
                
                if is_excluded:
                    st.warning("âš ï¸ This customer's service has ended. Cannot create new invoice.")
                else:
                    st.success(f"âœ… Customer Selected: {selected_customer['Customer Name']}")
                    
                    # Extract initial data
                    c_name = selected_customer['Customer Name']
                    c_mobile = selected_customer['Mobile']
                    
                    # Input form
                    with st.form("invoice_form"):
                        col1, col2, col3 = st.columns(3)
                        
                        with col1:
                            inv_date = st.date_input("Invoice Date", datetime.date.today(), key="inv_date")
                        
                        with col2:
                            inv_no = st.text_input("Invoice Number", value="INV-001", key="inv_no")
                        
                        with col3:
                            generated_by = st.text_input("Generated By", value="Admin", key="gen_by")
                        
                        col4, col5, col6 = st.columns(3)
                        
                        with col4:
                            plan = st.selectbox("Select Plan", [
                                "Plan A: Patient Attendant Care",
                                "Plan B: Skilled Nursing",
                                "Plan C: Chronic Management",
                                "Plan D: Elderly Companion",
                                "Plan E: Maternal & Newborn",
                                "Plan F: Rehabilitative Care",
                                "A-la-carte Services"
                            ], key="plan_select")
                        
                        with col5:
                            shift = st.selectbox("Shift", ["12-hr Day", "12-hr Night", "24-hr", "Per Visit"], key="shift_select")
                        
                        with col6:
                            period = st.selectbox("Period", ["Daily", "Weekly", "Monthly"], key="period_select")
                        
                        col7, col8, col9 = st.columns(3)
                        
                        with col7:
                            unit_rate = st.number_input("Unit Rate (â‚¹)", min_value=0, value=1000, step=100, key="unit_rate")
                        
                        with col8:
                            billing_qty = st.number_input("Billing Quantity", min_value=1, value=1, key="billing_qty")
                        
                        with col9:
                            total_amount = unit_rate * billing_qty
                            st.metric("Total Amount", f"â‚¹ {total_amount:,.0f}")
                        
                        notes = st.text_area("Notes / Remarks", value="", key="notes_field")
                        
                        col_submit = st.columns([1, 1])
                        with col_submit[0]:
                            submit_btn = st.form_submit_button("âœ… Generate Invoice", use_container_width=True)
                        
                        if submit_btn:
                            # Prepare data
                            data_dict = {
                                "Serial No.": selected_customer['Serial No.'],
                                "Ref. No.": selected_customer['Ref. No.'],
                                "Invoice Number": inv_no,
                                "Date": format_date_with_suffix(inv_date),
                                "Generated At": datetime.datetime.now().strftime("%d-%m-%Y %H:%M:%S"),
                                "Customer Name": c_name,
                                "Age": selected_row.get('Age', ''),
                                "Gender": selected_row.get('Gender', ''),
                                "Location": selected_row.get('Location', ''),
                                "Address": selected_row.get('Address', ''),
                                "Mobile": c_mobile,
                                "Plan": plan,
                                "Shift": shift,
                                "Recurring Service": "Yes",
                                "Period": period,
                                "Visits": "",
                                "Amount": str(total_amount),
                                "Notes / Remarks": notes,
                                "Generated By": generated_by,
                                "Amount Paid": str(total_amount),
                                "Details": f"Paid for {billing_qty} {period.lower()}(s)",
                                "Service Started": format_date_simple(inv_date),
                                "Service Ended": "",
                                "Referral Code": "",
                                "Referral Name": "",
                                "Referral Credit": "",
                                "Unit Rate": str(unit_rate),
                                "Paid for Raw": billing_qty
                            }
                            
                            # Save to sheet
                            if save_invoice_to_gsheet(data_dict, ws):
                                st.success(f"âœ… Invoice saved! Invoice No: {inv_no}")
                                
                                # Generate HTML
                                invoice_html = construct_offline_invoice_html(data_dict, logo_b64, "INVOICE")
                                
                                st.write("---")
                                st.subheader("ğŸ“„ Invoice Preview")
                                st.components.v1.html(invoice_html, height=800, scrolling=True)
                                
                                st.write("---")
                                
                                # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                # â­ CHANGE #3: ENHANCED DOWNLOAD & PRINT BUTTONS (HIGH QUALITY)
                                # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                
                                col1, col2 = st.columns([1, 1])
                                
                                # Generate consistent filename
                                filename_pdf = generate_filename("Invoice", str(inv_no), str(c_name))
                                
                                with col1:
                                    if st.button("ğŸ–¨ï¸ Print Invoice", key="btn_print_invoice", use_container_width=True):
                                        # JavaScript for print with optimal settings
                                        st.write("""
                                        <script>
                                            window.onload = function() {
                                                window.print();
                                            };
                                        </script>
                                        """, unsafe_allow_html=True)
                                        st.info("â„¹ï¸ Print dialog opened. Select printer to continue.")
                                
                                with col2:
                                    # Enhanced PDF generation (HIGH QUALITY)
                                    pdf_bytes = convert_html_to_pdf(invoice_html, page_size="A4")
                                    if pdf_bytes:
                                        st.download_button(
                                            label="ğŸ“¥ Download (High Quality PDF)",
                                            data=pdf_bytes,
                                            file_name=filename_pdf,
                                            mime="application/pdf",
                                            key="btn_download_invoice",
                                            use_container_width=True
                                        )
                                    else:
                                        st.error("âŒ PDF generation failed. Try again.")
                            else:
                                st.error("âŒ Failed to save invoice. Check sheet permissions.")
            else:
                st.info("No customers found in the Confirmed List.")
        else:
            st.warning("Unable to load customer list. Check sheet configuration.")
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # MANUAL ENTRY MODE (Similar structure but with manual customer input)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    else:
        st.subheader("Manual Invoice Creation")
        
        with st.form("manual_invoice_form"):
            col1, col2, col3 = st.columns(3)
            
            with col1:
                c_name = st.text_input("Customer Name", key="man_c_name")
            with col2:
                c_mobile = st.text_input("Mobile", key="man_c_mobile")
            with col3:
                c_age = st.number_input("Age", min_value=0, max_value=120, value=30, key="man_c_age")
            
            col4, col5, col6 = st.columns(3)
            with col4:
                c_gender = st.selectbox("Gender", ["Male", "Female", "Other"], key="man_c_gender")
            with col5:
                c_location = st.text_input("Location", key="man_c_location")
            with col6:
                c_addr = st.text_input("Address", key="man_c_addr")
            
            col7, col8, col9 = st.columns(3)
            with col7:
                inv_date = st.date_input("Invoice Date", datetime.date.today(), key="man_inv_date")
            with col8:
                inv_no = st.text_input("Invoice Number", value="INV-001", key="man_inv_no")
            with col9:
                generated_by = st.text_input("Generated By", value="Admin", key="man_gen_by")
            
            col10, col11, col12 = st.columns(3)
            with col10:
                plan = st.selectbox("Plan", [
                    "Plan A: Patient Attendant Care",
                    "Plan B: Skilled Nursing",
                    "Plan C: Chronic Management",
                    "Plan D: Elderly Companion",
                    "Plan E: Maternal & Newborn",
                    "Plan F: Rehabilitative Care",
                    "A-la-carte Services"
                ], key="man_plan")
            
            with col11:
                shift = st.selectbox("Shift", ["12-hr Day", "12-hr Night", "24-hr", "Per Visit"], key="man_shift")
            
            with col12:
                period = st.selectbox("Period", ["Daily", "Weekly", "Monthly"], key="man_period")
            
            col13, col14, col15 = st.columns(3)
            with col13:
                unit_rate = st.number_input("Unit Rate (â‚¹)", min_value=0, value=1000, step=100, key="man_unit_rate")
            with col14:
                billing_qty = st.number_input("Billing Quantity", min_value=1, value=1, key="man_billing_qty")
            with col15:
                total_amount = unit_rate * billing_qty
                st.metric("Total Amount", f"â‚¹ {total_amount:,.0f}")
            
            notes = st.text_area("Notes / Remarks", value="", key="man_notes")
            
            if st.form_submit_button("âœ… Generate Invoice", use_container_width=True):
                if not c_name or not c_mobile:
                    st.error("âŒ Customer Name and Mobile are required.")
                else:
                    data_dict = {
                        "Serial No.": "MAN-001",
                        "Ref. No.": "MAN-001",
                        "Invoice Number": inv_no,
                        "Date": format_date_with_suffix(inv_date),
                        "Generated At": datetime.datetime.now().strftime("%d-%m-%Y %H:%M:%S"),
                        "Customer Name": c_name,
                        "Age": str(c_age),
                        "Gender": c_gender,
                        "Location": c_location,
                        "Address": c_addr,
                        "Mobile": c_mobile,
                        "Plan": plan,
                        "Shift": shift,
                        "Recurring Service": "No",
                        "Period": period,
                        "Visits": "",
                        "Amount": str(total_amount),
                        "Notes / Remarks": notes,
                        "Generated By": generated_by,
                        "Amount Paid": str(total_amount),
                        "Details": f"Paid for {billing_qty} {period.lower()}(s)",
                        "Service Started": format_date_simple(inv_date),
                        "Service Ended": "",
                        "Referral Code": "",
                        "Referral Name": "",
                        "Referral Credit": "",
                        "Unit Rate": str(unit_rate),
                        "Paid for Raw": billing_qty
                    }
                    
                    # Generate HTML
                    invoice_html = construct_offline_invoice_html(data_dict, logo_b64, "INVOICE")
                    
                    st.write("---")
                    st.subheader("ğŸ“„ Invoice Preview")
                    st.components.v1.html(invoice_html, height=800, scrolling=True)
                    
                    st.write("---")
                    
                    col1, col2 = st.columns([1, 1])
                    
                    filename_pdf = generate_filename("Invoice", str(inv_no), str(c_name))
                    
                    with col1:
                        if st.button("ğŸ–¨ï¸ Print Invoice", key="btn_print_manual", use_container_width=True):
                            st.write("""
                            <script>
                                window.onload = function() {
                                    window.print();
                                };
                            </script>
                            """, unsafe_allow_html=True)
                            st.info("â„¹ï¸ Print dialog opened.")
                    
                    with col2:
                        pdf_bytes = convert_html_to_pdf(invoice_html, page_size="A4")
                        if pdf_bytes:
                            st.download_button(
                                label="ğŸ“¥ Download (High Quality PDF)",
                                data=pdf_bytes,
                                file_name=filename_pdf,
                                mime="application/pdf",
                                key="btn_download_manual",
                                use_container_width=True
                            )
                        else:
                            st.error("âŒ PDF generation failed.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 2: VIEW HISTORY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab2:
    st.header("ğŸ“Š Invoice History")
    
    if df_master is not None and not df_master.empty:
        st.dataframe(df_master, use_container_width=True)
        
        st.write(f"**Total Records:** {len(df_master)}")
    else:
        st.info("No invoices found.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 3: BACKUP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab3:
    st.header("ğŸ’¾ Backup Operations")
    
    if st.button("ğŸ”„ Backup Current Month Data", use_container_width=True):
        if df_master is not None and not df_master.empty:
            master_data = [SHEET_HEADERS] + df_master.values.tolist()
            success, msg = perform_backup_logic(master_data, sys_config.get("backup_sheet_url", ""), current_month_str)
            
            if success:
                st.success(msg)
            else:
                st.error(msg)
        else:
            st.warning("No data to backup.")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TAB 4: INFO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with tab4:
    st.header("â„¹ï¸ System Information")
    
    st.subheader("ğŸ“‹ Changelog")
    st.markdown("""
    ### Version 2.1 - PDF & Print Quality Enhancement
    
    **CRITICAL UPDATES:**
    
    #### Change #1: Enhanced PDF Conversion
    - Improved PDF rendering quality
    - Added print-optimized CSS
    - Implemented color preservation
    - Single-page A4 fitting guaranteed
    
    #### Change #2: Redesigned Invoice HTML
    - Compact professional layout
    - Optimized margins (0.5cm all sides)
    - Reduced logo size (40px)
    - Tight typography
    - Print-friendly structure
    - Colors exactly match preview
    
    #### Change #3: Enhanced Download & Print
    - Download uses consistent filename format
    - Format: `IN-{invoice_no}-{customer_name}.pdf`
    - Print button with optimized settings
    - Error handling for PDF generation
    
    #### Results:
    âœ… Download quality now equals print quality
    âœ… Single page guaranteed for all invoices
    âœ… Professional appearance
    âœ… Consistent filename format
    âœ… Color preservation in all formats
    """)
    
    st.subheader("ğŸ”§ Technical Details")
    col1, col2 = st.columns(2)
    with col1:
        st.metric("Current Month", current_month_str)
    with col2:
        st.metric("Total Records", len(df_master) if df_master is not None else 0)
    
    st.write("**Features:**")
    st.write("""
    - âœ… High-quality PDF generation
    - âœ… Print-optimized layouts
    - âœ… Single-page invoices
    - âœ… Professional branding
    - âœ… Google Sheets integration
    - âœ… Data backup functionality
    """)
