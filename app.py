import streamlit as st
import pandas as pd
import base64
import os
import datetime
import requests
import math 
import re 
import json
from io import BytesIO
from PIL import Image, ImageFile
import streamlit.components.v1 as components
from xhtml2pdf import pisa 
import gspread
from google.oauth2.service_account import Credentials
import numpy as np

# --- CRITICAL FIX FOR BROKEN IMAGES ---
ImageFile.LOAD_TRUNCATED_IMAGES = True

# ==========================================
# 1. SETUP & CONFIGURATION
# ==========================================
st.set_page_config(page_title="Vesak Care Invoice", layout="wide", page_icon="üè•")

LOGO_FILE = "logo.png"
URL_CONFIG_FILE = "url_config.txt"
SYSTEM_CONFIG_FILE = "system_config.json" 

# --- HEADERS (34 COLUMNS) ---
SHEET_HEADERS = [
    "UID", "Serial No.", "Ref. No.", "Invoice Number", "Date", "Generated At",
    "Customer Name", "Age", "Gender", "Location", "Address", "Mobile",
    "Plan", "Shift", "Recurring Service", "Period", "Visits", "Amount",
    "Notes / Remarks", "Generated By", "Amount Paid", "Details",
    "Service Started", "Service Ended", "Referral Code", "Referral Name",
    "Referral Credit", "Net Amount", "Nurse Payment", "Paid for", "Earnings",
    "Nurse Name", "Nurse Name (Extra)", "Nurse Note" 
]

# --- SESSION STATE INITIALIZATION ---
if 'chk_overwrite' not in st.session_state: st.session_state.chk_overwrite = False

# --- CONFIGURATION LOADER ---
def load_system_config():
    default_config = {
        "master_sheet_url": "",
        "backup_sheet_url": ""
    }
    if os.path.exists(SYSTEM_CONFIG_FILE):
        try:
            with open(SYSTEM_CONFIG_FILE, "r") as f:
                return json.load(f)
        except: return default_config
    return default_config

def save_system_config(config_data):
    with open(SYSTEM_CONFIG_FILE, "w") as f:
        json.dump(config_data, f)

def load_config_path(file_name):
    if os.path.exists(file_name):
        with open(file_name, "r") as f: return f.read().strip()
    return ""

def save_config_path(path, file_name):
    with open(file_name, "w") as f: f.write(path.replace('"', '').strip())
    return path

def extract_id_from_url(url):
    if not url: return ""
    match = re.search(r"/d/([a-zA-Z0-9-_]+)", url)
    if match: return match.group(1)
    if len(url) > 20 and "/" not in url: return url
    return ""

sys_config = load_system_config()

# --- GOOGLE AUTHENTICATION ---
@st.cache_resource
def get_credentials():
    scopes = ["https://www.googleapis.com/auth/spreadsheets", "https://www.googleapis.com/auth/drive"]
    if "connections" in st.secrets and "gsheets" in st.secrets["connections"]:
        s_info = st.secrets["connections"]["gsheets"]
        private_key = s_info.get("private_key").replace("\\n", "\n")
        creds_dict = {
            "type": s_info.get("type"),
            "project_id": s_info.get("project_id"),
            "private_key_id": s_info.get("private_key_id"),
            "private_key": private_key,
            "client_email": s_info.get("client_email"),
            "client_id": s_info.get("client_id"),
            "auth_uri": s_info.get("auth_uri"),
            "token_uri": s_info.get("token_uri"),
            "auth_provider_x509_cert_url": s_info.get("auth_provider_x509_cert_url"),
            "client_x509_cert_url": s_info.get("client_x509_cert_url"),
        }
        return Credentials.from_service_account_info(creds_dict, scopes=scopes)
    return None

def get_gspread_client():
    creds = get_credentials()
    if creds: return gspread.authorize(creds)
    return None

# ==========================================
# FILE HANDLING & HELPERS
# ==========================================
@st.cache_data(show_spinner=False)
def robust_file_downloader(url):
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        'Referer': 'https://www.google.com/'
    })
    download_url = url
    if "?" in url: base_url = url.split("?")[0]
    else: base_url = url
    if "1drv.ms" in url or "sharepoint" in url or "onedrive" in url:
        download_url = base_url + "?download=1"
    try:
        response = session.get(download_url, verify=False, allow_redirects=True)
        if response.status_code == 200:
            return BytesIO(response.content)
        raise Exception(f"Status Code: {response.status_code}")
    except Exception as e: return None

def format_date_with_suffix(d):
    if pd.isna(d): return "N/A"
    try:
        if isinstance(d, datetime.datetime): d = d.date()
        day = d.day
        suffix = {1: "st", 2: "nd", 3: "rd"}.get(day % 10, "th") if not 10 < day < 14 else "th"
        return d.strftime(f"%b. {day}{suffix} %Y")
    except: return str(d)

def clean_text(text): return str(text).strip() if isinstance(text, str) else str(text)

# --- CRITICAL FIX 1: ID NORMALIZATION (NO DECIMALS) ---
def normalize_id(val):
    """
    Converts inputs like 1.0, "1.0", 1 to "1"
    Also used for Mobile Numbers to ensure "9876543210.0" becomes "9876543210"
    """
    if pd.isna(val) or str(val).strip() == "" or str(val).strip().lower() == "nan": return ""
    try:
        # First convert to float to handle "1.0" string or 1.0 float
        f_val = float(val)
        # Convert to int to drop decimal, then string
        return str(int(f_val))
    except:
        return str(val).strip()

def generate_filename(doc_type, invoice_no, customer_name):
    prefix = {"Invoice": "IN", "Nurse": "NU", "Patient": "PA"}.get(doc_type, "DOC")
    clean_name = re.sub(r'[^a-zA-Z0-9]', '-', str(customer_name)).upper().strip('-')
    return f"{prefix}-{invoice_no}-{clean_name}.pdf"

# --- HELPER FUNCTIONS FOR LISTS ---
def get_base_lists(selected_plan, selected_sub_service):
    SERVICES_MASTER = {
        "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
        "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
        "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
        "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
        "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
        "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
        "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
    }
    STANDARD_PLANS = list(SERVICES_MASTER.keys())[:5]
    
    master_list = SERVICES_MASTER.get(selected_plan, [])
    if "All" in str(selected_sub_service) and selected_plan in STANDARD_PLANS:
        included_raw = [s for s in master_list if s.lower() != "all"]
    else: included_raw = [x.strip() for x in str(selected_sub_service).split(',')]
    included_clean = sorted(list(set([clean_text(s) for s in included_raw if clean_text(s)])))
    not_included_clean = []
    if selected_plan in STANDARD_PLANS:
        for plan_name in STANDARD_PLANS:
            if plan_name == selected_plan: continue 
            for item in SERVICES_MASTER.get(plan_name, []):
                if item.lower() == "all": continue
                cleaned = clean_text(item)
                if cleaned: not_included_clean.append(cleaned)
    else:
        for item in master_list:
            cleaned = clean_text(item)
            if cleaned and cleaned not in included_clean: not_included_clean.append(cleaned)
    return included_clean, list(set(not_included_clean))

def convert_html_to_pdf(source_html):
    result = BytesIO()
    pisa_status = pisa.CreatePDF(source_html, dest=result)
    if pisa_status.err: return None
    return result.getvalue()

def normalize_columns(df, aliases):
    df.columns = df.columns.astype(str).str.strip()
    for standard_name, possible_aliases in aliases.items():
        if standard_name in df.columns: continue 
        for alias in possible_aliases:
            for df_col in df.columns:
                if df_col.lower() == alias.lower():
                    df.rename(columns={df_col: standard_name}, inplace=True); break 
    return df

COLUMN_ALIASES = {
    'Serial No.': ['Serial No.', 'serial no', 'sr no', 'sr. no.', 'id'],
    'Ref. No.': ['Ref. No.', 'ref no', 'ref. no.', 'reference no', 'reference number'],
    'Name': ['Name', 'name', 'patient name', 'client name'],
    'Mobile': ['Mobile', 'mobile', 'phone', 'contact'],
    'Location': ['Location', 'location', 'city'], 
    'Address': ['Address', 'address', 'residence'],
    'Gender': ['Gender', 'gender', 'sex'],
    'Age': ['Age', 'age'],
    'Service Required': ['Service Required', 'service required', 'plan'],
    'Sub Service': ['Sub Service', 'sub service', 'sub plan'],
    'Final Rate': ['Final Rate', 'final rate', 'amount', 'total amount'],
    'Unit Rate': ['Rate Agreed (‚Çπ)', 'rate agreed', 'unit rate', 'per day rate'],
    'Call Date': ['Call Date', 'call date'],
    'Notes': ['Notes / Remarks', 'notes', 'remark'],
    'Shift': ['Shift', 'shift'],
    'Recurring Service': ['Recurring Service', 'recurring', 'recurring service'],
    'Period': ['Period', 'period'],
    'Visits': ['Visits', 'visits', 'visit', 'vists'],
    'Referral Code': ['Referral Code', 'referral code', 'ref code'],
    'Referral Name': ['Referral Name', 'referral name', 'ref name'],
    'Referral Credit': ['Referral Credit', 'referral credit', 'ref credit']
}

# --- DATABASE HELPERS ---
def save_invoice_to_gsheet(data_dict, sheet_obj):
    if sheet_obj is None: return False
    try:
        all_vals = sheet_obj.get_all_values()
        next_row_num = len(all_vals) + 1
        
        existing_uids = []
        for r in all_vals[1:]: 
             if r[0] and r[0].isdigit(): existing_uids.append(int(r[0]))
        
        if existing_uids: new_uid = max(existing_uids) + 1
        else: new_uid = 1
        final_uid = f"{new_uid:04d}"

        formula_net_amount = f"=U{next_row_num}-AA{next_row_num}"
        formula_earnings = f"=AB{next_row_num}-(AC{next_row_num}*AD{next_row_num})"
        
        details_txt = data_dict.get("Details", "")
        qty_extracted = 1
        match = re.search(r'Paid for (\d+)', details_txt)
        if match: qty_extracted = int(match.group(1))

        row_values = [
            final_uid,                              # A
            data_dict.get("Serial No.", ""),        # B
            data_dict.get("Ref. No.", ""),          # C
            data_dict.get("Invoice Number", ""),    # D
            data_dict.get("Date", ""),              # E
            data_dict.get("Generated At", ""),      # F
            data_dict.get("Customer Name", ""),     # G
            data_dict.get("Age", ""),               # H
            data_dict.get("Gender", ""),            # I
            data_dict.get("Location", ""),          # J
            data_dict.get("Address", ""),           # K
            data_dict.get("Mobile", ""),            # L
            data_dict.get("Plan", ""),              # M
            data_dict.get("Shift", ""),             # N
            data_dict.get("Recurring Service", ""), # O
            data_dict.get("Period", ""),            # P
            data_dict.get("Visits", ""),            # Q
            data_dict.get("Amount", ""),            # R
            data_dict.get("Notes / Remarks", ""),   # S
            data_dict.get("Generated By", ""),      # T
            data_dict.get("Amount Paid", ""),       # U
            data_dict.get("Details", ""),           # V
            data_dict.get("Service Started", ""),   # W
            data_dict.get("Service Ended", ""),     # X
            data_dict.get("Referral Code", ""),     # Y
            data_dict.get("Referral Name", ""),     # Z
            data_dict.get("Referral Credit", ""),   # AA
            formula_net_amount,                     # AB
            "",                                     # AC
            qty_extracted,                          # AD
            formula_earnings,                       # AE
            "",                                     # AF
            "",                                     # AG
            ""                                      # AH
        ]
        sheet_obj.append_row(row_values, value_input_option='USER_ENTERED')
        return True
    except Exception as e: st.error(f"Save Error: {e}"); return False

def update_invoice_in_gsheet(data_dict, sheet_obj, row_idx):
    """
    Overwrites specific row index based on Critical Point 2e.
    """
    if sheet_obj is None: return False
    try:
        # Update columns A through X (Indices 0 to 23 in data, 1-24 in Sheet)
        # We assume UID (A) stays same, but update the rest
        row_values = [
            data_dict.get("UID", ""), data_dict.get("Serial No.", ""), data_dict.get("Ref. No.", ""),
            data_dict.get("Invoice Number", ""), data_dict.get("Date", ""), data_dict.get("Generated At", ""),
            data_dict.get("Customer Name", ""), data_dict.get("Age", ""), data_dict.get("Gender", ""),
            data_dict.get("Location", ""), data_dict.get("Address", ""), data_dict.get("Mobile", ""),
            data_dict.get("Plan", ""), data_dict.get("Shift", ""), data_dict.get("Recurring Service", ""),
            data_dict.get("Period", ""), data_dict.get("Visits", ""), data_dict.get("Amount", ""),
            data_dict.get("Notes / Remarks", ""), data_dict.get("Generated By", ""), data_dict.get("Amount Paid", ""),
            data_dict.get("Details", ""), data_dict.get("Service Started", ""), data_dict.get("Service Ended", "")
        ]
        range_name = f"A{row_idx}:X{row_idx}"
        sheet_obj.update(range_name, [row_values], value_input_option='USER_ENTERED')
        return True
    except Exception as e: st.error(f"Update Error: {e}"); return False

def update_nurse_management(sheet_obj, invoice_number, payment_amount, nurse_name, nurse_extra, nurse_note):
    if sheet_obj is None: return False, None
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4) 
        if cell:
            row_idx = cell.row
            details_val = sheet_obj.cell(row_idx, 22).value
            qty = 1
            if details_val:
                match = re.search(r'Paid for\s*:?\s*(\d+)', str(details_val), re.IGNORECASE)
                if match: qty = int(match.group(1))
            
            formula_string = f"=AB{row_idx}-(AC{row_idx}*AD{row_idx})"
            range_update = f"AC{row_idx}:AH{row_idx}"
            values = [[payment_amount, qty, formula_string, nurse_name, nurse_extra, nurse_note]]
            sheet_obj.update(range_update, values, value_input_option='USER_ENTERED')
            return True, formula_string
        return False, None
    except Exception as e: st.error(f"Nurse Update Error: {e}"); return False, None

def mark_service_ended(sheet_obj, invoice_number, end_date):
    if sheet_obj is None: return False, "No Sheet"
    try:
        cell = sheet_obj.find(str(invoice_number).strip(), in_column=4)
        if cell:
            end_time = end_date.strftime("%d-%m-%Y %H:%M:%S")
            range_name = f"X{cell.row}"
            sheet_obj.update(range_name, [[end_time]])
            return True, end_time
        return False, "Invoice not found"
    except Exception as e: return False, str(e)

def get_clean_image_base64(file_path):
    if not os.path.exists(file_path): return None
    try:
        img = Image.open(file_path).convert("RGBA")
        buffer = BytesIO()
        img.save(buffer, format="PNG", optimize=True)
        return base64.b64encode(buffer.getvalue()).decode('utf-8')
    except: return None

def get_absolute_path(filename):
    if os.path.exists(filename): return os.path.abspath(filename).replace('\\', '/')
    return None

# ==========================================
# BACKUP LOGIC
# ==========================================
def perform_backup_logic(master_data, backup_url, target_month_str):
    client = get_gspread_client()
    backup_id = extract_id_from_url(backup_url)
    if not backup_id or not client: return False, "Invalid Backup Configuration."
    try:
        backup_wb = client.open_by_key(backup_id)
        try:
            target_ws = backup_wb.worksheet(target_month_str)
            return False, f"Backup for {target_month_str} already exists. Skipping to prevent overwrite."
        except gspread.exceptions.WorksheetNotFound: pass 

        try:
            default_ws = backup_wb.worksheet("Sheet1")
            default_ws.update_title(target_month_str)
            target_ws = default_ws
        except gspread.exceptions.WorksheetNotFound:
            target_ws = backup_wb.add_worksheet(title=target_month_str, rows=1000, cols=34)

        target_ws.clear()
        target_ws.update(range_name="A1", values=master_data, value_input_option='USER_ENTERED')
        try: target_ws.format("A1:AH1", {"textFormat": {"bold": True}, "backgroundColor": {"red": 0.8, "green": 0.8, "blue": 0.8}})
        except: pass
        return True, f"‚úÖ Success! Data backed up to sheet '{target_month_str}' in Backup Workbook."
    except Exception as e: return False, f"Backup Failed: {str(e)}"

# ==========================================
# UI & MAIN LOGIC
# ==========================================
st.title("üè• Vesak Care - Invoice Generator")

abs_logo_path = get_absolute_path(LOGO_FILE)
logo_b64 = get_clean_image_base64(LOGO_FILE)

# --- SIDEBAR CONFIGURATION ---
with st.sidebar:
    with st.expander("‚öôÔ∏è System Configuration", expanded=True):
        st.write("Enter Google Sheet Links:")
        m_link = st.text_input("Master Workbook Link (Active):", value=sys_config.get("master_sheet_url", ""))
        b_link = st.text_input("Backup Workbook Link (Archive):", value=sys_config.get("backup_sheet_url", ""))
        
        if st.button("üíæ Save Settings"):
            new_conf = { "master_sheet_url": m_link, "backup_sheet_url": b_link }
            save_system_config(new_conf)
            st.success("Settings Saved!")
            st.rerun()

    st.header("üóÑÔ∏è Backup Manager")
    backup_date = datetime.date.today()
    backup_month_str = backup_date.strftime("%b-%y") 
    st.info(f"Current Period: **{backup_month_str}**")
    
    if st.button("üöÄ Run Monthly Backup Now"):
        if not sys_config["master_sheet_url"] or not sys_config["backup_sheet_url"]:
            st.error("Please configure Master and Backup links first.")
        else:
            client = get_gspread_client()
            master_id = extract_id_from_url(sys_config["master_sheet_url"])
            try:
                wb_master = client.open_by_key(master_id)
                ws_master = wb_master.worksheet(backup_month_str) 
                data_to_copy = ws_master.get_all_values()
                if not data_to_copy: st.warning("Master sheet is empty.")
                else:
                    status, msg = perform_backup_logic(data_to_copy, sys_config["backup_sheet_url"], backup_month_str)
                    if status: st.success(msg)
                    else: st.warning(msg)
            except Exception as e: st.error(f"Could not read Master Workbook: {e}")

    st.markdown("---")
    st.subheader("üñ®Ô∏è PDF Settings")
    pdf_top_margin = st.slider("Adjust Top Margin (px):", min_value=0, max_value=200, value=20, step=5)
    
    data_source = st.radio("Load Customer Data via:", ["Upload File", "OneDrive Link"])
    if st.button("üîÑ Refresh"): st.cache_data.clear(); st.rerun()

# --- LOAD INPUT FILE ---
raw_file_obj = None
if data_source == "Upload File":
    uploaded_file = st.sidebar.file_uploader("Upload Excel/CSV", type=['xlsx', 'csv'])
    if uploaded_file: raw_file_obj = uploaded_file
elif data_source == "OneDrive Link":
    current_url = load_config_path(URL_CONFIG_FILE)
    url_input = st.sidebar.text_input("Paste Link:", value=current_url)
    if st.sidebar.button("Load"): save_config_path(url_input, URL_CONFIG_FILE); st.rerun()
    if current_url: raw_file_obj = robust_file_downloader(current_url)

# --- MAIN TABS ---
tab1, tab2, tab3, tab4, tab5 = st.tabs(["üßæ Generate Invoice", "üÜï Force New Invoice", "¬©Ô∏è Duplicate Invoice", "üõ† Manage Services", "üí∞ Nurse Manage"])

# ==========================================
# CORE INVOICE FUNCTION
# ==========================================
def render_invoice_ui(df_main, mode="standard"):
    chk_overwrite = False
    conflict_exists = False
    existing_row_idx = None
    
    # 1. Connect to Master Sheet
    client = get_gspread_client()
    master_id = extract_id_from_url(sys_config.get("master_sheet_url"))

    if not master_id or not client:
        st.error("‚ùå Master Workbook not linked in Sidebar Settings."); return

    c1, c2 = st.columns(2)
    with c1: global_inv_date = st.date_input("Invoice Date:", value=datetime.date.today(), key=f"date_{mode}")
    
    mmm_yy = global_inv_date.strftime("%b-%y") 
    
    try:
        wb = client.open_by_key(master_id)
        try: sheet_obj = wb.worksheet(mmm_yy)
        except:
            sheet_obj = wb.add_worksheet(title=mmm_yy, rows=1000, cols=34)
            sheet_obj.append_row(SHEET_HEADERS)
    except Exception as e: st.error(f"Connection Error: {e}"); return

    # Load History (Master Sheet Data)
    master_records = sheet_obj.get_all_records()
    df_history = pd.DataFrame(master_records)

    df_main['Ref_Clean'] = df_main['Ref. No.'].astype(str).str.strip()
    valid_refs = df_main['Ref_Clean'].unique()
    
    # Filter for standard mode if needed...
    
    df_view = df_main[df_main['Ref_Clean'].isin(valid_refs)]
    df_view['Label'] = df_view['Name'].astype(str) + " (" + df_view['Mobile'].astype(str) + ")"
    
    selected_label = st.selectbox(f"Select Customer ({mode}):", [""] + list(df_view['Label'].unique()), key=f"sel_{mode}")
    
    if not selected_label: return

    row = df_view[df_view['Label'] == selected_label].iloc[0]
    
    # --- CRITICAL FIX 1: NORMALIZE IDs (No Decimals in Ref, Serial, or Mobile) ---
    c_ref = normalize_id(row.get('Ref. No.', ''))
    c_serial = normalize_id(row.get('Serial No.', ''))
    c_mob = normalize_id(row.get('Mobile', '')) # Apply fix to Mobile here
    
    c_name = row.get('Name', '')
    
    c_plan = row.get('Service Required', '')
    c_age = str(row.get('Age', ''))
    c_gender = str(row.get('Gender', ''))
    c_loc = str(row.get('Location', ''))
    c_addr = str(row.get('Address', ''))
    c_shift = str(row.get('Shift', ''))
    c_rec = str(row.get('Recurring Service', ''))
    c_period = str(row.get('Period', ''))
    c_visits = str(row.get('Visits', ''))
    
    c_ref_code = str(row.get('Referral Code', ''))
    c_ref_name = str(row.get('Referral Name', ''))
    c_ref_credit = str(row.get('Referral Credit', ''))

    # --- CRITICAL FIX 2: CHECK FOR EXISTING CUSTOMER IN MASTER SHEET ---
    # Logic: Match Ref No AND Serial No. If Match -> Check if Invoice No Exists.
    if not df_history.empty:
        # Normalize history columns for comparison
        df_history['Ref_Norm'] = df_history['Ref. No.'].apply(normalize_id)
        df_history['Ser_Norm'] = df_history['Serial No.'].apply(normalize_id)
        
        # Look for match
        match_mask = (df_history['Ref_Norm'] == c_ref) & (df_history['Ser_Norm'] == c_serial)
        existing_matches = df_history[match_mask]
        
        if not existing_matches.empty:
            # Check if Invoice Number column has data
            last_match = existing_matches.iloc[-1]
            if str(last_match.get('Invoice Number', '')).strip() != "":
                conflict_exists = True
                # Get the actual row index in Google Sheet (DataFrame index + 2 for 0-base + header)
                # But safer to use the index from get_all_records() if preserved, or recalculate
                # We will find the exact row in the sheet to handle the update
                try:
                    # Find cell by Invoice Number since it's unique
                    cell_match = sheet_obj.find(str(last_match['Invoice Number']), in_column=4)
                    if cell_match:
                        existing_row_idx = cell_match.row
                        inv_final = str(last_match['Invoice Number'])
                except: pass

    st.divider()
    col1, col2 = st.columns(2)
    
    with col1:
        st.write(f"**Plan:** {c_plan} | **Ref:** {c_ref} | **Serial:** {c_serial}")
        
        if not conflict_exists:
            loc_code = "MUM" if "mumbai" in str(row.get('Location', '')).lower() else "PUN"
            date_part = global_inv_date.strftime('%y%m%d')
            prefix = f"{loc_code}-{date_part}-"
            
            next_seq = 1
            if not df_history.empty and 'Invoice Number' in df_history.columns:
                 todays_invs = df_history[df_history['Invoice Number'].astype(str).str.startswith(prefix)]
                 if not todays_invs.empty:
                     seqs = [int(x.split('-')[-1]) for x in todays_invs['Invoice Number'] if '-' in x]
                     if seqs: next_seq = max(seqs) + 1
            
            inv_final = f"{prefix}{next_seq:03d}"
            st.info(f"‚ÑπÔ∏è New Invoice: {inv_final}")
        else:
            st.warning(f"‚ö†Ô∏è Active Invoice Found: {inv_final}")
            st.info("To modify this invoice, check 'Overwrite' below.")
            
        inv_input = st.text_input("Invoice Number", value=inv_final, disabled=True)

    with col2:
        billing_qty = st.number_input("Paid Units:", min_value=1, value=1, key=f"qty_{mode}")
        
        # --- CRITICAL FIX: "nan" in Notes ---
        val_notes = row.get('Notes', '')
        if pd.isna(val_notes) or str(val_notes).strip().lower() == 'nan': notes_default = ""
        else: notes_default = str(val_notes)

        notes = st.text_area("Notes:", value=notes_default, key=f"note_{mode}")
        
        # Generated By Logic
        gen_by_input = st.text_input("Generated By:", value="", placeholder="Leave blank for Default", key=f"gen_{mode}")
        gen_by_to_save = gen_by_input if gen_by_input.strip() else "Vesak Patient Care"

    st.subheader("Services")
    inc_list, exc_list = get_base_lists(c_plan, row.get('Sub Service', 'All'))
    sc1, sc2 = st.columns(2)
    with sc1: st.text_area("Included", ", ".join(inc_list), disabled=True)
    
    with sc2: 
        exc_final = st.multiselect("Excluded (Click X to remove):", options=exc_list, default=exc_list, key=f"exc_{mode}_{c_ref}")
        exc_text_for_pdf = ", ".join(exc_final)

    b1, b2, b3 = st.columns(3)
    btn_save = False
    
    with b1:
        if conflict_exists:
            # Step 2d: Disable Create Invoice, Show Checkbox
            chk_overwrite = st.checkbox("Overwrite Invoice", key=f"ow_{mode}")
            if chk_overwrite:
                if st.button("Overwrite", type="primary", key=f"b_ov_{mode}"): btn_save = True
            else:
                st.button("Create Invoice", disabled=True, key=f"b_cr_dis_{mode}")
        else:
            if st.button("Create Invoice", type="primary", key=f"b_cr_{mode}"): btn_save = True
            
    with b2: btn_nurse = st.button("Nurse Agreement", key=f"b_nu_{mode}")
    with b3: btn_patient = st.button("Patient Agreement", key=f"b_pa_{mode}")

    if btn_save:
        rate = float(row.get('Unit Rate', 0))
        total = rate * billing_qty
        
        # --- CRITICAL FIX: Time Format (DD-MM-YYYY HR:MIN:SEC) ---
        formatted_now = datetime.datetime.now().strftime("%d-%m-%Y %H:%M:%S")

        record = {
            "UID": "", 
            "Serial No.": c_serial, # Normalized
            "Ref. No.": c_ref,      # Normalized
            "Invoice Number": inv_input, 
            "Date": format_date_with_suffix(global_inv_date),
            "Generated At": formatted_now, # Fixed format
            "Customer Name": c_name,
            "Age": c_age,
            "Gender": c_gender,
            "Location": c_loc,
            "Address": c_addr,
            "Mobile": c_mob, # Normalized (No Decimal)
            "Plan": c_plan,
            "Shift": c_shift,
            "Recurring Service": c_rec,
            "Period": c_period,
            "Visits": c_visits,
            "Amount": rate, 
            "Amount Paid": total, 
            "Notes / Remarks": notes, 
            "Generated By": gen_by_to_save, 
            "Service Started": formatted_now, # Fixed format
            "Service Ended": "",
            "Details": f"Paid for {billing_qty} units",
            "Referral Code": c_ref_code,
            "Referral Name": c_ref_name,
            "Referral Credit": c_ref_credit
        }
        
        if conflict_exists and chk_overwrite and existing_row_idx:
            # Overwrite specific row
            record["UID"] = df_history.iloc[existing_row_idx-2]["UID"] 
            
            # Re-fetch UID from sheet to be 100% sure we don't overwrite it with blank
            try:
                actual_uid = sheet_obj.cell(existing_row_idx, 1).value
                record["UID"] = actual_uid
            except: pass
            
            update_invoice_in_gsheet(record, sheet_obj, existing_row_idx)
            st.success(f"Overwritten Row {existing_row_idx}!")
        else:
            save_invoice_to_gsheet(record, sheet_obj)
            st.success("Created New Row!")
        st.balloons()

    if btn_save or btn_nurse or btn_patient:
        doc_type = "Invoice" if btn_save else ("Nurse" if btn_nurse else "Patient")
        display_type = "NURSE AGREEMENT" if btn_nurse else "PATIENT AGREEMENT"
        
        rate = float(row.get('Unit Rate', 0))
        total = rate * billing_qty
        
        if doc_type == "Invoice":
            html_content = f"""
            <!DOCTYPE html><html><head><style>
                @page {{ size: a4 portrait; margin: 1cm; }}
                body {{ font-family: 'Helvetica', sans-serif; }}
                .header {{ text-align: center; }}
                .service-box {{ margin-top: 10px; font-size: 12px; }}
            </style></head><body>
                <div class="header"><h2>INVOICE: {inv_input}</h2></div>
                <p><strong>Customer:</strong> {c_name}</p>
                <p><strong>Mobile:</strong> {c_mob}</p>
                <hr>
                <p><strong>Amount Paid:</strong> ‚Çπ{total}</p>
                <p><strong>Date:</strong> {format_date_with_suffix(global_inv_date)}</p>
                <br>
                <p><em>Notes: {notes}</em></p>
                <div class="service-box">
                    <strong>Services Not Included:</strong><br>{exc_text_for_pdf}
                </div>
            </body></html>
            """
        else:
             html_content = f"""
            <!DOCTYPE html><html><head><style>
                @page {{ size: a4 portrait; margin: 1cm; }}
                body {{ font-family: 'Helvetica', sans-serif; }}
                .header {{ text-align: center; }}
            </style></head><body>
                <div class="header">
                    <img src="data:image/png;base64,{logo_b64}" width="100">
                    <h2>Vesak Care Foundation</h2>
                </div>
                <h3>{display_type}</h3>
                <p><strong>Ref:</strong> {c_ref}</p>
                <p><strong>Date:</strong> {format_date_with_suffix(global_inv_date)}</p>
                <br><br><br>
                <p>Authorized Signatory</p>
            </body></html>
            """
        pdf_bytes = convert_html_to_pdf(html_content)
        if pdf_bytes:
            file_name = generate_filename(doc_type, inv_input, c_name)
            st.download_button(f"‚¨áÔ∏è Download {doc_type} PDF", data=pdf_bytes, file_name=file_name, mime="application/pdf")

if raw_file_obj:
    try:
        filename = getattr(raw_file_obj, "name", "data.xlsx")
        is_excel = filename.endswith('.xlsx')
        if is_excel: df = pd.read_excel(raw_file_obj, engine='openpyxl')
        else: df = pd.read_csv(raw_file_obj)
        
        df = normalize_columns(df, COLUMN_ALIASES)
        
        with tab1: render_invoice_ui(df, mode="standard")
        with tab2: render_invoice_ui(df, mode="force_new")
        
        with tab3:
            st.header("¬©Ô∏è Duplicate Invoice")
            client = get_gspread_client()
            mid = extract_id_from_url(sys_config.get("master_sheet_url"))
            dup_date = st.date_input("Select Month:", value=datetime.date.today())
            mmm_yy = dup_date.strftime("%b-%y")
            
            if client and mid:
                try:
                    wb = client.open_by_key(mid)
                    ws = wb.worksheet(mmm_yy)
                    df_hist = pd.DataFrame(ws.get_all_records())
                    if not df_hist.empty and 'Invoice Number' in df_hist.columns:
                        df_hist['Display'] = df_hist['Invoice Number'].astype(str) + " - " + df_hist['Customer Name']
                        sel_dup = st.selectbox("Select Invoice:", df_hist['Display'].unique())
                        if sel_dup:
                            row = df_hist[df_hist['Display'] == sel_dup].iloc[0]
                            st.info(f"Selected: {row['Customer Name']}")
                            if st.button("Generate Duplicate PDF"):
                                html_dup = f"""<!DOCTYPE html><html><body><h2>DUPLICATE INVOICE: {row['Invoice Number']}</h2><p>Customer: {row['Customer Name']}</p><p>Amount: {row['Amount Paid']}</p></body></html>"""
                                pdf_dup = convert_html_to_pdf(html_dup)
                                st.download_button("Download PDF", pdf_dup, file_name=f"Duplicate-{row['Invoice Number']}.pdf")
                    else: st.warning("No records found in this month.")
                except: st.error("Could not load history for this month.")

        with tab4:
            st.header("üõ† Manage Services")
            SERVICES_MASTER = {
                "Plan A: Patient Attendant Care": ["All", "Basic Care", "Assistance with Activities for Daily Living", "Feeding & Oral Hygiene", "Mobility Support & Transfers", "Bed Bath and Emptying Bedpans", "Catheter & Ostomy Care"],
                "Plan B: Skilled Nursing": ["All", "Intravenous (IV) Therapy & Injections", "Medication Management", "Advanced Wound Care", "Catheter & Ostomy Care", "Post-Surgical Care"],
                "Plan C: Chronic Management": ["All", "Care for Bed-Ridden Patients", "Dementia & Alzheimer's Care", "Disability Support"],
                "Plan D: Elderly Companion": ["All", "Companionship & Conversation", "Fall Prevention & Mobility", "Light Meal Preparation"],
                "Plan E: Maternal & Newborn": ["All", "Postnatal & Maternal Care", "Newborn Care Assistance"],
                "Plan F: Rehabilitative Care": ["Therapeutic Massage", "Exercise Therapy", "Geriatric Rehabilitation", "Neuro Rehabilitation", "Pain Management", "Post Op Rehab"],
                "A-la-carte Services": ["Hospital Visits", "Medical Equipment", "Medicines", "Diagnostic Services", "Nutrition Consultation", "Ambulance", "Doctor Visits", "X-Ray", "Blood Collection"]
            }
            ms_plan = st.selectbox("Select Plan to View:", list(SERVICES_MASTER.keys()))
            ms_sub = st.text_input("Simulate Sub-Services Input:", value="All")
            inc, exc = get_base_lists(ms_plan, ms_sub)
            c1, c2 = st.columns(2)
            with c1: 
                st.success(f"‚úÖ Included ({len(inc)})")
                for i in inc: st.write(f"- {i}")
            with c2: 
                st.error(f"‚ùå Excluded ({len(exc)})")
                for e in exc: st.write(f"- {e}")
        
        with tab5:
            st.header("Nurse Management")
            client = get_gspread_client()
            mid = extract_id_from_url(sys_config.get("master_sheet_url"))
            
            if client and mid:
                try:
                    wb = client.open_by_key(mid)
                    ws = wb.worksheet(datetime.date.today().strftime("%b-%y"))
                    st.write("Enter Invoice Number to manage nurse payments:")
                    inv_to_pay = st.text_input("Invoice No:")
                    st.divider()
                    col_n1, col_n2 = st.columns(2)
                    with col_n1:
                        amt = st.number_input("Nurse Payment Amount:", min_value=0.0)
                        nm = st.text_input("Nurse Name:")
                    with col_n2:
                        nm_extra = st.text_input("Nurse Name (Extra):")
                        nm_note = st.text_area("Nurse Note")
                    if st.button("Update Nurse Details (Overwrite)"):
                        success, form = update_nurse_management(ws, inv_to_pay, amt, nm, nm_extra, nm_note)
                        if success: st.success("‚úÖ Nurse details updated successfully in sheet!")
                        else: st.error("‚ùå Invoice not found in current month's sheet.")
                except Exception as e: st.error(f"Error accessing sheet: {e}")
            else:
                st.warning("Please configure Master Sheet URL in Sidebar.")

    except Exception as e: st.error(f"Error: {e}")
